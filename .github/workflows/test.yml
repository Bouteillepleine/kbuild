name: Build

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      ksu_type:
        description: 'KernelSU Type'
        required: true
        type: choice
        options:
          - KSUN
          - KSU
        default: KSUN
      ksu_branch:
        description: 'KSU branch/commit (empty = auto)'
        type: string
        default: ""
      susfs_branch:
        description: 'SUSFS branch/commit (empty = auto: gki-android16-6.12)'
        type: string
        default: ""
      optimize_level:
        description: 'Optimization level'
        type: choice
        options: [O2, O3]
        default: O2
      clean_build:
        description: 'Clean build (no ccache)'
        type: boolean
        default: false

jobs:
  build-op15:
    runs-on: ubuntu-latest
    env:
      # Device Configuration
      OP_MODEL: "OP15"
      OP_SOC: "canoe"
      OP_BRANCH: "wild/sm8850"
      OP_MANIFEST: "oneplus_15_w.xml"
      OP_ANDROID_VERSION: "android16"
      OP_KERNEL_VERSION: "6.12"
      OP_OS_VERSION: "OOS16"
      OP_LTO: "none"
      OP_RUST_BUILD: "true"
      OP_HMBIRD: "false"
      OP_SUSFS: "true"
      OP_BBG: "true"
      OP_BBR: "true"
      OP_TTL: "true"
      OP_IP_SET: "true"
      OP_UNAME: "5-g188c695beb6d-ab14367805-4k"

    steps:
      - name: ðŸ§¹ Free Disk Space
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Disk cleanup"
          df -h
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL || true
          sudo apt-get clean || true
          if command -v docker >/dev/null 2>&1; then
            docker rmi $(docker images -q) 2>/dev/null || true
          fi
          df -h
          echo "::endgroup::"

      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ“¦ Install Dependencies
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Install dependencies"
          sudo apt-get update -qq
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            git curl ca-certificates build-essential clang lld flex bison \
            libelf-dev libssl-dev libncurses-dev zlib1g-dev liblz4-tool \
            libxml2-utils rsync unzip dwarves file python3 ccache jq bc dos2unix kmod libdw-dev elfutils
          sudo apt-get clean
          echo "âœ… Dependencies installed"
          echo "::endgroup::"

      - name: ðŸ¦€ Install Rust bindgen
        if: ${{ env.OP_RUST_BUILD == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Install Rust bindgen"
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain none
          source "$HOME/.cargo/env"
          cargo install bindgen-cli --version 0.69.5
          bindgen --version
          echo "âœ… Rust bindgen installed"
          echo "::endgroup::"

      - name: ðŸ”§ Setup Environment
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Setup environment"

          # repo tool
          REPO="/usr/local/bin/repo"
          if [ ! -x "$REPO" ]; then
            sudo curl -s https://storage.googleapis.com/git-repo-downloads/repo -o "$REPO"
            sudo chmod +x "$REPO"
          fi
          echo "REPO=$REPO" >> "$GITHUB_ENV"

          # Git optimization
          git config --global feature.manyFiles true
          git config --global core.fsmonitor true
          git config --global pack.sparse true

          # Build identity
          echo "BUILD_USER=OnePlus" >> "$GITHUB_ENV"
          echo "BUILD_HOST=ubuntu-build" >> "$GITHUB_ENV"

          echo "âœ… Environment configured"
          echo "::endgroup::"

      - name: ðŸ“¥ Sync Kernel Source
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Sync kernel source"
          mkdir -p OP15
          cd OP15

          echo "ðŸ”§ Initializing repo with custom manifest..."
          echo "   Repository: https://github.com/Bouteillepleine/OnePlus_KernelSU_SUSFS.git"
          echo "   Branch: main"
          echo "   Manifest: manifests/oos16/${OP_MANIFEST}"

          "$REPO" init \
            -u https://github.com/Bouteillepleine/OnePlus_KernelSU_SUSFS.git \
            -b main \
            -m "manifests/oos16/${OP_MANIFEST}" \
            --repo-rev=v2.16 \
            --depth=1 \
            --no-clone-bundle \
            --no-tags

          if [ ! -f .repo/manifest.xml ]; then
            echo "::error::Manifest file not found after repo init"
            ls -la .repo/ || true
            exit 1
          fi

          echo "âœ… Repo initialized"
          echo ""
          echo "ðŸ“‹ Manifest preview:"
          head -n 20 .repo/manifest.xml

          echo ""
          echo "ðŸ“¥ Syncing kernel source (this may take 10-20 minutes)..."
          success=false
          for i in 1 2 3; do
            echo ""
            echo "=== Sync Attempt $i/3 ==="
            if "$REPO" sync -c --no-clone-bundle --no-tags --optimized-fetch \
              -j"$(nproc --all)" --fail-fast; then
              success=true
              break
            fi
            echo "âš ï¸ Sync attempt $i failed, retrying in 30 seconds..."
            sleep 30
          done

          if [ "$success" = false ]; then
            echo "::error::Failed to sync kernel source after 3 attempts"
            exit 1
          fi

          if [ ! -d kernel_platform ]; then
            echo "::error::kernel_platform directory not found after sync"
            ls -la .
            exit 1
          fi

          echo ""
          echo "âœ… Kernel source synced successfully"
          echo "::endgroup::"

      - name: ðŸ” Detect Kernel Version
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Detect kernel version"
          cd OP15/kernel_platform/common

          if [ ! -f Makefile ]; then
            echo "::error::Makefile not found"
            exit 1
          fi

          VERSION=$(awk '/^VERSION *=/ {print $3}' Makefile)
          PATCHLEVEL=$(awk '/^PATCHLEVEL *=/ {print $3}' Makefile)
          SUBLEVEL=$(awk '/^SUBLEVEL *=/ {print $3}' Makefile)
          FULL_VERSION="$VERSION.$PATCHLEVEL.$SUBLEVEL"

          echo "KERNEL_FULL_VER=$OP_ANDROID_VERSION-$FULL_VERSION" >> "$GITHUB_ENV"
          echo "TKERNEL_VER=$FULL_VERSION" >> "$GITHUB_ENV"
          echo "SUSFS_KERNEL_BRANCH=gki-$OP_ANDROID_VERSION-$VERSION.$PATCHLEVEL" >> "$GITHUB_ENV"

          echo "âœ… Detected: $OP_ANDROID_VERSION-$FULL_VERSION"
          echo "   SUSFS branch: gki-$OP_ANDROID_VERSION-$VERSION.$PATCHLEVEL"
          echo "::endgroup::"

      - name: ðŸ” Detect Toolchain
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Detect toolchain"

          KP="$GITHUB_WORKSPACE/OP15/kernel_platform"

          # Find Clang
          echo "ðŸ” Looking for Clang..."
          CLANG_FOUND=false
          for base in "$KP/prebuilts" "$KP/prebuilts-master"; do
            [ -d "$base/clang/host/linux-x86" ] || continue
            latest=$(ls -d "$base"/clang/host/linux-x86/clang-r*/ 2>/dev/null | sort -V | tail -n1 || true)
            if [ -n "$latest" ] && [ -x "$latest/bin/clang" ]; then
              echo "CLANG_BIN_PATH=$latest/bin" >> "$GITHUB_ENV"
              CLANG_VER="$("$latest/bin/clang" --version | head -n1)"
              echo "CLANG_VERSION=$CLANG_VER" >> "$GITHUB_ENV"
              echo "âœ… Clang: $CLANG_VER"
              CLANG_FOUND=true
              break
            fi
          done

          if [ "$CLANG_FOUND" = false ]; then
            echo "::error::Clang toolchain not found"
            exit 1
          fi

          # Find Rust
          echo ""
          echo "ðŸ” Looking for Rust..."
          RUSTC_FOUND=false
          for base in "$KP/prebuilts" "$KP/prebuilts-master"; do
            [ -d "$base/rust/linux-x86/" ] || continue
            latest=$(ls -d "$base/rust/linux-x86/1."* 2>/dev/null | sort -V | head -n1 || true)
            if [ -n "$latest" ] && [ -x "$latest/bin/rustc" ]; then
              echo "RUSTC_BIN_PATH=$latest/bin" >> "$GITHUB_ENV"
              RUSTC_VER="$("$latest/bin/rustc" --version)"
              echo "RUSTC_VERSION=$RUSTC_VER" >> "$GITHUB_ENV"
              echo "âœ… Rust: $RUSTC_VER"
              RUSTC_FOUND=true
              break
            fi
          done

          if [ "$RUSTC_FOUND" = false ]; then
            echo "âš ï¸ Rust toolchain not found"
          fi

          echo "::endgroup::"

      - name: â™»ï¸ Setup ccache
        if: ${{ inputs.clean_build != true }}
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-op15-v2-${{ env.KERNEL_FULL_VER }}-${{ hashFiles('OP15/kernel_platform/common/Makefile') }}
          restore-keys: |
            ccache-op15-v2-${{ env.KERNEL_FULL_VER }}-
            ccache-op15-v2-

      - name: ðŸ”§ Configure ccache
        if: ${{ inputs.clean_build != true }}
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Configure ccache"
          export CCACHE_DIR="$HOME/.ccache"
          mkdir -p "$CCACHE_DIR"
          ccache -M 1G
          ccache -o compression=true
          ccache -o compression_level=3
          ccache -o direct_mode=true
          ccache -o file_clone=true
          ccache -o inode_cache=true
          echo "ðŸ“Š ccache status:"
          ccache -s
          echo "::endgroup::"

      - name: ðŸ“¦ Clone Dependencies
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Clone dependencies"
          cd "$GITHUB_WORKSPACE"

          echo "ðŸ“¥ Cloning AnyKernel3..."
          git clone --depth=1 https://github.com/TheWildJames/AnyKernel3.git -b gki-2.0

          echo "ðŸ“¥ Cloning kernel_patches (Bouteillepleine)..."
          git clone --depth=1 https://github.com/Bouteillepleine/kernel_patches.git

          if [ "${OP_SUSFS}" = "true" ]; then
            echo "ðŸ“¥ Cloning susfs4ksu..."
            git clone https://gitlab.com/simonpunk/susfs4ksu.git
            cd susfs4ksu

            SUSFS_BRANCH_INPUT="${{ inputs.susfs_branch }}"
            if [ -z "$SUSFS_BRANCH_INPUT" ]; then
              SUSFS_BRANCH_INPUT="${SUSFS_KERNEL_BRANCH}"
            fi

            echo "ðŸ” Checking out SUSFS: $SUSFS_BRANCH_INPUT"
            if git rev-parse --verify "origin/$SUSFS_BRANCH_INPUT" >/dev/null 2>&1; then
              git checkout "$SUSFS_BRANCH_INPUT"
            elif git rev-parse --verify "$SUSFS_BRANCH_INPUT" >/dev/null 2>&1; then
              git checkout "$SUSFS_BRANCH_INPUT"
            else
              echo "::error::SUSFS branch '$SUSFS_BRANCH_INPUT' not found"
              git branch -r | head -n 20
              exit 1
            fi

            SUSFS_SHA=$(git rev-parse HEAD)
            SUSFS_BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "detached")

            echo "SUSFS_COMMIT_SHA=$SUSFS_SHA" >> "$GITHUB_ENV"
            echo "SUSFS_BRANCH_NAME=$SUSFS_BRANCH_NAME" >> "$GITHUB_ENV"

            echo "âœ… SUSFS: $SUSFS_BRANCH_NAME ($SUSFS_SHA)"
          fi

          echo "::endgroup::"

      - name: ðŸ§¹ Clean ABI Exports
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Clean ABI exports"
          cd "$GITHUB_WORKSPACE/OP15/kernel_platform"
          rm -f common/android/abi_gki_protected_exports_* || true
          rm -f msm-kernel/android/abi_gki_protected_exports_* || true
          sed -i 's/protected_modules = \[.*\]/protected_modules = []/' common/modules.bzl || true
          echo "âœ… ABI exports cleaned"
          echo "::endgroup::"

      - name: âž• Add KernelSU / KernelSU Next
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Add KernelSU"
          cd "$GITHUB_WORKSPACE/OP15/kernel_platform"

          KSU_BRANCH_INPUT="${{ inputs.ksu_branch }}"

          if [ "${{ inputs.ksu_type }}" = "KSUN" ]; then
            echo "ðŸ“¥ Installing KernelSU Next..."
            if [ -z "$KSU_BRANCH_INPUT" ]; then
              curl -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh" | bash -
            else
              curl -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh" | bash -s "$KSU_BRANCH_INPUT"
            fi
            git submodule update --init --recursive
            cd KernelSU-Next/kernel
          else
            echo "ðŸ“¥ Installing KernelSU..."
            if [ -z "$KSU_BRANCH_INPUT" ]; then
              curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -
            else
              curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s "$KSU_BRANCH_INPUT"
            fi
            git submodule update --init --recursive
            cd KernelSU/kernel
          fi

          COMMITS=$(/usr/bin/git rev-list --count HEAD)

          if [ "${{ inputs.ksu_type }}" = "KSUN" ]; then
            if [ "$COMMITS" -lt 2684 ]; then BASE_VER=10200; else BASE_VER=30000; fi
            KSU_VER=$((COMMITS + BASE_VER))
            sed -i "s/DKSU_VERSION=11998/DKSU_VERSION=${KSU_VER}/" Makefile
          else
            BASE_VER=20000
            KSU_VER=$((COMMITS + BASE_VER))
            sed -i "s/DKSU_VERSION=16/DKSU_VERSION=${KSU_VER}/" Makefile
          fi

          cd ..
          KSU_SHA=$(git rev-parse HEAD)

          echo "KSUVER=$KSU_VER" >> "$GITHUB_ENV"
          echo "KSU_COMMIT_SHA=$KSU_SHA" >> "$GITHUB_ENV"

          echo "âœ… ${{ inputs.ksu_type }} v$KSU_VER ($KSU_SHA)"
          echo "::endgroup::"

      - name: ðŸ”§ Apply SUSFS Patches + Fixes (v2.0.0)
        if: ${{ env.OP_SUSFS == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Apply SUSFS patches"
          cd "$GITHUB_WORKSPACE/OP15/kernel_platform"

          echo "ðŸ“‹ Copying SUSFS files..."
          cp "$GITHUB_WORKSPACE/susfs4ksu/kernel_patches/50_add_susfs_in_${SUSFS_KERNEL_BRANCH}.patch" ./common/
          cp "$GITHUB_WORKSPACE/susfs4ksu/kernel_patches/fs/"* ./common/fs/
          cp "$GITHUB_WORKSPACE/susfs4ksu/kernel_patches/include/linux/"* ./common/include/linux/

          SUSFS_VER=$(grep '#define SUSFS_VERSION' ./common/include/linux/susfs.h | awk -F'"' '{print $2}')
          [[ "$SUSFS_VER" != v* ]] && SUSFS_VER="v$SUSFS_VER"
          echo "SUSVER=$SUSFS_VER" >> "$GITHUB_ENV"
          echo "ðŸ“Œ SUSFS: $SUSFS_VER"

          if [ "${{ inputs.ksu_type }}" = "KSUN" ]; then
            cd KernelSU-Next
          else
            cd KernelSU
          fi

          echo "ðŸ”§ Applying KSU integration patch..."
          cp "$GITHUB_WORKSPACE/susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch" ./
          patch -p1 --forward --fuzz=3 < 10_enable_susfs_for_ksu.patch || true

          if [ "$SUSFS_VER" = "v2.0.0" ]; then
            FIX_DIR="$GITHUB_WORKSPACE/kernel_patches/ksu/susfs_fix_patches/$SUSFS_VER"
            echo "ðŸ”§ Applying SUSFS v2.0.0 fix patches from: $FIX_DIR"

            if [ ! -d "$FIX_DIR" ]; then
              echo "::error::Fix directory not found: $FIX_DIR"
              exit 1
            fi

            PATCHES=(
              "1_fix_base.c.patch"
              "2_fix_base.c.patch"
              "fix_core_hook.c.patch"
              "fix_fdinfo.c.patch"
              "fix_kernel_compat.c.patch"
              "fix_namespace.c.patch"
              "fix_open.c.patch"
              "fix_sucompat.c.patch"
              "fix_task_mmu.c.patch"
            )

            for p in "${PATCHES[@]}"; do
              f="$FIX_DIR/$p"
              if [ -f "$f" ]; then
                echo "   âœ“ Applying: $p"
                patch -p1 --forward --fuzz=3 < "$f"
              else
                echo "::error::Missing fix patch: $f"
                exit 1
              fi
            done
          fi

          cd ../common
          echo "ðŸ”§ Applying SUSFS kernel patch..."
          patch -p1 < "50_add_susfs_in_${SUSFS_KERNEL_BRANCH}.patch"

          echo "âœ… SUSFS $SUSFS_VER applied successfully"
          echo "::endgroup::"

      - name: ðŸ”§ Apply Additional Patches
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Apply additional patches"
          cd "$GITHUB_WORKSPACE/OP15/kernel_platform/common"

          echo "ðŸš€ Performance patches..."
          patch -p1 --forward < "$GITHUB_WORKSPACE/kernel_patches/common/optimized_mem_operations.patch"
          patch -p1 --forward < "$GITHUB_WORKSPACE/kernel_patches/common/file_struct_8bytes_align.patch"
          patch -p1 --forward < "$GITHUB_WORKSPACE/kernel_patches/common/reduce_cache_pressure.patch"

          echo "ðŸ”¤ Unicode bypass fix..."
          patch -p1 --forward < "$GITHUB_WORKSPACE/kernel_patches/common/unicode_bypass_fix_6.1+.patch"

          echo "ðŸ“„ Clear page optimization..."
          cat "$GITHUB_WORKSPACE/kernel_patches/common/clear_page_16bytes_align.patch" \
            | sed -e 's/SYM_FUNC_START_PI(clear_page)/SYM_FUNC_START_PI(__pi_clear_page)/' \
            | patch -p1 -F3 --forward

          echo "âœ… Additional patches applied"
          echo "::endgroup::"

      - name: âž• Add BBG LSM
        if: ${{ env.OP_BBG == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Add BBG LSM"
          cd "$GITHUB_WORKSPACE/OP15/kernel_platform"

          echo "ðŸ“¥ Installing Baseband Guard..."
          wget -O- https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh | bash -s fix_blkdev_rename || true

          echo "CONFIG_BBG=y" >> common/arch/arm64/configs/gki_defconfig
          sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/selinux/selinux,baseband_guard/ } }' common/security/Kconfig

          echo "âœ… BBG LSM added"
          echo "::endgroup::"

      - name: ðŸ”§ Configure Kernel
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Configure kernel"
          cd "$GITHUB_WORKSPACE/OP15/kernel_platform"
          DEF="common/arch/arm64/configs/gki_defconfig"

          cat >> "$DEF" <<'EOF'
          # KSU & SUSFS
          CONFIG_KSU=y
          CONFIG_KSU_KPROBES_HOOK=n
          CONFIG_KSU_SUSFS=y
          CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_PATH=y
          CONFIG_KSU_SUSFS_SUS_MOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_KSTAT=y
          CONFIG_KSU_SUSFS_TRY_UMOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y
          CONFIG_KSU_SUSFS_SPOOF_UNAME=y
          CONFIG_KSU_SUSFS_ENABLE_LOG=y
          CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
          CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
          CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
          CONFIG_KSU_SUSFS_SUS_MAP=y

          # TMPFS
          CONFIG_TMPFS_XATTR=y
          CONFIG_TMPFS_POSIX_ACL=y

          # BBR
          CONFIG_TCP_CONG_ADVANCED=y
          CONFIG_TCP_CONG_BBR=y
          CONFIG_NET_SCH_FQ=y
          CONFIG_NET_SCH_FQ_CODEL=y

          # TTL
          CONFIG_IP_NF_TARGET_TTL=y
          CONFIG_IP6_NF_TARGET_HL=y
          CONFIG_IP6_NF_MATCH_HL=y

          # IP_SET
          CONFIG_IP_SET=y
          CONFIG_IP_SET_MAX=65534
          CONFIG_IP_SET_BITMAP_IP=y
          CONFIG_IP_SET_BITMAP_IPMAC=y
          CONFIG_IP_SET_BITMAP_PORT=y
          CONFIG_IP_SET_HASH_IP=y
          CONFIG_IP_SET_HASH_IPMARK=y
          CONFIG_IP_SET_HASH_IPPORT=y
          CONFIG_IP_SET_HASH_IPPORTIP=y
          CONFIG_IP_SET_HASH_IPPORTNET=y
          CONFIG_IP_SET_HASH_IPMAC=y
          CONFIG_IP_SET_HASH_MAC=y
          CONFIG_IP_SET_HASH_NETPORTNET=y
          CONFIG_IP_SET_HASH_NET=y
          CONFIG_IP_SET_HASH_NETNET=y
          CONFIG_IP_SET_HASH_NETPORT=y
          CONFIG_IP_SET_HASH_NETIFACE=y
          CONFIG_IP_SET_LIST_SET=y

          # Rust
          CONFIG_ANDROID_BINDER_IPC_RUST=m
          CONFIG_RUST=y

          # Optimization
          CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y
          CONFIG_OPTIMIZE_INLINING=y
          CONFIG_FRAME_WARN=0
          CONFIG_TRACEPOINTS=y

          # Debug off
          CONFIG_DEBUG_KERNEL=n
          CONFIG_DEBUG_INFO=n
          CONFIG_GDB_SCRIPTS=n
          CONFIG_LOCK_DEBUGGING=n
          CONFIG_DEBUG_MUTEXES=n
          CONFIG_DEBUG_SPINLOCK=n
          CONFIG_DEBUG_ATOMIC_SLEEP=n
          CONFIG_SCHED_DEBUG=n
          CONFIG_SCHEDSTATS=n
          CONFIG_DEBUG_MISC=n
          CONFIG_DEBUG_BUGVERBOSE=n
          EOF

          echo "âœ… Kernel configured"
          echo "::endgroup::"

      - name: ðŸ”¨ Build Kernel
        env:
          PYTHONWARNINGS: "ignore:invalid escape sequence"
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Build kernel"
          cd "$GITHUB_WORKSPACE/OP15/kernel_platform/common"

          : > .scmversion

          export PYTHONWARNINGS="${PYTHONWARNINGS}"
          export LLVM=1 LLVM_IAS=1
          export ARCH=arm64 SUBARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export LD=ld.lld HOSTLD=ld.lld AR=llvm-ar NM=llvm-nm
          export OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump STRIP=llvm-strip

          KERNEL_PATH="${GITHUB_WORKSPACE}/OP15/kernel_platform"
          BASE_PATH="/usr/lib/ccache:${CLANG_BIN_PATH}:${KERNEL_PATH}/prebuilts/kernel-build-tools/linux-x86/bin/:${KERNEL_PATH}/prebuilts/kernel-build-tools/linux_musl-x86/bin/"

          if [ -n "${RUSTC_BIN_PATH:-}" ]; then
            export PATH="${BASE_PATH}:${RUSTC_BIN_PATH}:${PATH}"
            export RUSTC="${RUSTC_BIN_PATH}/rustc"
            export LIBCLANG_PATH="${CLANG_BIN_PATH}/../lib"
            export BINDGEN="bindgen"
          else
            export PATH="${BASE_PATH}:${PATH}"
          fi

          if [ "${{ inputs.clean_build }}" = "true" ]; then
            echo "ðŸ§¹ Clean build - ccache disabled"
            export CCACHE_DISABLE=1
          else
            echo "ðŸš€ ccache-accelerated build"
            export CC="ccache clang"
            export CXX="ccache clang++"
            export HOSTCC="ccache clang"
            export HOSTCXX="ccache clang++"
            export CCACHE_DIR="$HOME/.ccache"
            export CCACHE_BASEDIR="${GITHUB_WORKSPACE}"
            export CCACHE_COMPILERCHECK="content"
            export CCACHE_NOHASHDIR="true"
          fi

          WORKSPACE="${GITHUB_WORKSPACE}"
          MAP="-fdebug-prefix-map=${WORKSPACE}=."
          MPMAP="-fmacro-prefix-map=${WORKSPACE}=."
          FPMAP="-ffile-prefix-map=${WORKSPACE}=."

          if [ "${{ inputs.optimize_level }}" = "O3" ]; then OPT_FLAG="-O3"; else OPT_FLAG="-O2"; fi

          export KCFLAGS="${KCFLAGS:-} $MAP $MPMAP $FPMAP -no-canonical-prefixes -fdiagnostics-color=never -Qunused-arguments -Wno-unused-command-line-argument -D__ANDROID_COMMON_KERNEL__ -Wno-error -pipe -fno-stack-protector $OPT_FLAG"
          export KCPPFLAGS="${KCPPFLAGS:-} $MAP $MPMAP $FPMAP -DCONFIG_OPTIMIZE_INLINING"

          export SOURCE_DATE_EPOCH="$(git log -1 --format=%ct 2>/dev/null || date +%s)"
          export KBUILD_BUILD_TIMESTAMP="$(date -u)"
          export KBUILD_BUILD_USER="${BUILD_USER}"
          export KBUILD_BUILD_HOST="${BUILD_HOST}"
          export KBUILD_BUILD_VERSION=1

          echo "============================================"
          echo "ðŸ”§ Build Configuration"
          echo "============================================"
          echo "Device: ${OP_MODEL}"
          echo "Kernel: ${KERNEL_FULL_VER}"
          echo "Threads: $(nproc --all)"
          echo "Optimization: ${{ inputs.optimize_level }}"
          echo "ccache: ${{ inputs.clean_build && 'DISABLED' || 'ENABLED' }}"
          echo "============================================"

          OUT=out
          mkdir -p "$OUT"
          make O="$OUT" gki_defconfig

          LOCAL_LOCALVERSION="-${OP_ANDROID_VERSION}-${OP_UNAME}"
          scripts/config --file "$OUT/.config" --set-str LOCALVERSION "${LOCAL_LOCALVERSION}"
          scripts/config --file "$OUT/.config" -d LOCALVERSION_AUTO || true
          sed -i 's/scm_version="$(scm_version --short)"/scm_version=""/' scripts/setlocalversion

          if [ "${{ inputs.optimize_level }}" = "O3" ]; then
            scripts/config --file "$OUT/.config" -d CC_OPTIMIZE_FOR_PERFORMANCE
            scripts/config --file "$OUT/.config" -e CC_OPTIMIZE_FOR_PERFORMANCE_O3
          else
            scripts/config --file "$OUT/.config" -e CC_OPTIMIZE_FOR_PERFORMANCE
            scripts/config --file "$OUT/.config" -d CC_OPTIMIZE_FOR_PERFORMANCE_O3
          fi

          # LTO none
          scripts/config --file "$OUT/.config" -e LTO_CLANG
          scripts/config --file "$OUT/.config" -e LTO_CLANG_NONE
          scripts/config --file "$OUT/.config" -d LTO_CLANG_THIN
          scripts/config --file "$OUT/.config" -d LTO_CLANG_FULL

          make O="$OUT" olddefconfig

          echo ""
          echo "ðŸ”¨ Starting compilation..."
          BUILD_START=$(date +%s)

          set -o pipefail
          make -j"$(nproc --all)" O="$OUT" 2>&1 | tee build.log

          BUILD_END=$(date +%s)
          BUILD_TIME=$((BUILD_END - BUILD_START))

          echo "BUILD_TIME=$BUILD_TIME" >> "$GITHUB_ENV"

          IMG="$OUT/arch/arm64/boot/Image"
          if [ ! -f "$IMG" ]; then
            echo "::error::Build failed - Image not found"
            echo "::group::Last 100 lines of build log"
            tail -n 100 build.log
            echo "::endgroup::"
            exit 1
          fi

          IMG_SIZE=$(stat -c%s "$IMG")
          IMG_SHA=$(sha256sum "$IMG" | awk '{print $1}')

          echo "IMAGE_SHA256=$IMG_SHA" >> "$GITHUB_ENV"
          echo "KERNEL_UNAME=$(strings "$IMG" | grep -E 'Linux version.*#' | tail -n1)" >> "$GITHUB_ENV"
          echo "WARNINGS_COUNT=$(grep -ciE '\bwarning:' build.log || echo 0)" >> "$GITHUB_ENV"

          echo ""
          echo "============================================"
          echo "âœ… Build Complete"
          echo "============================================"
          echo "Duration: $((BUILD_TIME / 60))m $((BUILD_TIME % 60))s"
          echo "Image size: $(numfmt --to=iec-i --suffix=B "$IMG_SIZE")"
          echo "SHA256: $IMG_SHA"

          if [ "${{ inputs.clean_build }}" != "true" ]; then
            echo ""
            echo "ðŸ“Š ccache statistics:"
            ccache -s | head -n 20
          fi

          echo "============================================"
          echo "::endgroup::"

      - name: ðŸ“¦ Create Flashable ZIP
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Create flashable ZIP"

          IMAGE_PATH="$GITHUB_WORKSPACE/OP15/kernel_platform/common/out/arch/arm64/boot/Image"

          if [ ! -f "$IMAGE_PATH" ]; then
            echo "::error::Image not found at $IMAGE_PATH"
            exit 1
          fi

          cp "$IMAGE_PATH" "$GITHUB_WORKSPACE/AnyKernel3/Image"
          cd "$GITHUB_WORKSPACE/AnyKernel3"

          : "${KSUVER:=unknown}"
          : "${SUSVER:=nosusfs}"

          ZIP_NAME="AK3_${OP_MODEL}_${OP_OS_VERSION}_${KERNEL_FULL_VER}_${{ inputs.ksu_type }}_${KSUVER}_SuSFS_${SUSVER}.zip"

          echo "ðŸ“¦ Creating: $ZIP_NAME"
          zip -r9 "$ZIP_NAME" ./* -x "*.git*" -x "$ZIP_NAME" -x "README.md"

          mkdir -p "$GITHUB_WORKSPACE/artifacts"
          mv "$ZIP_NAME" "$GITHUB_WORKSPACE/artifacts/"

          ZIP_SIZE=$(stat -c%s "$GITHUB_WORKSPACE/artifacts/$ZIP_NAME")
          ZIP_SHA=$(sha256sum "$GITHUB_WORKSPACE/artifacts/$ZIP_NAME" | awk '{print $1}')

          echo "ZIP_NAME=$ZIP_NAME" >> "$GITHUB_ENV"
          echo "ZIP_SIZE=$ZIP_SIZE" >> "$GITHUB_ENV"
          echo "ZIP_SHA256=$ZIP_SHA" >> "$GITHUB_ENV"

          echo ""
          echo "âœ… ZIP created:"
          echo "   Name: $ZIP_NAME"
          echo "   Size: $(numfmt --to=iec-i --suffix=B "$ZIP_SIZE")"
          echo "   SHA256: $ZIP_SHA"

          echo "::endgroup::"

      - name: ðŸ“¤ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ inputs.ksu_type }}-OP15-${{ env.OP_OS_VERSION }}
          path: artifacts/
          retention-days: 7
          compression-level: 0

      - name: ðŸ“Š Build Summary
        shell: bash
        run: |
          set -euo pipefail

          if [ "${{ inputs.ksu_type }}" = "KSUN" ]; then
            KSU_REPO_URL="https://github.com/KernelSU-Next/KernelSU-Next"
          else
            KSU_REPO_URL="https://github.com/tiann/KernelSU"
          fi

          cat >> "$GITHUB_STEP_SUMMARY" <<EOF
          # ðŸŽ‰ OnePlus 15 Kernel Build Complete

          ## ðŸ“± Device Information
          | Property | Value |
          |----------|-------|
          | **Model** | ${OP_MODEL} (${OP_SOC}) |
          | **OS Version** | ${OP_OS_VERSION} |
          | **Kernel Version** | ${KERNEL_FULL_VER} |
          | **Kernel Uname** | \`${KERNEL_UNAME}\` |

          ## ðŸ”§ Build Configuration
          | Component | Version/Setting |
          |-----------|----------------|
          | **${{ inputs.ksu_type }}** | v${KSUVER} |
          | **SUSFS** | ${SUSVER} |
          | **SUSFS Branch** | ${SUSFS_BRANCH_NAME:-unknown} |
          | **Optimization** | ${{ inputs.optimize_level }} |
          | **LTO** | ${OP_LTO} |
          | **Clean Build** | ${{ inputs.clean_build && 'âœ… Yes' || 'âŒ No' }} |
          | **Build Time** | ${BUILD_TIME}s ($((BUILD_TIME / 60))m $((BUILD_TIME % 60))s) |
          | **Warnings** | ${WARNINGS_COUNT} |

          ## âœ¨ Enabled Features
          - âœ… **SUSFS ${SUSVER}**
          - âœ… **BBG LSM**
          - âœ… **BBR TCP**
          - âœ… **TTL Target**
          - âœ… **IP_SET**
          - âœ… **Rust Support**
          - âœ… **TMPFS_XATTR**
          - âœ… **TMPFS_POSIX_ACL**

          ## ðŸ“¦ Build Output
          | File | Details |
          |------|---------|
          | **ZIP Name** | \`${ZIP_NAME}\` |
          | **ZIP Size** | $(numfmt --to=iec-i --suffix=B "${ZIP_SIZE}") |
          | **ZIP SHA256** | \`${ZIP_SHA256}\` |
          | **Image SHA256** | \`${IMAGE_SHA256}\` |

          ## ðŸ”— Source Commits
          | Component | Commit |
          |-----------|--------|
          | **${{ inputs.ksu_type }}** | [\`${KSU_COMMIT_SHA:0:8}\`](${KSU_REPO_URL}/commit/${KSU_COMMIT_SHA}) |
          | **SUSFS** | [\`${SUSFS_COMMIT_SHA:0:8}\`](https://gitlab.com/simonpunk/susfs4ksu/-/commit/${SUSFS_COMMIT_SHA}) |

          ## ðŸ› ï¸ Toolchain
          | Tool | Version |
          |------|---------|
          | **Clang** | ${CLANG_VERSION} |
          | **Rust** | ${RUSTC_VERSION:-N/A} |
          | **Build User** | ${BUILD_USER} |
          | **Build Host** | ${BUILD_HOST} |

          ---
          EOF

      - name: ðŸ§¹ Cleanup
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Cleanup"

          sudo rm -rf "$GITHUB_WORKSPACE/OP15/kernel_platform/common/out" || true
          sudo rm -rf "$GITHUB_WORKSPACE/OP15/.repo" || true
          sudo rm -rf /tmp/* || true

          if [ "${{ inputs.clean_build }}" != "true" ] && command -v ccache >/dev/null 2>&1; then
            echo ""
            echo "ðŸ“Š Final ccache statistics:"
            ccache -s || true
            echo ""
            echo "ðŸ’¾ ccache preserved for next build"
          fi

          echo ""
          echo "ðŸ’½ Final disk usage:"
          df -h /

          echo "::endgroup::"
