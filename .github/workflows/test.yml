name: Build

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      ksu_meta:
        description: 'SukiSU: branch(required)/custom_tag(optional)/commit_hash(optional)'
        required: true
        type: string
        default: "tmp-builtin/âš¡Ultraâš¡/"

      susfs_branch:
        description: 'SUSFS branch/commit (empty = auto: gki-android16-6.12)'
        type: string
        default: ""

      optimize_level:
        description: 'Optimization level'
        type: choice
        options: [O2, O3]
        default: O2

      clean_build:
        description: 'Clean build (no ccache)'
        type: boolean
        default: false

jobs:
  build-op15:
    runs-on: ubuntu-latest
    env:
      # Device Configuration
      OP_MODEL: "OP15"
      OP_SOC: "canoe"
      OP_BRANCH: "wild/sm8850"
      OP_MANIFEST: "oneplus_15_w.xml"
      OP_ANDROID_VERSION: "android16"
      OP_KERNEL_VERSION: "6.12"
      OP_OS_VERSION: "OOS16"
      OP_LTO: "none"
      OP_RUST_BUILD: "true"
      OP_HMBIRD: "false"
      OP_SUSFS: "true"
      OP_BBG: "false"
      OP_BBR: "true"
      OP_TTL: "true"
      OP_IP_SET: "true"
      OP_UNAME: "5-g188c695beb6d-ab14367805-4k"

      # Aliases used by your SUSFS logic
      ANDROID_VER: "android16"
      KERNEL_VER: "6.12"

    steps:
      - name: ðŸ§¹ Free Disk Space
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Disk cleanup"
          df -h
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL || true
          sudo apt-get clean || true
          if command -v docker >/dev/null 2>&1; then
            docker rmi $(docker images -q) 2>/dev/null || true
          fi
          df -h
          echo "::endgroup::"

      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ“¦ Install Dependencies
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Install dependencies"
          sudo apt-get update -qq
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            git curl ca-certificates build-essential clang lld flex bison \
            libelf-dev libssl-dev libncurses-dev zlib1g-dev liblz4-tool \
            libxml2-utils rsync unzip dwarves file python3 ccache jq bc dos2unix kmod libdw-dev elfutils
          sudo apt-get clean
          echo "âœ… Dependencies installed"
          echo "::endgroup::"

      - name: ðŸ¦€ Install Rust bindgen
        if: ${{ env.OP_RUST_BUILD == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Install Rust bindgen"
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain none
          source "$HOME/.cargo/env"
          cargo install bindgen-cli --version 0.69.5
          bindgen --version
          echo "âœ… Rust bindgen installed"
          echo "::endgroup::"

      - name: ðŸ”§ Setup Environment
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Setup environment"

          REPO="/usr/local/bin/repo"
          if [ ! -x "$REPO" ]; then
            sudo curl -s https://storage.googleapis.com/git-repo-downloads/repo -o "$REPO"
            sudo chmod +x "$REPO"
          fi
          echo "REPO=$REPO" >> "$GITHUB_ENV"

          echo "CONFIG=$GITHUB_WORKSPACE/OP15" >> "$GITHUB_ENV"

          git config --global feature.manyFiles true
          git config --global core.fsmonitor true
          git config --global pack.sparse true

          echo "BUILD_USER=OnePlus" >> "$GITHUB_ENV"
          echo "BUILD_HOST=ubuntu-build" >> "$GITHUB_ENV"

          echo "âœ… Environment configured"
          echo "::endgroup::"

      - name: ðŸ“¥ Sync Kernel Source
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Sync kernel source"
          mkdir -p OP15
          cd OP15

          "$REPO" init \
            -u https://github.com/Bouteillepleine/OnePlus_KernelSU_SUSFS.git \
            -b main \
            -m "manifests/oos16/${OP_MANIFEST}" \
            --repo-rev=v2.16 \
            --depth=1 \
            --no-clone-bundle \
            --no-tags

          if [ ! -f .repo/manifest.xml ]; then
            echo "::error::Manifest file not found after repo init"
            ls -la .repo/ || true
            exit 1
          fi

          success=false
          for i in 1 2 3; do
            if "$REPO" sync -c --no-clone-bundle --no-tags --optimized-fetch \
              -j"$(nproc --all)" --fail-fast; then
              success=true
              break
            fi
            echo "âš ï¸ Sync attempt $i failed, retrying in 30 seconds..."
            sleep 30
          done

          if [ "$success" = false ]; then
            echo "::error::Failed to sync kernel source after 3 attempts"
            exit 1
          fi

          if [ ! -d kernel_platform ]; then
            echo "::error::kernel_platform directory not found after sync"
            ls -la .
            exit 1
          fi

          echo "âœ… Kernel source synced successfully"
          echo "::endgroup::"

      - name: ðŸ” Detect Kernel Version
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Detect kernel version"
          cd OP15/kernel_platform/common

          VERSION=$(awk '/^VERSION *=/ {print $3}' Makefile)
          PATCHLEVEL=$(awk '/^PATCHLEVEL *=/ {print $3}' Makefile)
          SUBLEVEL=$(awk '/^SUBLEVEL *=/ {print $3}' Makefile)
          FULL_VERSION="$VERSION.$PATCHLEVEL.$SUBLEVEL"

          echo "KERNEL_FULL_VER=$OP_ANDROID_VERSION-$FULL_VERSION" >> "$GITHUB_ENV"
          echo "TKERNEL_VER=$FULL_VERSION" >> "$GITHUB_ENV"
          echo "SUSFS_KERNEL_BRANCH=gki-$OP_ANDROID_VERSION-$VERSION.$PATCHLEVEL" >> "$GITHUB_ENV"

          echo "âœ… Detected: $OP_ANDROID_VERSION-$FULL_VERSION"
          echo "::endgroup::"

      - name: ðŸ” Detect Toolchain
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Detect toolchain"

          KP="$GITHUB_WORKSPACE/OP15/kernel_platform"

          CLANG_FOUND=false
          for base in "$KP/prebuilts" "$KP/prebuilts-master"; do
            [ -d "$base/clang/host/linux-x86" ] || continue
            latest=$(ls -d "$base"/clang/host/linux-x86/clang-r*/ 2>/dev/null | sort -V | tail -n1 || true)
            if [ -n "$latest" ] && [ -x "$latest/bin/clang" ]; then
              echo "CLANG_BIN_PATH=$latest/bin" >> "$GITHUB_ENV"
              CLANG_VER="$("$latest/bin/clang" --version | head -n1)"
              echo "CLANG_VERSION=$CLANG_VER" >> "$GITHUB_ENV"
              echo "âœ… Clang: $CLANG_VER"
              CLANG_FOUND=true
              break
            fi
          done
          if [ "$CLANG_FOUND" = false ]; then
            echo "::error::Clang toolchain not found"
            exit 1
          fi

          RUSTC_FOUND=false
          for base in "$KP/prebuilts" "$KP/prebuilts-master"; do
            [ -d "$base/rust/linux-x86/" ] || continue
            latest=$(ls -d "$base/rust/linux-x86/1."* 2>/dev/null | sort -V | head -n1 || true)
            if [ -n "$latest" ] && [ -x "$latest/bin/rustc" ]; then
              echo "RUSTC_BIN_PATH=$latest/bin" >> "$GITHUB_ENV"
              RUSTC_VER="$("$latest/bin/rustc" --version)"
              echo "RUSTC_VERSION=$RUSTC_VER" >> "$GITHUB_ENV"
              echo "âœ… Rust: $RUSTC_VER"
              RUSTC_FOUND=true
              break
            fi
          done
          if [ "$RUSTC_FOUND" = false ]; then
            echo "âš ï¸ Rust toolchain not found"
          fi

          echo "::endgroup::"

      - name: â™»ï¸ Setup ccache
        if: ${{ inputs.clean_build != true }}
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-op15-v2-${{ env.KERNEL_FULL_VER }}-${{ hashFiles('OP15/kernel_platform/common/Makefile') }}
          restore-keys: |
            ccache-op15-v2-${{ env.KERNEL_FULL_VER }}-
            ccache-op15-v2-

      - name: ðŸ”§ Configure ccache
        if: ${{ inputs.clean_build != true }}
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Configure ccache"
          export CCACHE_DIR="$HOME/.ccache"
          mkdir -p "$CCACHE_DIR"
          ccache -M 1G
          ccache -o compression=true
          ccache -o compression_level=3
          ccache -o direct_mode=true
          ccache -o file_clone=true
          ccache -o inode_cache=true
          ccache -s
          echo "::endgroup::"

      - name: ðŸ“¦ Clone Dependencies
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Clone dependencies"
          cd "$GITHUB_WORKSPACE"

          git clone --depth=1 https://github.com/Bouteillepleine/AnyKernel3.git -b gki-2.0          
          git clone https://github.com/ShirkNeko/SukiSU_patch.git
          git clone https://github.com/Numbersf/Action-Build.git

          if [ "${OP_SUSFS}" = "true" ]; then
            git clone https://gitlab.com/simonpunk/susfs4ksu.git
            cd susfs4ksu

            SUSFS_BRANCH_INPUT="${{ inputs.susfs_branch }}"
            if [ -z "$SUSFS_BRANCH_INPUT" ]; then
              SUSFS_BRANCH_INPUT="${SUSFS_KERNEL_BRANCH}"
            fi

            if git rev-parse --verify "origin/$SUSFS_BRANCH_INPUT" >/dev/null 2>&1; then
              git checkout "$SUSFS_BRANCH_INPUT"
            elif git rev-parse --verify "$SUSFS_BRANCH_INPUT" >/dev/null 2>&1; then
              git checkout "$SUSFS_BRANCH_INPUT"
            else
              echo "::error::SUSFS branch '$SUSFS_BRANCH_INPUT' not found"
              exit 1
            fi

            echo "SUSFS_COMMIT_SHA=$(git rev-parse HEAD)" >> "$GITHUB_ENV"
            echo "SUSFS_BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "detached")" >> "$GITHUB_ENV"
          fi

          echo "::endgroup::"

      - name: ðŸ§¹ Clean ABI Exports
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Clean ABI exports"
          cd "$CONFIG/kernel_platform"
          rm -f common/android/abi_gki_protected_exports_* || true
          rm -f msm-kernel/android/abi_gki_protected_exports_* || true
          sed -i 's/protected_modules = \[.*\]/protected_modules = []/' common/modules.bzl || true
          echo "::endgroup::"

      - name: Add SukiSU Ultra
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Add SukiSU Ultra"
          cd "$CONFIG/kernel_platform"

          KSU_META="${{ inputs.ksu_meta }}"
          if [[ "$(grep -o '/' <<< "$KSU_META" | wc -l)" -lt 2 ]]; then
            echo "::error::ksu_meta format error. Required: branch/custom_tag/commit_hash"
            echo "Example: tmp-builtin/âš¡Ultraâš¡/ or tmp-builtin/âš¡Ultraâš¡/abc123deadbeef"
            exit 1
          fi

          IFS='/' read -r BRANCH_NAME CUSTOM_TAG MANUAL_HASH <<< "$KSU_META"
          if [[ -z "${BRANCH_NAME:-}" ]]; then
            echo "::error::ksu_meta branch is required (first field)."
            exit 1
          fi

          echo "Branch: $BRANCH_NAME"
          echo "Custom Tag: ${CUSTOM_TAG:-}"
          echo "Manual Hash: ${MANUAL_HASH:-}"

          curl --fail --location --proto '=https' -LSs \
            "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | \
            bash -s "$BRANCH_NAME"

          cd ./KernelSU

          if [[ -n "${MANUAL_HASH:-}" ]]; then
            git fetch origin "$BRANCH_NAME" --depth=50 || true
            git checkout "$MANUAL_HASH"
          fi

          KSU_VERSION=$(expr $(git rev-list --count main 2>/dev/null || echo 13000) + 37185)
          KSU_COMMIT_SHA=$(git rev-parse HEAD)

          echo "KSU_COMMIT_SHA=$KSU_COMMIT_SHA" >> "$GITHUB_ENV"
          echo "KSUVER=$KSU_VERSION" >> "$GITHUB_ENV"

          # SukiSU: let hooks be driven by SUSFS logic
          echo "NEED_HOOKS=false" >> "$GITHUB_ENV"

          echo "âœ… SukiSU Ultra added (KSUVER=$KSU_VERSION, commit: ${KSU_COMMIT_SHA:0:8})"
          echo "::endgroup::"

      - name: Fix KernelSU ksud.h user_arg_ptr redefinition (6.12)
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Fix ksud.h user_arg_ptr"
          cd "$CONFIG/kernel_platform"

          # Prefer common/ first if present (thatâ€™s typically what the kernel build uses)
          KSUD_PATH="$(find . -path './common/drivers/kernelsu/ksud.h' -print -quit || true)"
          if [ -z "$KSUD_PATH" ]; then
            KSUD_PATH="$(find . -path '*/drivers/kernelsu/ksud.h' -print -quit || true)"
          fi

          if [ -z "$KSUD_PATH" ]; then
            echo "::error::ksud.h not found"
            exit 1
          fi

          echo "Found: $KSUD_PATH"
          echo "--- occurrences before:"
          grep -n "struct user_arg_ptr" "$KSUD_PATH" || true

          python3 - "$KSUD_PATH" <<'PY'
          import re, sys, pathlib

          p = pathlib.Path(sys.argv[1])
          s = p.read_text(encoding="utf-8", errors="ignore").splitlines(True)

          # Locate all "struct user_arg_ptr {" blocks
          starts = [i for i,l in enumerate(s) if re.match(r'^\s*struct\s+user_arg_ptr\s*\{', l)]
          if len(starts) <= 1:
            print("No duplicate struct user_arg_ptr found (or already fixed).")
            sys.exit(0)

          # Remove subsequent full blocks up to the closing '};'
          remove_ranges = []
          for st in starts[1:]:
            en = st
            while en < len(s) and not re.match(r'^\s*\};\s*$', s[en]):
              en += 1
            if en < len(s):
              en += 1  # include closing '};'
            remove_ranges.append((st, en))

          out = []
          i = 0
          ri = 0
          while i < len(s):
            if ri < len(remove_ranges) and i == remove_ranges[ri][0]:
              a, b = remove_ranges[ri]
              out.append("/* removed duplicate struct user_arg_ptr (auto-fix for 6.12 build) */\n")
              i = b
              ri += 1
              continue
            out.append(s[i])
            i += 1

          p.write_text("".join(out), encoding="utf-8")
          print(f"Removed {len(remove_ranges)} duplicate definition(s) from {p}.")
          PY

          echo "--- occurrences after:"
          grep -n "struct user_arg_ptr" "$KSUD_PATH" || true
          echo "::endgroup::"

      - name: Apply SUSFS Patches
        shell: bash
        if: ${{ env.OP_SUSFS == 'true' }}
        run: |
          set -euo pipefail
          echo "::group::Apply SUSFS patches"
          cd "$CONFIG/kernel_platform"

          PATCH_FILE="../../susfs4ksu/kernel_patches/50_add_susfs_in_${{ env.SUSFS_KERNEL_BRANCH }}.patch"
          if [ ! -f "$PATCH_FILE" ]; then
            echo "::error::SUSFS patch not found: $PATCH_FILE"
            ls -áƒšáƒ ../../susfs4ksu/kernel_patches/ || true
            exit 1
          fi

          cp "$PATCH_FILE" ./common/
          cp ../../susfs4ksu/kernel_patches/fs/* ./common/fs/
          cp ../../susfs4ksu/kernel_patches/include/linux/* ./common/include/linux/

          susfs_version=$(grep '#define SUSFS_VERSION' ./common/include/linux/susfs.h | awk -F'"' '{print $2}')
          echo "SUSVER=$susfs_version" >> "$GITHUB_ENV"
          echo "SUSFS version detected: $susfs_version"

          version_lte() { [ "$(printf '%s\n' "$2" "$1" | sort -V | head -n1)" = "$1" ]; }
          if version_lte "${susfs_version:1}" "1.5.12"; then
            echo "NEED_HOOKS=true" >> "$GITHUB_ENV"
          else
            echo "NEED_HOOKS=false" >> "$GITHUB_ENV"
          fi

          case "$susfs_version" in
            "v1.5.8"|"v1.5.9"|"v1.5.10"|"v1.5.11"|"v1.5.12"|"v2.0.0")
              cd ./KernelSU
              cp ../../../susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch ./
              echo "Patching KernelSU for SUSFS..."
              # FAIL if it doesn't apply cleanly
              patch -p1 --forward --fuzz=3 < 10_enable_susfs_for_ksu.patch
              ;;
            *)
              echo "::error::Unsupported SUSFS version: $susfs_version"
              exit 1
              ;;
          esac

          cd ../common
          echo "Patching kernel tree with SUSFS..."
          patch -p1 --forward < "50_add_susfs_in_${{ env.SUSFS_KERNEL_BRANCH }}.patch" || {
            echo "::error::SUSFS kernel patch failed. Showing rejects (if any):"
            find . -name "*.rej" -maxdepth 5 -print -exec sed -n '1,200p' {} \; || true
            exit 1
          }

          echo "âœ… SUSFS patches applied"
          echo "::endgroup::"

      - name: Add BBG
        if: ${{ env.OP_BBG == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Add BBG LSM"
          cd "$CONFIG/kernel_platform"
          if ! wget -O- https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh | bash -s fix_blkdev_rename; then
            echo "::warning::BBG setup script failed, continuing anyway"
          fi
          echo "CONFIG_BBG=y" >> common/arch/arm64/configs/gki_defconfig
          sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/selinux/selinux,baseband_guard/ } }' common/security/Kconfig
          echo "::endgroup::"

      - name: Apply Other Patches
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Apply Other patches"
          cd "$CONFIG/kernel_platform/common"

          KERNEL_VERSION="${{ env.KERNEL_VER }}"
          MIN_VERSION="5.16"
          if [ "$(printf '%s\n' "$KERNEL_VERSION" "$MIN_VERSION" | sort -V | head -n1)" = "$KERNEL_VERSION" ]; then
            patch -p1 -F 3 < "../../../kernel_patches/gki_ptrace.patch"
          fi

          patch -p1 --forward < "../../../kernel_patches/common/optimized_mem_operations.patch"
          patch -p1 --forward < "../../../kernel_patches/common/file_struct_8bytes_align.patch"
          patch -p1 --forward < "../../../kernel_patches/common/reduce_cache_pressure.patch"

          if [ "$(printf '%s\n' "$KERNEL_VERSION" "$MIN_VERSION" | sort -V | head -n1)" = "$KERNEL_VERSION" ]; then
            patch -p1 --forward < "../../../kernel_patches/common/clear_page_16bytes_align.patch"
            patch -p1 --forward < "../../../kernel_patches/common/unicode_bypass_fix_6.1-.patch"
          else
            cat "../../../kernel_patches/common/clear_page_16bytes_align.patch" \
              | sed -e 's/SYM_FUNC_START_PI(clear_page)/SYM_FUNC_START_PI(__pi_clear_page)/' \
              | patch -p1 -F3 --forward
            patch -p1 --forward < "../../../kernel_patches/common/unicode_bypass_fix_6.1+.patch"
          fi

          echo "::endgroup::"      

      - name: Add SukiSU + SUSFS config (gki_defconfig)
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Kernel config"
          cd "$CONFIG/kernel_platform"
          DEFCONFIG="common/arch/arm64/configs/gki_defconfig"

          add_cfg() { echo "$1" >> "$DEFCONFIG"; }

          add_cfg "CONFIG_KSU=y"
          add_cfg "CONFIG_KSU_KPROBES_HOOK=n"
          add_cfg "CONFIG_KSU_SUSFS=y"
          add_cfg "CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y"
          add_cfg "CONFIG_KSU_SUSFS_SUS_PATH=y"
          add_cfg "CONFIG_KSU_SUSFS_SUS_MOUNT=y"
          add_cfg "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y"
          add_cfg "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y"
          add_cfg "CONFIG_KSU_SUSFS_SUS_KSTAT=y"
          add_cfg "CONFIG_KSU_SUSFS_SUS_OVERLAYFS=n"
          add_cfg "CONFIG_KSU_SUSFS_TRY_UMOUNT=y"
          add_cfg "CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y"
          add_cfg "CONFIG_KSU_SUSFS_SPOOF_UNAME=y"
          add_cfg "CONFIG_KSU_SUSFS_ENABLE_LOG=y"
          add_cfg "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y"
          add_cfg "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y"
          add_cfg "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y"
          add_cfg "CONFIG_KSU_SUSFS_SUS_MAP=y"
          add_cfg "CONFIG_KSU_SUSFS_SUS_SU=n"
          add_cfg "CONFIG_TMPFS_XATTR=y"
          add_cfg "CONFIG_TMPFS_POSIX_ACL=y"

          if [ "${OP_BBR}" = "true" ]; then
            add_cfg "CONFIG_TCP_CONG_ADVANCED=y"
            add_cfg "CONFIG_TCP_CONG_BBR=y"
            add_cfg "CONFIG_NET_SCH_FQ=y"
            add_cfg "CONFIG_NET_SCH_FQ_CODEL=y"
          fi

          if [ "${OP_TTL}" = "true" ]; then
            add_cfg "CONFIG_IP_NF_TARGET_TTL=y"
            add_cfg "CONFIG_IP6_NF_TARGET_HL=y"
            add_cfg "CONFIG_IP6_NF_MATCH_HL=y"
          fi

          if [ "${OP_IP_SET}" = "true" ]; then
            add_cfg "CONFIG_IP_SET=y"
            add_cfg "CONFIG_IP_SET_MAX=65534"
            add_cfg "CONFIG_IP_SET_BITMAP_IP=y"
            add_cfg "CONFIG_IP_SET_BITMAP_IPMAC=y"
            add_cfg "CONFIG_IP_SET_BITMAP_PORT=y"
            add_cfg "CONFIG_IP_SET_HASH_IP=y"
            add_cfg "CONFIG_IP_SET_HASH_IPMARK=y"
            add_cfg "CONFIG_IP_SET_HASH_IPPORT=y"
            add_cfg "CONFIG_IP_SET_HASH_IPPORTIP=y"
            add_cfg "CONFIG_IP_SET_HASH_IPPORTNET=y"
            add_cfg "CONFIG_IP_SET_HASH_IPMAC=y"
            add_cfg "CONFIG_IP_SET_HASH_MAC=y"
            add_cfg "CONFIG_IP_SET_HASH_NETPORTNET=y"
            add_cfg "CONFIG_IP_SET_HASH_NET=y"
            add_cfg "CONFIG_IP_SET_HASH_NETNET=y"
            add_cfg "CONFIG_IP_SET_HASH_NETPORT=y"
            add_cfg "CONFIG_IP_SET_HASH_NETIFACE=y"
            add_cfg "CONFIG_IP_SET_LIST_SET=y"
          fi

          add_cfg "CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y"
          add_cfg "CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE_O3=n"
          add_cfg "CONFIG_OPTIMIZE_INLINING=y"
          add_cfg "CONFIG_FRAME_WARN=0"
          add_cfg "CONFIG_TRACEPOINTS=y"
          add_cfg "CONFIG_ANDROID_BINDER_IPC_RUST=m"
          add_cfg "CONFIG_RUST=y"

          add_cfg "CONFIG_DEBUG_KERNEL=n"
          add_cfg "CONFIG_DEBUG_INFO=n"
          add_cfg "CONFIG_GDB_SCRIPTS=n"
          add_cfg "CONFIG_LOCK_DEBUGGING=n"
          add_cfg "CONFIG_DEBUG_MUTEXES=n"
          add_cfg "CONFIG_DEBUG_SPINLOCK=n"
          add_cfg "CONFIG_DEBUG_ATOMIC_SLEEP=n"
          add_cfg "CONFIG_SCHED_DEBUG=n"
          add_cfg "CONFIG_SCHEDSTATS=n"
          add_cfg "CONFIG_DEBUG_MISC=n"
          add_cfg "CONFIG_DEBUG_BUGVERBOSE=n"

          echo "âœ… Kernel configured"
          echo "::endgroup::"

      - name: ðŸ”¨ Build Kernel
        env:
          PYTHONWARNINGS: "ignore:invalid escape sequence"
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Build kernel"
          cd "$GITHUB_WORKSPACE/OP15/kernel_platform/common"

          : > .scmversion

          export PYTHONWARNINGS="${PYTHONWARNINGS}"
          export LLVM=1 LLVM_IAS=1
          export ARCH=arm64 SUBARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export LD=ld.lld HOSTLD=ld.lld AR=llvm-ar NM=llvm-nm
          export OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump STRIP=llvm-strip

          KERNEL_PATH="${GITHUB_WORKSPACE}/OP15/kernel_platform"
          BASE_PATH="/usr/lib/ccache:${CLANG_BIN_PATH}:${KERNEL_PATH}/prebuilts/kernel-build-tools/linux-x86/bin/:${KERNEL_PATH}/prebuilts/kernel-build-tools/linux_musl-x86/bin/"

          if [ -n "${RUSTC_BIN_PATH:-}" ]; then
            export PATH="${BASE_PATH}:${RUSTC_BIN_PATH}:${PATH}"
            export RUSTC="${RUSTC_BIN_PATH}/rustc"
            export LIBCLANG_PATH="${CLANG_BIN_PATH}/../lib"
            export BINDGEN="bindgen"
          else
            export PATH="${BASE_PATH}:${PATH}"
          fi

          if [ "${{ inputs.clean_build }}" = "true" ]; then
            export CCACHE_DISABLE=1
          else
            export CC="ccache clang"
            export CXX="ccache clang++"
            export HOSTCC="ccache clang"
            export HOSTCXX="ccache clang++"
            export CCACHE_DIR="$HOME/.ccache"
            export CCACHE_BASEDIR="${GITHUB_WORKSPACE}"
            export CCACHE_COMPILERCHECK="content"
            export CCACHE_NOHASHDIR="true"
          fi

          WORKSPACE="${GITHUB_WORKSPACE}"
          MAP="-fdebug-prefix-map=${WORKSPACE}=."
          MPMAP="-fmacro-prefix-map=${WORKSPACE}=."
          FPMAP="-ffile-prefix-map=${WORKSPACE}=."

          if [ "${{ inputs.optimize_level }}" = "O3" ]; then OPT_FLAG="-O3"; else OPT_FLAG="-O2"; fi

          export KCFLAGS="${KCFLAGS:-} $MAP $MPMAP $FPMAP -no-canonical-prefixes -fdiagnostics-color=never -Qunused-arguments -Wno-unused-command-line-argument -D__ANDROID_COMMON_KERNEL__ -Wno-error -pipe -fno-stack-protector $OPT_FLAG"
          export KCPPFLAGS="${KCPPFLAGS:-} $MAP $MPMAP $FPMAP -DCONFIG_OPTIMIZE_INLINING"

          export SOURCE_DATE_EPOCH="$(git log -1 --format=%ct 2>/dev/null || date +%s)"
          export KBUILD_BUILD_TIMESTAMP="$(date -u)"
          export KBUILD_BUILD_USER="${BUILD_USER}"
          export KBUILD_BUILD_HOST="${BUILD_HOST}"
          export KBUILD_BUILD_VERSION=1

          OUT=out
          mkdir -p "$OUT"
          make O="$OUT" gki_defconfig

          LOCAL_LOCALVERSION="-${OP_ANDROID_VERSION}-${OP_UNAME}"
          scripts/config --file "$OUT/.config" --set-str LOCALVERSION "${LOCAL_LOCALVERSION}"
          scripts/config --file "$OUT/.config" -d LOCALVERSION_AUTO || true
          sed -i 's/scm_version="$(scm_version --short)"/scm_version=""/' scripts/setlocalversion

          if [ "${{ inputs.optimize_level }}" = "O3" ]; then
            scripts/config --file "$OUT/.config" -d CC_OPTIMIZE_FOR_PERFORMANCE
            scripts/config --file "$OUT/.config" -e CC_OPTIMIZE_FOR_PERFORMANCE_O3
          else
            scripts/config --file "$OUT/.config" -e CC_OPTIMIZE_FOR_PERFORMANCE
            scripts/config --file "$OUT/.config" -d CC_OPTIMIZE_FOR_PERFORMANCE_O3
          fi

          scripts/config --file "$OUT/.config" -e LTO_CLANG
          scripts/config --file "$OUT/.config" -e LTO_CLANG_NONE
          scripts/config --file "$OUT/.config" -d LTO_CLANG_THIN
          scripts/config --file "$OUT/.config" -d LTO_CLANG_FULL

          make O="$OUT" olddefconfig

          BUILD_START=$(date +%s)
          set -o pipefail
          make -j"$(nproc --all)" O="$OUT" 2>&1 | tee build.log
          BUILD_END=$(date +%s)

          BUILD_TIME=$((BUILD_END - BUILD_START))
          echo "BUILD_TIME=$BUILD_TIME" >> "$GITHUB_ENV"

          IMG="$OUT/arch/arm64/boot/Image"
          if [ ! -f "$IMG" ]; then
            echo "::error::Build failed - Image not found"
            tail -n 120 build.log
            exit 1
          fi

          echo "IMAGE_SHA256=$(sha256sum "$IMG" | awk '{print $1}')" >> "$GITHUB_ENV"
          echo "KERNEL_UNAME=$(strings "$IMG" | grep -E 'Linux version.*#' | tail -n1)" >> "$GITHUB_ENV"
          echo "WARNINGS_COUNT=$(grep -ciE '\bwarning:' build.log || echo 0)" >> "$GITHUB_ENV"

          echo "::endgroup::"

      - name: ðŸ“¦ Create Flashable ZIP
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Create flashable ZIP"

          IMAGE_PATH="$GITHUB_WORKSPACE/OP15/kernel_platform/common/out/arch/arm64/boot/Image"
          cp "$IMAGE_PATH" "$GITHUB_WORKSPACE/AnyKernel3/Image"
          cd "$GITHUB_WORKSPACE/AnyKernel3"

          : "${KSUVER:=unknown}"
          : "${SUSVER:=nosusfs}"

          ZIP_NAME="AK3_${OP_MODEL}_${OP_OS_VERSION}_${KERNEL_FULL_VER}_SukiSU_${KSUVER}_SuSFS_${SUSVER}.zip"

          zip -r9 "$ZIP_NAME" ./* -x "*.git*" -x "$ZIP_NAME" -x "README.md"

          mkdir -p "$GITHUB_WORKSPACE/artifacts"
          mv "$ZIP_NAME" "$GITHUB_WORKSPACE/artifacts/"

          echo "ZIP_NAME=$ZIP_NAME" >> "$GITHUB_ENV"
          echo "ZIP_SIZE=$(stat -c%s "$GITHUB_WORKSPACE/artifacts/$ZIP_NAME")" >> "$GITHUB_ENV"
          echo "ZIP_SHA256=$(sha256sum "$GITHUB_WORKSPACE/artifacts/$ZIP_NAME" | awk '{print $1}')" >> "$GITHUB_ENV"

          echo "::endgroup::"

      - name: ðŸ“¤ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: kernel-SukiSU-OP15-${{ env.OP_OS_VERSION }}
          path: artifacts/
          retention-days: 7
          compression-level: 0

      - name: ðŸ“Š Build Summary
        shell: bash
        run: |
          set -euo pipefail

          KSU_REPO_URL="https://github.com/SukiSU-Ultra/SukiSU-Ultra"

          cat >> "$GITHUB_STEP_SUMMARY" <<EOF
          # ðŸŽ‰ OnePlus 15 Kernel Build Complete (SukiSU)

          ## ðŸ“± Device Information
          | Property | Value |
          |----------|-------|
          | **Model** | ${OP_MODEL} (${OP_SOC}) |
          | **OS Version** | ${OP_OS_VERSION} |
          | **Kernel Version** | ${KERNEL_FULL_VER} |
          | **Kernel Uname** | \`${KERNEL_UNAME}\` |

          ## ðŸ”§ Build Configuration
          | Component | Version/Setting |
          |-----------|----------------|
          | **SukiSU** | v${KSUVER} |
          | **SUSFS** | ${SUSVER} |
          | **SUSFS Branch** | ${SUSFS_BRANCH_NAME:-unknown} |
          | **Optimization** | ${{ inputs.optimize_level }} |
          | **LTO** | ${OP_LTO} |
          | **Clean Build** | ${{ inputs.clean_build && 'âœ… Yes' || 'âŒ No' }} |
          | **Build Time** | ${BUILD_TIME}s |
          | **Warnings** | ${WARNINGS_COUNT} |

          ## ðŸ“¦ Build Output
          | File | Details |
          |------|---------|
          | **ZIP Name** | \`${ZIP_NAME}\` |
          | **ZIP SHA256** | \`${ZIP_SHA256}\` |
          | **Image SHA256** | \`${IMAGE_SHA256}\` |

          ## ðŸ”— Source Commits
          | Component | Commit |
          |-----------|--------|
          | **SukiSU** | [\`${KSU_COMMIT_SHA:0:8}\`](${KSU_REPO_URL}/commit/${KSU_COMMIT_SHA}) |
          | **SUSFS** | [\`${SUSFS_COMMIT_SHA:0:8}\`](https://gitlab.com/simonpunk/susfs4ksu/-/commit/${SUSFS_COMMIT_SHA}) |
          EOF

      - name: ðŸ§¹ Cleanup
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Cleanup"
          sudo rm -rf "$GITHUB_WORKSPACE/OP15/kernel_platform/common/out" || true
          sudo rm -rf "$GITHUB_WORKSPACE/OP15/.repo" || true
          sudo rm -rf /tmp/* || true
          df -h /
          echo "::endgroup::"
