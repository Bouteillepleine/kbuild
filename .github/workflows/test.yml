name: Build Oneplus 15 Kernels

on:
  workflow_dispatch:
    inputs:
      FILE:
        type: choice
        description: "Config profile"
        required: true
        default: android16-6.12-2025-06
        options:
          - android16-6.12-2025-06
    
      KSU_SOURCE:
        type: choice
        description: "ReSukiSU / SukiSU setup source"
        required: true
        default: RESUKISU
        options:
          - RESUKISU
          - SUKISU_ULTRA

      SUSFS_META:
        type: string
        description: "Pin/rollback SUSFS to a specific commit hash (leave empty to disable SUSFS)"
        required: false
        default: ""

      SUSFS_DEV:
        type: boolean
        description: "Use SUSFS dev branch?"
        required: false
        default: false      

      BUILD_TIME:
        type: string
        description: "Custom build time (enter 'F' to use current UTC time)"
        required: false
        default: "Thu Dec 11 04:17:27 UTC 2025"

      KSU_META:
        type: string
        description: "branch (required) / custom tag (optional) / commit hash (optional)"
        required: false
        default: "builtin/‚ö°Ultra‚ö°/"

      SUFFIX:
        type: string
        description: "Custom kernel suffix (leave empty to use a random suffix)"
        required: false
        default: "5-ga5f232d1ead0-ab14083253-4k"

      SUBLEVEL:
        type: string
        description: "Custom kernel SUBLEVEL override"
        required: false
        default: ""

      BUILD_NOCCACHE:
        type: boolean
        description: "Disable ccache for this build?"
        required: true
        default: false

      clean_build:
        type: boolean
        description: "Perform clean build"
        required: false
        default: false

jobs:
  build:
    name: >-
      Build ${{ github.event.inputs.FILE }}
      ${{ github.event.inputs.SUFFIX != '' && format('({0})', github.event.inputs.SUFFIX) || '' }}
    runs-on: ubuntu-latest

    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      CCACHE_MAXSIZE: 8G

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Environment Variables
        shell: bash
        run: |
          set -euo pipefail
          echo "CPU=sm8650" >> "$GITHUB_ENV"
          echo "CPUD=pineapple" >> "$GITHUB_ENV"
          echo "ANDROID_VERSION=16" >> "$GITHUB_ENV"
          echo "BUILD_METHOD=bazel" >> "$GITHUB_ENV"
          echo "CONFIG=$GITHUB_WORKSPACE/kernel_workspace" >> "$GITHUB_ENV"
          echo "OP_MODEL=OnePlus 15" >> "$GITHUB_ENV"
          echo "OP_SOC=Snapdragon 8 Elite" >> "$GITHUB_ENV"
          echo "OP_OS_VERSION=Android 16" >> "$GITHUB_ENV"
          echo "OP_LTO=thin" >> "$GITHUB_ENV"
          echo "BUILD_START_TIME=$(date +%s)" >> "$GITHUB_ENV"

      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: "true"
          remove-android: "true"
          remove-haskell: "true"
          remove-codeql: "true"

      - name: Debug Show Selected Inputs
        shell: bash
        run: |
          set -euo pipefail
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üìã Build Configuration"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üì¶ Config Profile: ${{ github.event.inputs.FILE }}"
          echo "üîß KSU Source: ${{ github.event.inputs.KSU_SOURCE }}"
          echo "üîê SUSFS Commit: ${{ github.event.inputs.SUSFS_META || 'Disabled' }}"
          echo "üß™ SUSFS Dev: ${{ github.event.inputs.SUSFS_DEV }}"
          echo "üìù KSU Meta: ${{ github.event.inputs.KSU_META }}"
          echo "üïê Build Time: ${{ github.event.inputs.BUILD_TIME }}"
          echo "üè∑Ô∏è  Suffix: ${{ github.event.inputs.SUFFIX || 'Random' }}"
          echo "üî¢ SUBLEVEL: ${{ github.event.inputs.SUBLEVEL || 'Default' }}"
          echo "üö´ No ccache: ${{ github.event.inputs.BUILD_NOCCACHE }}"
          echo "üßπ Clean build: ${{ github.event.inputs.clean_build }}"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

      - name: Check Disk Space
        run: df -h

      - name: Create and Enable 3G Swap
        shell: bash
        run: |
          set -euo pipefail
          sudo swapoff -a || true
          sudo fallocate -l 3G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

      - name: Set Cache Environment
        if: github.event.inputs.BUILD_NOCCACHE == 'false'
        shell: bash
        run: |
          set -euo pipefail
          echo "CCACHE_DIR=$HOME/.ccache_${{ github.event.inputs.FILE }}" >> "$GITHUB_ENV"
          mkdir -p "$HOME/.ccache_${{ github.event.inputs.FILE }}"

      - name: Configure Git
        shell: bash
        run: |
          set -euo pipefail
          git config --global user.name "OnePlus Builder"
          git config --global user.email "builder@oneplus.com"

      - name: Install Dependencies + APT Cache
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: python3 git curl ccache libelf-dev build-essential flex bison libssl-dev libncurses-dev liblz4-tool zlib1g-dev libxml2-utils rsync unzip gawk dos2unix
          execute_install_scripts: true

      - name: Restore Ccache
        if: github.event.inputs.BUILD_NOCCACHE == 'false'
        uses: actions/cache@v3
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-${{ runner.os }}-${{ github.ref_name }}-${{ github.event.inputs.FILE }}-${{ env.BUILD_METHOD }}-16

      - name: Initialize Ccache
        if: github.event.inputs.BUILD_NOCCACHE == 'false'
        shell: bash
        run: |
          set -euo pipefail
          INIT_FLAG="${{ env.CCACHE_DIR }}/.ccache_initialized"
          if command -v ccache >/dev/null 2>&1; then
            if [ ! -f "$INIT_FLAG" ]; then
              mkdir -p "${{ env.CCACHE_DIR }}"
              ccache -M "${{ env.CCACHE_MAXSIZE }}"
              touch "$INIT_FLAG"
              echo "‚úÖ ccache initialized"
            else
              echo "‚úÖ ccache already initialized"
            fi
            ccache -s || true
          fi

      - name: Install Repo Tool
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL https://storage.googleapis.com/git-repo-downloads/repo > ~/repo
          chmod a+x ~/repo
          sudo mv ~/repo /usr/local/bin/repo

      - name: Initialize Repo and Sync
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p kernel_workspace
          cd kernel_workspace

          FORMATTED_BRANCH="${{ github.event.inputs.FILE }}"

          repo init -u https://android.googlesource.com/kernel/manifest \
            -b "common-${FORMATTED_BRANCH}" \
            --depth=1 --no-clone-bundle --no-tags

          repo sync -c -j"$(nproc)" --no-clone-bundle --no-tags --force-sync

          for dir in common; do
            if [ -e "$dir/BUILD.bazel" ]; then
              sed -i '/^[[:space:]]*"protected_exports_list"[[:space:]]*:[[:space:]]*"android\/abi_gki_protected_module_names",$/d' "$dir/BUILD.bazel"
            fi
            rm -f "$dir/android/abi_gki_protected_exports_"* 2>/dev/null || true
          done

      - name: Kernel Version Handling
        shell: bash
        run: |
          set -euo pipefail
          cd kernel_workspace

          BRANCH=""
          for f in ./common/build.config.constants ./common/build.config.common; do
            if [ -f "$f" ]; then
              BRANCH="$(grep -m1 '^BRANCH=' "$f" | cut -d= -f2 || true)"
              [ -n "$BRANCH" ] && break
            fi
          done

          if [ -n "$BRANCH" ]; then
            echo "KANDROID_VERSION=${BRANCH%-*}" >> "$GITHUB_ENV"
            echo "KERNEL_VERSION=${BRANCH#*-}" >> "$GITHUB_ENV"
          fi

          ORIG_VERSION="$(awk '/^VERSION =/ {v=$3} /^PATCHLEVEL =/ {p=$3} /^SUBLEVEL =/ {s=$3} END {print v"."p"."s}' ./common/Makefile)"
          SUBLEVEL_INPUT="${{ github.event.inputs.SUBLEVEL }}"
          if [ -n "$SUBLEVEL_INPUT" ]; then
            echo "üîß Overriding SUBLEVEL to $SUBLEVEL_INPUT"
            sed -i "s/^\(SUBLEVEL[[:space:]]*=[[:space:]]*\).*/\1$SUBLEVEL_INPUT/" ./common/Makefile
          fi
          NEW_VERSION="$(awk '/^VERSION =/ {v=$3} /^PATCHLEVEL =/ {p=$3} /^SUBLEVEL =/ {s=$3} END {print v"."p"."s}' ./common/Makefile)"
          echo "TKERNEL_VERSION=$NEW_VERSION" >> "$GITHUB_ENV"
          echo "KERNEL_FULL_VER=$NEW_VERSION" >> "$GITHUB_ENV"
          
          # Extract version components for later use
          KV1=$(echo "$NEW_VERSION" | cut -d. -f1)
          KV2=$(echo "$NEW_VERSION" | cut -d. -f2)
          KV3=$(echo "$NEW_VERSION" | cut -d. -f3)
          echo "KV1=$KV1" >> "$GITHUB_ENV"
          echo "KV2=$KV2" >> "$GITHUB_ENV"
          echo "KV3=$KV3" >> "$GITHUB_ENV"
          
          echo "‚úÖ Kernel version: $NEW_VERSION (${KV1}.${KV2}.${KV3})"

      - name: Custom Kernel Suffix (if set)
        if: github.event.inputs.SUFFIX != ''
        shell: bash
        run: |
          set -euo pipefail
          cd kernel_workspace
          SUFFIX="${{ github.event.inputs.SUFFIX }}"
          KANDROID_VERSION="${{ env.KANDROID_VERSION }}"

          for path in \
            common/scripts/setlocalversion \
            msm-kernel/scripts/setlocalversion \
            external/dtc/scripts/setlocalversion; do
            [ -f "$path" ] || continue
            echo "üîß Modifying: $path"
            sed -i 's/ -dirty//g' "$path"
            sed -i '$i res=$(echo "$res" | sed '\''s/-dirty//g'\'')' "$path"

            if grep -q 'KERNELVERSION.*scm_version' "$path"; then
              sed -i "s|echo \"\${KERNELVERSION}.*scm_version}\"|echo \"\${KERNELVERSION}-${KANDROID_VERSION}-${SUFFIX}\"|" "$path"
            elif grep -q 'echo "\$res"' "$path"; then
              tac "$path" | sed "0,/echo \"\\\$res\"/s//res=\\\$(echo \\\$res | cut -d- -f1-2)-${SUFFIX}; echo \"\\\$res\";/" | tac > "$path.tmp" && mv "$path.tmp" "$path"
            else
              echo "echo \"\$res-${SUFFIX}\"" >> "$path"
            fi
            chmod +x "$path"
          done
          echo "‚úÖ Custom suffix applied: $SUFFIX"

      - name: Custom Kernel Random Suffix (if empty)
        if: github.event.inputs.SUFFIX == ''
        shell: bash
        run: |
          set -euo pipefail
          cd kernel_workspace
          KANDROID_VERSION="${{ env.KANDROID_VERSION }}"

          RANDOM_DIGIT="$(od -An -N1 -tu1 < /dev/urandom | tr -d '[:space:]' | awk '{print $1 % 11}')"
          RANDOM_HASH="$(od -An -N7 -tx1 /dev/urandom | tr -d ' \n')"
          RANDOM_SUFFIX="${RANDOM_DIGIT}-o-g${RANDOM_HASH}"
          echo "üé≤ Generated random suffix: $RANDOM_SUFFIX"

          for path in \
            common/scripts/setlocalversion \
            msm-kernel/scripts/setlocalversion \
            external/dtc/scripts/setlocalversion; do
            [ -f "$path" ] || continue
            echo "üîß Modifying: $path"
            
            sed -i 's/ -dirty//g' "$path"
            sed -i '$i res=$(echo "$res" | sed '\''s/-dirty//g'\'')' "$path"

            if grep -q 'KERNELVERSION.*scm_version' "$path"; then
              sed -i "s|echo \"\${KERNELVERSION}.*scm_version}\"|echo \"\${KERNELVERSION}-${KANDROID_VERSION}-${RANDOM_SUFFIX}\"|" "$path"
            elif grep -q 'echo "\$res"' "$path"; then
              tac "$path" | sed "0,/echo \"\\\$res\"/s//res=\\\$(echo \\\$res | cut -d- -f1-2)-${RANDOM_SUFFIX}; echo \"\\\$res\";/" | tac > "$path.tmp" && mv "$path.tmp" "$path"
            else
              echo "echo \"\$res-${RANDOM_SUFFIX}\"" >> "$path"
            fi
            chmod +x "$path"
          done

          if [ -d "common/.git" ]; then
            echo "üìù Committing changes in common/"
            cd common
            git add scripts/setlocalversion 2>/dev/null || true
            git diff --cached --quiet || git commit -m "Apply random suffix & remove -dirty" || true
            cd ..
          fi
          
          echo "‚úÖ Random suffix applied: $RANDOM_SUFFIX"

      - name: Add KernelSU (ReSukiSU or SukiSU Ultra)
        shell: bash
        run: |
          set -euo pipefail
          cd kernel_workspace

          KSU_META="${{ github.event.inputs.KSU_META }}"
          if [[ "$(grep -o '/' <<< "$KSU_META" | wc -l)" -lt 2 ]]; then
            echo "::error::KSU_META must contain at least two '/' separators: branch/custom_tag/commit_hash"
            exit 10
          fi

          IFS='/' read -r BRANCH_NAME CUSTOM_TAG MANUAL_HASH <<< "$KSU_META"
          echo "üîß Branch: $BRANCH_NAME"
          echo "üè∑Ô∏è  Tag: ${CUSTOM_TAG:-none}"
          echo "üìå Hash: ${MANUAL_HASH:-none}"
          echo "üì¶ Source: ${{ github.event.inputs.KSU_SOURCE }}"

          if [ "${{ github.event.inputs.KSU_SOURCE }}" = "RESUKISU" ]; then
            echo "üì• Installing ReSukiSU..."
            curl -LSs "https://raw.githubusercontent.com/ReSukiSU/ReSukiSU/main/kernel/setup.sh" | bash -s builtin
          else
            echo "üì• Installing SukiSU Ultra..."
            curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s "$BRANCH_NAME"
          fi

          cd ./KernelSU

          if [[ -n "$MANUAL_HASH" ]]; then
            git fetch origin "$BRANCH_NAME" --depth=50 || true
            git checkout "$MANUAL_HASH"
            SHORT_HASH="${MANUAL_HASH:0:8}"
          fi

          KSU_API_VERSION="$(curl -fsSL "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/$BRANCH_NAME/kernel/Kbuild" 2>/dev/null | \
            grep -m1 "KSU_VERSION_API :=" | awk -F'= ' '{print $2}' | tr -d '[:space:]' || true)"
          if [[ -z "$KSU_API_VERSION" ]]; then
            KSU_API_VERSION="3.1.7"
          fi
          echo "KSU_API_VERSION=$KSU_API_VERSION" >> "$GITHUB_ENV"

          GIT_HASH="$(git rev-parse --short HEAD)"
          KSU_COMMIT_SHA="$(git rev-parse HEAD)"
          echo "KSU_COMMIT_SHA=$KSU_COMMIT_SHA" >> "$GITHUB_ENV"

          USE_HASH="$GIT_HASH"
          if [[ -n "${MANUAL_HASH:-}" ]]; then
            USE_HASH="$SHORT_HASH"
          fi

          if [[ -z "$CUSTOM_TAG" ]]; then
            VERSION_FULL="v$KSU_API_VERSION-$USE_HASH@$BRANCH_NAME"
          else
            VERSION_FULL="v$KSU_API_VERSION-$CUSTOM_TAG@$BRANCH_NAME[$USE_HASH]"
          fi

          sed -i '/define get_ksu_version_full/,/endef/d' kernel/Kbuild || true
          sed -i '/KSU_VERSION_API :=/d' kernel/Kbuild || true
          sed -i '/KSU_VERSION_FULL :=/d' kernel/Kbuild || true

          VERSION_DEFINITIONS="define get_ksu_version_full
          $VERSION_FULL
          endef
          
          KSU_VERSION_API := $KSU_API_VERSION
          KSU_VERSION_FULL := $VERSION_FULL"

          awk -v def="$VERSION_DEFINITIONS" '
            /REPO_OWNER :=/ {print; print def; inserted=1; next}
            1
            END {if (!inserted) print def}
          ' kernel/Kbuild > kernel/Kbuild.tmp && mv kernel/Kbuild.tmp kernel/Kbuild

          KSU_VERSION="$(expr $(git rev-list --count main 2>/dev/null || echo 13000) + 37185)"
          echo "KSUVER=$KSU_VERSION" >> "$GITHUB_ENV"
          echo "‚úÖ KernelSU version: $VERSION_FULL ($KSU_VERSION)"

      - name: Clone Patch Repositories
        shell: bash
        run: |
          set -euo pipefail
          cd "$GITHUB_WORKSPACE"
          
          echo "üì• Cloning patch repositories..."
          
          # Clone Action-Build (for various patches)
          if [ ! -d "Action-Build" ]; then
            git clone https://github.com/Numbersf/Action-Build.git --depth=1
            echo "‚úÖ Action-Build cloned"
          fi

      - name: Apply SUSFS & Advanced Patches
        shell: bash
        run: |
          set -euo pipefail
          cd kernel_workspace

          # Clone SUSFS
          SUSFS_BRANCH="gki-${{ env.KANDROID_VERSION }}-${{ env.KERNEL_VERSION }}"
          if [ "${{ github.event.inputs.SUSFS_DEV }}" = "true" ]; then
            SUSFS_BRANCH="${SUSFS_BRANCH}-dev"
          fi
          
          echo "üì• Cloning SUSFS (branch: $SUSFS_BRANCH)..."
          git clone https://gitlab.com/simonpunk/susfs4ksu.git -b "$SUSFS_BRANCH" --depth=1
          
          cd susfs4ksu
          SUSFS_META="${{ github.event.inputs.SUSFS_META }}"
          if [ -n "$SUSFS_META" ]; then
            echo "üìå Checking out SUSFS commit: $SUSFS_META"
            git checkout "$SUSFS_META" || echo "‚ö†Ô∏è  Using latest upstream SUSFS"
          fi

          SUSFS_COMMIT_SHA="$(git rev-parse HEAD)"
          SUSFS_BRANCH_NAME="$(git rev-parse --abbrev-ref HEAD)"
          echo "SUSFS_COMMIT_SHA=$SUSFS_COMMIT_SHA" >> "$GITHUB_ENV"
          echo "SUSFS_BRANCH_NAME=$SUSFS_BRANCH_NAME" >> "$GITHUB_ENV"
          SUSVER="$(git describe --tags --always)"
          echo "SUSVER=$SUSVER" >> "$GITHUB_ENV"
          cd ..

          # Copy SUSFS files
          echo "üìã Copying SUSFS files..."
          PATCH_FILE="50_add_susfs_in_gki-${{ env.KANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch"
          cp "./susfs4ksu/kernel_patches/$PATCH_FILE" ./common/ || true
          cp ./susfs4ksu/kernel_patches/fs/* ./common/fs/ 2>/dev/null || true
          cp ./susfs4ksu/kernel_patches/include/linux/* ./common/include/linux/ 2>/dev/null || true

          cd ./common
          GKI_V="${{ env.KANDROID_VERSION }}-${{ env.KERNEL_VERSION }}"
          SUBLEVEL=$(grep '^SUBLEVEL *=' Makefile | head -n1 | cut -d= -f2 | tr -d ' ')

          # Fix for 5.15 legacy C library issues
          if [ "$GKI_V" = "android13-5.15" ] && [ "$SUBLEVEL" -lt 123 ]; then
            echo "üîß Applying fix for 5.15.0~5.15.123 legacy C library bugs..."
            cp ../../Action-Build/patches/fix_5.15.legacy ./fix_5.15.legacy.patch
            patch -p1 < fix_5.15.legacy.patch || true
            echo "‚úÖ fix_5.15 patch applied"
          fi

          # Fix for 6.6.0~6.6.30 missing TrustyOS
          if [ "${{ env.KV1 }}" = "6" ] && [ "${{ env.KV2 }}" = "6" ] && [ "${{ env.KV3 }}" -le 30 ]; then
            echo "üîç Checking for TrustyOS in manifest..."
            TRUSTY_EXISTS="false"
            if [ -f "$GITHUB_WORKSPACE/.repo/manifests_fallback/${{ github.event.inputs.FILE }}.xml" ]; then
              if grep -q 'common-modules/trusty' "$GITHUB_WORKSPACE/.repo/manifests_fallback/${{ github.event.inputs.FILE }}.xml"; then
                TRUSTY_EXISTS="true"
              fi
            fi
            
            if [ "$TRUSTY_EXISTS" = "false" ]; then
              echo "üîß Fixing SUSFS patch for missing TrustyOS..."
              sed -i 's/-32,12 +32,38/-32,11 +32,37/g' "$PATCH_FILE"
              sed -i '/#include <trace\/hooks\/fs.h>/d' "$PATCH_FILE"
              echo "‚úÖ TrustyOS fix applied"
            fi
          fi

          # Fake patch to fix potential failures
          fake_patched=0
          if [ "$GKI_V" = "android15-6.6" ]; then
            if ! grep -qxF $'\tunsigned int nr_subpages = __PAGE_SIZE / PAGE_SIZE;' ./fs/proc/task_mmu.c; then
              echo "üîß Applying fake patch for android15-6.6..."
              sed -i -e '/int ret = 0, copied = 0;/a \\tunsigned int nr_subpages \= __PAGE_SIZE \/ PAGE_SIZE;' \
                     -e '/int ret = 0, copied = 0;/a \\tpagemap_entry_t \*res = NULL;' ./fs/proc/task_mmu.c
              fake_patched=1
            fi
          fi
          
          if [ "$GKI_V" = "android12-5.10" ] || [ "$GKI_V" = "android13-5.15" ] || [ "$GKI_V" = "android14-6.1" ]; then
            if ! grep -qxF $'\tif (!vma_pages(vma))' ./fs/proc/task_mmu.c; then
              echo "üîß Applying fake patch for $GKI_V..."
              fake_patched=1
            fi
          fi

          # Apply SUSFS patch
          echo "üîß Applying SUSFS patch..."
          patch -p1 < "$PATCH_FILE" || true
          echo "‚úÖ SUSFS patch applied"

          # Revert fake patches
          if [ "$fake_patched" = 1 ]; then
            echo "üîÑ Reverting fake patches..."
            if [ "$GKI_V" = "android15-6.6" ]; then
              if grep -qxF $'\tunsigned int nr_subpages = __PAGE_SIZE / PAGE_SIZE;' ./fs/proc/task_mmu.c; then
                sed -i -e '/unsigned int nr_subpages \= __PAGE_SIZE \/ PAGE_SIZE;/d' \
                       -e '/pagemap_entry_t \*res = NULL;/d' ./fs/proc/task_mmu.c
              fi
            fi
            if [ "$GKI_V" = "android12-5.10" ] || [ "$GKI_V" = "android13-5.15" ] || [ "$GKI_V" = "android14-6.1" ]; then
              if grep -qxF $'\t\tgoto show_pad;' ./fs/proc/task_mmu.c; then
                sed -i -e 's/goto show_pad;/return 0;/' ./fs/proc/task_mmu.c
              fi
            fi
            echo "‚úÖ Fake patches reverted"
          fi
            
      - name: Add Configuration Settings
        shell: bash
        run: |
          set -euo pipefail
          cd kernel_workspace/common
          CONFIG_FILE=./arch/arm64/configs/gki_defconfig

          set_cfg() { sed -i "/^${1}=/{d}" "$CONFIG_FILE"; echo "${1}=${2}" >> "$CONFIG_FILE"; }

          echo "‚öôÔ∏è  Configuring kernel options..."

          # KSU
          set_cfg CONFIG_KSU y

          # KPM (always enabled)
          set_cfg CONFIG_KPM y

          # SUSFS (only if SUSFS_META provided)
          if [ -n "${{ github.event.inputs.SUSFS_META }}" ]; then
            echo "  ‚úÖ Enabling SUSFS"
            set_cfg CONFIG_KSU_SUSFS y
            set_cfg CONFIG_KSU_SUSFS_SUS_PATH y
            set_cfg CONFIG_KSU_SUSFS_SUS_MAP y
            set_cfg CONFIG_KSU_SUSFS_SUS_MOUNT y
            set_cfg CONFIG_KSU_SUSFS_SUS_KSTAT y
            set_cfg CONFIG_KSU_SUSFS_SPOOF_UNAME y
            set_cfg CONFIG_KSU_SUSFS_ENABLE_LOG y
            set_cfg CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS y
            set_cfg CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG y
            set_cfg CONFIG_KSU_SUSFS_OPEN_REDIRECT y
          else
            set_cfg CONFIG_KSU_SUSFS n
          fi

          # TMPFS
          set_cfg CONFIG_TMPFS_XATTR y
          set_cfg CONFIG_TMPFS_POSIX_ACL y

          # BBR & ECN (always enabled)
          echo "  ‚úÖ Enabling BBR & ECN"
          set_cfg CONFIG_TCP_CONG_ADVANCED y
          set_cfg CONFIG_TCP_CONG_BBR y
          set_cfg CONFIG_NET_SCH_FQ y
          set_cfg CONFIG_TCP_CONG_BIC n
          set_cfg CONFIG_TCP_CONG_WESTWOOD n
          set_cfg CONFIG_TCP_CONG_HTCP n
          set_cfg CONFIG_IP_ECN y
          set_cfg CONFIG_TCP_ECN y
          set_cfg CONFIG_IPV6_ECN y
          set_cfg CONFIG_IP_NF_TARGET_ECN y

          # LSM marker (always enabled)
          echo "  ‚úÖ Enabling LSM (Baseband Guard)"
          set_cfg CONFIG_BBG y

          # IPSET & IPv6_NAT (always enabled)
          echo "  ‚úÖ Enabling IPSET & IPv6 NAT"
          set_cfg CONFIG_BPF_STREAM_PARSER y
          set_cfg CONFIG_NETFILTER_XT_MATCH_ADDRTYPE y
          set_cfg CONFIG_NETFILTER_XT_SET y
          set_cfg CONFIG_IP_SET y
          set_cfg CONFIG_IP_SET_MAX 65534
          set_cfg CONFIG_IP_SET_BITMAP_IP y
          set_cfg CONFIG_IP_SET_BITMAP_IPMAC y
          set_cfg CONFIG_IP_SET_BITMAP_PORT y
          set_cfg CONFIG_IP_SET_HASH_IP y
          set_cfg CONFIG_IP_SET_HASH_IPMARK y
          set_cfg CONFIG_IP_SET_HASH_IPPORT y
          set_cfg CONFIG_IP_SET_HASH_IPPORTIP y
          set_cfg CONFIG_IP_SET_HASH_IPPORTNET y
          set_cfg CONFIG_IP_SET_HASH_IPMAC y
          set_cfg CONFIG_IP_SET_HASH_MAC y
          set_cfg CONFIG_IP_SET_HASH_NETPORTNET y
          set_cfg CONFIG_IP_SET_HASH_NET y
          set_cfg CONFIG_IP_SET_HASH_NETNET y
          set_cfg CONFIG_IP_SET_HASH_NETPORT y
          set_cfg CONFIG_IP_SET_HASH_NETIFACE y
          set_cfg CONFIG_IP_SET_LIST_SET y
          set_cfg CONFIG_IP6_NF_NAT y
          set_cfg CONFIG_IP6_NF_TARGET_MASQUERADE y

          # Remove defconfig check
          sed -i 's/check_defconfig//g' ./build.config.gki || true
          echo "‚úÖ Configuration complete"

      - name: Apply LSM Baseband Guard
        shell: bash
        run: |
          set -euo pipefail
          cd kernel_workspace/common
          echo "üîß Applying LSM Baseband Guard..."
          curl -LSs https://raw.githubusercontent.com/vc-teahouse/Baseband-guard/main/setup.sh | bash
          sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/selinux/selinux,baseband_guard/ } }' ./security/Kconfig || true
          echo "‚úÖ LSM Baseband Guard applied"

      - name: Apply Unicode Bypass Fix
        shell: bash
        run: |
          set -euo pipefail
          PATCH_DIR="${GITHUB_WORKSPACE}/Action-Build/patches"
          cd kernel_workspace/common
          
          KV1="${{ env.KV1 }}"
          echo "üîß Applying Unicode bypass fix (kernel $KV1.x)..."
          
          if [ "$KV1" -lt 6 ]; then
            patch -p1 --forward < "${PATCH_DIR}/unicode_bypass_fix_6.1-.patch" || true
          else
            patch -p1 --forward < "${PATCH_DIR}/unicode_bypass_fix_6.1+.patch" || true
          fi
          echo "‚úÖ Unicode bypass fix applied"

      - name: Fix IPv6 NAT Error
        shell: bash
        run: |
          set -euo pipefail
          PATCH_DIR="${GITHUB_WORKSPACE}/Action-Build/patches"
          cd kernel_workspace/common
          
          if [[ "${{ env.CPU }}" == sm* ]]; then
            echo "üîß Applying IPv6 NAT fix for Snapdragon..."
            patch -p1 -F 3 < "${PATCH_DIR}/IPv6_NAT_FIX.patch" || true
            echo "‚úÖ IPv6 NAT fix applied"
          else
            echo "‚è≠Ô∏è  Skipping IPv6 NAT fix (not Snapdragon)"
          fi

      - name: Custom BUILD_TIME
        shell: bash
        run: |
          set -euo pipefail
          INPUT_TIME="${{ github.event.inputs.BUILD_TIME }}"
          
          # D√©terminer la date √† utiliser
          if [[ -n "$INPUT_TIME" && "$INPUT_TIME" != "F" && "$INPUT_TIME" != "f" ]]; then
            DATESTR="$INPUT_TIME"
            echo "üìÖ Using custom build time: $DATESTR"
          else
            DATESTR="$(TZ='UTC' date +'%a %b %d %T %Z %Y')"
            echo "üìÖ Using current UTC time: $DATESTR"
          fi
          
          # Exporter les variables d'environnement
          echo "KBUILD_BUILD_TIMESTAMP=${DATESTR}" >> "$GITHUB_ENV"
          echo "KBUILD_BUILD_VERSION=1" >> "$GITHUB_ENV"
          echo "KBUILD_BUILD_USER=kleaf" >> "$GITHUB_ENV"
          echo "KBUILD_BUILD_HOST=build-host" >> "$GITHUB_ENV"
          
          cd kernel_workspace
          
          # M√©thode 1 : Patcher mkcompile_h (pour builds classiques)
          for f in common/scripts/mkcompile_h msm-kernel/scripts/mkcompile_h; do
            if [ -f "$f" ]; then
              echo "üîß Patching $f..."
              
              # Backup original
              cp "$f" "${f}.bak"
              
              # Remplacer la ligne UTS_VERSION
              if grep -q 'UTS_VERSION=' "$f"; then
                sed -i "s|UTS_VERSION=.*|UTS_VERSION=\"#1 SMP PREEMPT $DATESTR\"|" "$f"
                echo "  ‚úÖ UTS_VERSION patched in $f"
              fi
              
              # Forcer la date dans le script
              if grep -q 'TIMESTAMP=' "$f"; then
                sed -i "s|TIMESTAMP=.*|TIMESTAMP=\"$DATESTR\"|" "$f"
                echo "  ‚úÖ TIMESTAMP patched in $f"
              fi
            fi
          done
          
          # M√©thode 2 : Cr√©er un fichier de timestamp pour Bazel
          echo "$DATESTR" > common/.build_timestamp
          
          # M√©thode 3 : Patcher compile.h directement (fallback)
          COMPILE_H="common/include/generated/compile.h"
          if [ -f "$COMPILE_H" ]; then
            echo "üîß Patching existing compile.h..."
            sed -i "s|#define UTS_VERSION.*|#define UTS_VERSION \"#1 SMP PREEMPT $DATESTR\"|" "$COMPILE_H"
          fi
          
          echo "‚úÖ Build time configured: $DATESTR"

      - name: Protected Modules
        shell: bash
        run: |
          set -euo pipefail
          echo "üîß Disabling protected modules check for 6.12..."
          sed -i '0,/protected_module_names_list *= *":gki_aarch64_protected_module_names"/s//check_defconfig = "disabled"/' \
            kernel_workspace/common/BUILD.bazel
          echo "‚úÖ Protected modules check disabled"

      - name: Clean build (optional)
        if: github.event.inputs.clean_build == 'true'
        shell: bash
        run: |
          set -euo pipefail
          cd kernel_workspace
          echo "üßπ Cleaning build directories..."
          rm -rf common/out out bazel-out bazel-bin bazel-testlogs 2>/dev/null || true
          echo "‚úÖ Clean complete"

      - name: Build Kernel
        shell: bash
        run: |
          set -euo pipefail
          cd kernel_workspace

          if [ "${{ github.event.inputs.BUILD_NOCCACHE }}" = "true" ]; then
            export CCACHE_DISABLE=1
            echo "üö´ ccache disabled"
          fi
          
          # Exporter les variables de build time pour Bazel
          export KBUILD_BUILD_TIMESTAMP="${{ env.KBUILD_BUILD_TIMESTAMP }}"
          export KBUILD_BUILD_VERSION="1"
          export KBUILD_BUILD_USER="kleaf"
          export KBUILD_BUILD_HOST="build-host"

          echo "üî® Starting kernel build with ThinLTO..."
          if [ -f "build/build.sh" ]; then
            LTO=thin BUILD_CONFIG=common/build.config.gki.aarch64 build/build.sh 2>&1 | tee build.log
          else
            tools/bazel build \
              --config=fast \
              --lto=thin \
              --action_env=KBUILD_BUILD_TIMESTAMP="${KBUILD_BUILD_TIMESTAMP}" \
              --action_env=KBUILD_BUILD_VERSION="1" \
              --action_env=KBUILD_BUILD_USER="kleaf" \
              --action_env=KBUILD_BUILD_HOST="build-host" \
              //common:kernel_aarch64_dist 2>&1 | tee build.log
          fi
          echo "‚úÖ Build complete"

      - name: üìä Collect Build Stats
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::üìä Build Statistics"
          KP="${{ env.CONFIG }}"

          CANDIDATES=(
            "$KP/bazel-bin/common/kernel_aarch64_dist/Image"
            "$KP/bazel-bin/common/kernel_aarch64/Image"
            "$KP/out/android16-6.12/dist/Image"
            "$KP/common/out/arch/arm64/boot/Image"
          )

          IMAGE_PATH=""
          for p in "${CANDIDATES[@]}"; do
            if [ -f "$p" ]; then 
              IMAGE_PATH="$p"
              break
            fi
          done

          if [ -z "$IMAGE_PATH" ]; then
            echo "üîç Searching for Image..."
            IMAGE_PATH="$(find "$KP/bazel-bin" -name "Image" -type f 2>/dev/null | head -n1)"
          fi

          if [ -z "$IMAGE_PATH" ]; then
            echo "::error::‚ùå Could not locate built Image"
            echo "üìÇ Debug: listing bazel-bin/common/"
            ls -laR "$KP/bazel-bin/common/" || true
            exit 1
          fi

          echo "IMAGE_PATH=$IMAGE_PATH" >> "$GITHUB_ENV"
          IMAGE_SHA256="$(sha256sum "$IMAGE_PATH" | awk '{print $1}')"
          echo "IMAGE_SHA256=$IMAGE_SHA256" >> "$GITHUB_ENV"
          KERNEL_UNAME="$(strings "$IMAGE_PATH" | grep -E 'Linux version.*#' | tail -n1 || echo 'unknown')"
          echo "KERNEL_UNAME=$KERNEL_UNAME" >> "$GITHUB_ENV"

          WARNINGS_COUNT="0"
          if [ -f "$KP/build.log" ]; then
            WARNINGS_COUNT="$(grep -ciE '\bwarning:' "$KP/build.log" || true)"
          fi
          echo "WARNINGS_COUNT=$WARNINGS_COUNT" >> "$GITHUB_ENV"

          BUILD_END_TIME="$(date +%s)"
          BUILD_TIME="$((BUILD_END_TIME - ${{ env.BUILD_START_TIME }}))"
          echo "BUILD_TIME=$BUILD_TIME" >> "$GITHUB_ENV"

          echo "‚úÖ Image: $IMAGE_PATH"
          echo "‚úÖ SHA256: $IMAGE_SHA256"
          echo "‚úÖ Warnings: $WARNINGS_COUNT"
          echo "‚úÖ Build time: ${BUILD_TIME}s"
          echo "::endgroup::"

      - name: üîß Fix Timestamp in Image
        shell: bash
        run: |
          set -euo pipefail
          
          INPUT_TIME="${{ github.event.inputs.BUILD_TIME }}"
          if [[ -n "$INPUT_TIME" && "$INPUT_TIME" != "F" && "$INPUT_TIME" != "f" ]]; then
            DATESTR="$INPUT_TIME"
          else
            DATESTR="$(TZ='UTC' date +'%a %b %d %T %Z %Y')"
          fi
          
          IMAGE_PATH="${{ env.IMAGE_PATH }}"
          
          if [ -f "$IMAGE_PATH" ]; then
            echo "üîß Checking timestamp in kernel Image..."
            
            # Rechercher la date epoch
            OLD_DATE="Thu Jan  1 00:00:00 UTC 1970"
            
            # V√©rifier si la date epoch existe
            if strings "$IMAGE_PATH" | grep -q "$OLD_DATE"; then
              echo "  ‚ö†Ô∏è  Found epoch date in Image, attempting to replace..."
              
              # Cr√©er une copie temporaire
              cp "$IMAGE_PATH" "${IMAGE_PATH}.tmp"
              
              # La nouvelle date doit avoir EXACTEMENT la m√™me longueur (29 caract√®res)
              PADDED_DATE=$(printf "%-29s" "$DATESTR")
              
              # Remplacer avec sed (en binaire)
              sed -i "s/${OLD_DATE}/${PADDED_DATE}/g" "${IMAGE_PATH}.tmp"
              
              # V√©rifier que le remplacement a fonctionn√©
              if strings "${IMAGE_PATH}.tmp" | grep -q "$DATESTR"; then
                mv "${IMAGE_PATH}.tmp" "$IMAGE_PATH"
                echo "  ‚úÖ Timestamp successfully patched in Image!"
                
                # Recalculer le SHA256
                IMAGE_SHA256="$(sha256sum "$IMAGE_PATH" | awk '{print $1}')"
                echo "IMAGE_SHA256=$IMAGE_SHA256" >> "$GITHUB_ENV"
              else
                echo "  ‚ö†Ô∏è  Patch failed, keeping original"
                rm "${IMAGE_PATH}.tmp"
              fi
            else
              echo "  ‚úÖ No epoch date found (timestamp already correct or not embedded)"
            fi
          fi

      - name: Make AnyKernel3
        shell: bash
        run: |
          set -euo pipefail
          echo "üì¶ Creating AnyKernel3 package..."
          
          # Clone AnyKernel3
          git clone https://github.com/Bouteillepleine/AnyKernel3 --depth=1
          rm -rf ./AnyKernel3/.git
          
          # V√©rifier que l'Image existe
          if [ ! -f "${{ env.IMAGE_PATH }}" ]; then
            echo "::error::‚ùå Image not found at ${{ env.IMAGE_PATH }}"
            exit 1
          fi
          
          # Copier l'Image
          cp "${{ env.IMAGE_PATH }}" ./AnyKernel3/Image
          
          # V√©rifier que la copie a r√©ussi
          if [ ! -f "./AnyKernel3/Image" ]; then
            echo "::error::‚ùå Failed to copy Image to AnyKernel3/"
            exit 1
          fi
          
          echo "‚úÖ AnyKernel3 prepared"
          echo "‚úÖ Image size: $(du -h ./AnyKernel3/Image | cut -f1)"

      - name: Apply KPM patch
        shell: bash
        run: |
          set -euo pipefail
          
          PATCH_DIR="${GITHUB_WORKSPACE}/Action-Build/patches"
          cd AnyKernel3
          
          # V√©rifier que Image existe avant de patcher
          if [ ! -f "Image" ]; then
            echo "::error::‚ùå Image not found before KPM patch!"
            exit 1
          fi
          
          # Sauvegarder l'Image original
          cp Image Image.backup
          
          if [ -f "${PATCH_DIR}/patch_linux" ]; then
            echo "üîß Applying KPM patch_linux..."
            cp "${PATCH_DIR}/patch_linux" .
            chmod +x patch_linux
            
            # Appliquer le patch
            if ./patch_linux; then
              echo "‚úÖ KPM patch applied successfully"
              
              # V√©rifier que oImage a √©t√© cr√©√©
              if [ -f "oImage" ]; then
                rm -f Image
                mv oImage Image
                echo "‚úÖ Image replaced with patched version"
              else
                echo "‚ö†Ô∏è  oImage not created, keeping original Image"
              fi
            else
              echo "‚ö†Ô∏è  KPM patch failed, keeping original Image"
            fi
            
            # Nettoyer
            rm -f Image.backup patch_linux
          else
            echo "‚è≠Ô∏è  No KPM patch found, keeping original Image"
            rm -f Image.backup
          fi
          
          # V√©rification finale
          if [ ! -f "Image" ]; then
            echo "::error::‚ùå Image lost after KPM patch!"
            if [ -f "Image.backup" ]; then
              mv Image.backup Image
              echo "‚úÖ Restored Image from backup"
            else
              exit 1
            fi
          fi
          
          echo "‚úÖ Final Image size: $(du -h Image | cut -f1)"

      - name: Create ZIP
        shell: bash
        run: |
          set -euo pipefail
          
          KSU_SOURCE_NAME="${{ github.event.inputs.KSU_SOURCE }}"
          SUSFS_SUFFIX=""
          if [ -n "${{ github.event.inputs.SUSFS_META }}" ]; then
            SUSFS_SUFFIX="_SUSFS"
          fi
          
          # Nom du ZIP (SANS extension .zip)
          ZIP_BASE="AnyKernel3_${KSU_SOURCE_NAME}_${{ env.KSUVER }}${SUSFS_SUFFIX}_OnePlus15_${{ env.TKERNEL_VERSION }}"
          ZIP_FILE="${ZIP_BASE}.zip"
          
          echo "üì¶ Creating ZIP: $ZIP_FILE"
          
          # V√©rifier que Image existe dans AnyKernel3
          if [ ! -f "AnyKernel3/Image" ]; then
            echo "::error::‚ùå Image not found in AnyKernel3/"
            echo "üìÇ Contents of AnyKernel3/:"
            ls -lah AnyKernel3/
            exit 1
          fi
          
          # V√©rifier que anykernel.sh existe
          if [ ! -f "AnyKernel3/anykernel.sh" ]; then
            echo "::error::‚ùå anykernel.sh not found in AnyKernel3/"
            exit 1
          fi
          
          # Cr√©er le ZIP
          cd AnyKernel3
          zip -r9 "../${ZIP_FILE}" * -x '.git/*' 'README.md' '*placeholder*' '.gitignore'
          cd ..
          
          # V√©rifier que le ZIP a √©t√© cr√©√©
          if [ ! -f "$ZIP_FILE" ]; then
            echo "::error::‚ùå ZIP file not created!"
            exit 1
          fi
          
          # V√©rifier le contenu du ZIP
          echo "üìã ZIP contents:"
          unzip -l "$ZIP_FILE" | head -20
          
          # V√©rifier que Image est dans le ZIP
          if ! unzip -l "$ZIP_FILE" | grep -q "Image"; then
            echo "::error::‚ùå Image not found in ZIP!"
            exit 1
          fi
          
          # Sauvegarder les variables (chemin absolu)
          echo "ZIP_NAME=${ZIP_FILE}" >> "$GITHUB_ENV"
          echo "ZIP_PATH=${GITHUB_WORKSPACE}/${ZIP_FILE}" >> "$GITHUB_ENV"
          
          # Calculer le SHA256
          ZIP_SHA256="$(sha256sum "$ZIP_FILE" | awk '{print $1}')"
          echo "ZIP_SHA256=$ZIP_SHA256" >> "$GITHUB_ENV"
          
          echo "‚úÖ ZIP created: $ZIP_FILE"
          echo "‚úÖ Size: $(du -h "$ZIP_FILE" | cut -f1)"
          echo "‚úÖ SHA256: $ZIP_SHA256"

      - name: Upload AnyKernel3
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP_NAME }}
          path: ${{ env.ZIP_PATH }}
          if-no-files-found: error
          compression-level: 0

      - name: üìä Build Summary
        shell: bash
        run: |
          set -euo pipefail
          
          SUSFS_COMMIT_SHA="${SUSFS_COMMIT_SHA:-N/A}"
          SUSFS_BRANCH_NAME="${SUSFS_BRANCH_NAME:-N/A}"
          SUSVER="${SUSVER:-N/A}"
          
          # D√©tection intelligente de SUSFS (bas√©e sur SUSVER)
          if [ "$SUSVER" != "N/A" ] && [ -n "$SUSVER" ]; then
            SUSFS_ENABLED="‚úÖ"
          else
            SUSFS_ENABLED="‚ùå"
          fi
          
          cat >> "$GITHUB_STEP_SUMMARY" <<EOF
          # üéâ OnePlus 15 Kernel Build Complete

          ## üì± Device Information
          | Property | Value |
          |----------|-------|
          | **Model** | ${{ env.OP_MODEL }} |
          | **SoC** | ${{ env.OP_SOC }} |
          | **OS Version** | ${{ env.OP_OS_VERSION }} |
          | **Kernel Version** | ${{ env.KERNEL_FULL_VER }} |
          | **Kernel String** | \`${{ env.KERNEL_UNAME }}\` |

          ## üîß Build Configuration
          | Component | Version/Setting |
          |-----------|----------------|
          | **KSU Source** | ${{ github.event.inputs.KSU_SOURCE }} |
          | **KSU Version** | v${{ env.KSUVER }} |
          | **SUSFS** | ${SUSVER} |
          | **SUSFS Branch** | ${SUSFS_BRANCH_NAME} |
          | **SUSFS Dev** | ${{ github.event.inputs.SUSFS_DEV && '‚úÖ Yes' || '‚ùå No' }} |
          | **LTO** | ${{ env.OP_LTO }} |
          | **Clean Build** | ${{ github.event.inputs.clean_build && '‚úÖ Yes' || '‚ùå No' }} |
          | **Ccache** | ${{ github.event.inputs.BUILD_NOCCACHE && '‚ùå Disabled' || '‚úÖ Enabled' }} |
          | **Build Time** | ${{ env.BUILD_TIME }}s |
          | **Warnings** | ${{ env.WARNINGS_COUNT }} |

          ## üì¶ Build Output
          | File | Details |
          |------|---------|
          | **ZIP Name** | \`${{ env.ZIP_NAME }}\` |
          | **ZIP SHA256** | \`${{ env.ZIP_SHA256 }}\` |
          | **Image SHA256** | \`${{ env.IMAGE_SHA256 }}\` |

          ## üîó Source Commits
          | Component | Commit |
          |-----------|--------|
          | **KernelSU** | [\`${{ env.KSU_COMMIT_SHA }}\`](https://github.com/${{ github.event.inputs.KSU_SOURCE == 'RESUKISU' && 'ReSukiSU/ReSukiSU' || 'SukiSU-Ultra/SukiSU-Ultra' }}/commit/${{ env.KSU_COMMIT_SHA }}) |
          | **SUSFS** | $([ "$SUSFS_COMMIT_SHA" != "N/A" ] && echo "[\\\`${SUSFS_COMMIT_SHA:0:8}\\\`](https://gitlab.com/simonpunk/susfs4ksu/-/commit/${SUSFS_COMMIT_SHA})" || echo "N/A") |

          ## ‚ú® Features Enabled
          - ‚úÖ KernelSU (${{ github.event.inputs.KSU_SOURCE }})
          - ‚úÖ KPM (Kernel Patch Manager)
          - ${SUSFS_ENABLED} SUSFS
          - ‚úÖ BBR & ECN
          - ‚úÖ LSM (Baseband Guard)
          - ‚úÖ IPSET & IPv6 NAT
          - ‚úÖ Unicode Bypass Fix
          EOF

      - name: Post-build Disk Check
        run: df -h

      - name: üßπ Cleanup
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::üßπ Cleanup"
          sudo rm -rf "${{ env.CONFIG }}/common/out" || true
          sudo rm -rf "${{ env.CONFIG }}/.repo" || true
          sudo rm -rf /tmp/* || true
          df -h /
          echo "::endgroup::"
