name: Build

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      ksu_type:
        description: 'KernelSU Type'
        required: true
        type: choice
        options:
          - KSUN
          - KSU
          - SukiSU
        default: KSUN

      ksu_branch:
        description: 'KSU/KSUN branch/commit (empty = auto, not for SukiSU)'
        type: string
        default: ""

      ksu_meta:
        description: 'SukiSU: branch(required)/custom_tag(optional)/commit_hash(optional)'
        type: string
        default: "tmp-builtin/âš¡Ultraâš¡/"

      susfs_branch:
        description: 'SUSFS branch/commit (empty = auto: gki-android16-6.12)'
        type: string
        default: ""

      optimize_level:
        description: 'Optimization level'
        type: choice
        options: [O2, O3]
        default: O2

      clean_build:
        description: 'Clean build (no ccache)'
        type: boolean
        default: false

jobs:
  build-op15:
    runs-on: ubuntu-latest
    env:
      # Device Configuration
      OP_MODEL: "OP15"
      OP_SOC: "canoe"
      OP_BRANCH: "wild/sm8850"
      OP_MANIFEST: "oneplus_15_w.xml"
      OP_ANDROID_VERSION: "android16"
      OP_KERNEL_VERSION: "6.12"
      OP_OS_VERSION: "OOS16"
      OP_LTO: "none"
      OP_RUST_BUILD: "true"
      OP_HMBIRD: "false"
      OP_SUSFS: "true"
      OP_BBG: "true"
      OP_BBR: "true"
      OP_TTL: "true"
      OP_IP_SET: "true"
      OP_UNAME: "5-g188c695beb6d-ab14367805-4k"

      # Aliases used by your SUSFS logic
      ANDROID_VER: "android16"
      KERNEL_VER: "6.12"

    steps:
      - name: ðŸ§¹ Free Disk Space
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Disk cleanup"
          df -h
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL || true
          sudo apt-get clean || true
          if command -v docker >/dev/null 2>&1; then
            docker rmi $(docker images -q) 2>/dev/null || true
          fi
          df -h
          echo "::endgroup::"

      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ“¦ Install Dependencies
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Install dependencies"
          sudo apt-get update -qq
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            git curl ca-certificates build-essential clang lld flex bison \
            libelf-dev libssl-dev libncurses-dev zlib1g-dev liblz4-tool \
            libxml2-utils rsync unzip dwarves file python3 ccache jq bc dos2unix kmod libdw-dev elfutils
          sudo apt-get clean
          echo "âœ… Dependencies installed"
          echo "::endgroup::"

      - name: ðŸ¦€ Install Rust bindgen
        if: ${{ env.OP_RUST_BUILD == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Install Rust bindgen"
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain none
          source "$HOME/.cargo/env"
          cargo install bindgen-cli --version 0.69.5
          bindgen --version
          echo "âœ… Rust bindgen installed"
          echo "::endgroup::"

      - name: ðŸ”§ Setup Environment
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Setup environment"

          # repo tool
          REPO="/usr/local/bin/repo"
          if [ ! -x "$REPO" ]; then
            sudo curl -s https://storage.googleapis.com/git-repo-downloads/repo -o "$REPO"
            sudo chmod +x "$REPO"
          fi
          echo "REPO=$REPO" >> "$GITHUB_ENV"

          # Define CONFIG (your steps rely on it)
          echo "CONFIG=$GITHUB_WORKSPACE/OP15" >> "$GITHUB_ENV"

          # Git optimization
          git config --global feature.manyFiles true
          git config --global core.fsmonitor true
          git config --global pack.sparse true

          # Build identity
          echo "BUILD_USER=OnePlus" >> "$GITHUB_ENV"
          echo "BUILD_HOST=ubuntu-build" >> "$GITHUB_ENV"

          echo "âœ… Environment configured"
          echo "::endgroup::"

      - name: ðŸ“¥ Sync Kernel Source
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Sync kernel source"
          mkdir -p OP15
          cd OP15

          echo "ðŸ”§ Initializing repo with custom manifest..."
          echo "   Repository: https://github.com/Bouteillepleine/OnePlus_KernelSU_SUSFS.git"
          echo "   Branch: main"
          echo "   Manifest: manifests/oos16/${OP_MANIFEST}"

          "$REPO" init \
            -u https://github.com/Bouteillepleine/OnePlus_KernelSU_SUSFS.git \
            -b main \
            -m "manifests/oos16/${OP_MANIFEST}" \
            --repo-rev=v2.16 \
            --depth=1 \
            --no-clone-bundle \
            --no-tags

          if [ ! -f .repo/manifest.xml ]; then
            echo "::error::Manifest file not found after repo init"
            ls -la .repo/ || true
            exit 1
          fi

          echo "âœ… Repo initialized"
          echo ""
          echo "ðŸ“‹ Manifest preview:"
          head -n 20 .repo/manifest.xml

          echo ""
          echo "ðŸ“¥ Syncing kernel source (this may take 10-20 minutes)..."
          success=false
          for i in 1 2 3; do
            echo ""
            echo "=== Sync Attempt $i/3 ==="
            if "$REPO" sync -c --no-clone-bundle --no-tags --optimized-fetch \
              -j"$(nproc --all)" --fail-fast; then
              success=true
              break
            fi
            echo "âš ï¸ Sync attempt $i failed, retrying in 30 seconds..."
            sleep 30
          done

          if [ "$success" = false ]; then
            echo "::error::Failed to sync kernel source after 3 attempts"
            exit 1
          fi

          if [ ! -d kernel_platform ]; then
            echo "::error::kernel_platform directory not found after sync"
            ls -la .
            exit 1
          fi

          echo ""
          echo "âœ… Kernel source synced successfully"
          echo "::endgroup::"

      - name: ðŸ” Detect Kernel Version
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Detect kernel version"
          cd OP15/kernel_platform/common

          if [ ! -f Makefile ]; then
            echo "::error::Makefile not found"
            exit 1
          fi

          VERSION=$(awk '/^VERSION *=/ {print $3}' Makefile)
          PATCHLEVEL=$(awk '/^PATCHLEVEL *=/ {print $3}' Makefile)
          SUBLEVEL=$(awk '/^SUBLEVEL *=/ {print $3}' Makefile)
          FULL_VERSION="$VERSION.$PATCHLEVEL.$SUBLEVEL"

          echo "KERNEL_FULL_VER=$OP_ANDROID_VERSION-$FULL_VERSION" >> "$GITHUB_ENV"
          echo "TKERNEL_VER=$FULL_VERSION" >> "$GITHUB_ENV"
          echo "SUSFS_KERNEL_BRANCH=gki-$OP_ANDROID_VERSION-$VERSION.$PATCHLEVEL" >> "$GITHUB_ENV"

          echo "âœ… Detected: $OP_ANDROID_VERSION-$FULL_VERSION"
          echo "   SUSFS branch: gki-$OP_ANDROID_VERSION-$VERSION.$PATCHLEVEL"
          echo "::endgroup::"

      - name: ðŸ” Detect Toolchain
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Detect toolchain"

          KP="$GITHUB_WORKSPACE/OP15/kernel_platform"

          # Find Clang
          echo "ðŸ” Looking for Clang..."
          CLANG_FOUND=false
          for base in "$KP/prebuilts" "$KP/prebuilts-master"; do
            [ -d "$base/clang/host/linux-x86" ] || continue
            latest=$(ls -d "$base"/clang/host/linux-x86/clang-r*/ 2>/dev/null | sort -V | tail -n1 || true)
            if [ -n "$latest" ] && [ -x "$latest/bin/clang" ]; then
              echo "CLANG_BIN_PATH=$latest/bin" >> "$GITHUB_ENV"
              CLANG_VER="$("$latest/bin/clang" --version | head -n1)"
              echo "CLANG_VERSION=$CLANG_VER" >> "$GITHUB_ENV"
              echo "âœ… Clang: $CLANG_VER"
              CLANG_FOUND=true
              break
            fi
          done

          if [ "$CLANG_FOUND" = false ]; then
            echo "::error::Clang toolchain not found"
            exit 1
          fi

          # Find Rust
          echo ""
          echo "ðŸ” Looking for Rust..."
          RUSTC_FOUND=false
          for base in "$KP/prebuilts" "$KP/prebuilts-master"; do
            [ -d "$base/rust/linux-x86/" ] || continue
            latest=$(ls -d "$base/rust/linux-x86/1."* 2>/dev/null | sort -V | head -n1 || true)
            if [ -n "$latest" ] && [ -x "$latest/bin/rustc" ]; then
              echo "RUSTC_BIN_PATH=$latest/bin" >> "$GITHUB_ENV"
              RUSTC_VER="$("$latest/bin/rustc" --version)"
              echo "RUSTC_VERSION=$RUSTC_VER" >> "$GITHUB_ENV"
              echo "âœ… Rust: $RUSTC_VER"
              RUSTC_FOUND=true
              break
            fi
          done

          if [ "$RUSTC_FOUND" = false ]; then
            echo "âš ï¸ Rust toolchain not found"
          fi

          echo "::endgroup::"

      - name: â™»ï¸ Setup ccache
        if: ${{ inputs.clean_build != true }}
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-op15-v2-${{ env.KERNEL_FULL_VER }}-${{ hashFiles('OP15/kernel_platform/common/Makefile') }}
          restore-keys: |
            ccache-op15-v2-${{ env.KERNEL_FULL_VER }}-
            ccache-op15-v2-

      - name: ðŸ”§ Configure ccache
        if: ${{ inputs.clean_build != true }}
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Configure ccache"
          export CCACHE_DIR="$HOME/.ccache"
          mkdir -p "$CCACHE_DIR"
          ccache -M 1G
          ccache -o compression=true
          ccache -o compression_level=3
          ccache -o direct_mode=true
          ccache -o file_clone=true
          ccache -o inode_cache=true
          echo "ðŸ“Š ccache status:"
          ccache -s
          echo "::endgroup::"

      - name: ðŸ“¦ Clone Dependencies
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Clone dependencies"
          cd "$GITHUB_WORKSPACE"

          echo "ðŸ“¥ Cloning AnyKernel3..."
          git clone --depth=1 https://github.com/TheWildJames/AnyKernel3.git -b gki-2.0

          echo "ðŸ“¥ Cloning kernel_patches (Bouteillepleine)..."
          git clone --depth=1 https://github.com/Bouteillepleine/kernel_patches.git

          if [ "${OP_SUSFS}" = "true" ]; then
            echo "ðŸ“¥ Cloning susfs4ksu..."
            git clone https://gitlab.com/simonpunk/susfs4ksu.git
            cd susfs4ksu

            SUSFS_BRANCH_INPUT="${{ inputs.susfs_branch }}"
            if [ -z "$SUSFS_BRANCH_INPUT" ]; then
              SUSFS_BRANCH_INPUT="${SUSFS_KERNEL_BRANCH}"
            fi

            echo "ðŸ” Checking out SUSFS: $SUSFS_BRANCH_INPUT"
            if git rev-parse --verify "origin/$SUSFS_BRANCH_INPUT" >/dev/null 2>&1; then
              git checkout "$SUSFS_BRANCH_INPUT"
            elif git rev-parse --verify "$SUSFS_BRANCH_INPUT" >/dev/null 2>&1; then
              git checkout "$SUSFS_BRANCH_INPUT"
            else
              echo "::error::SUSFS branch '$SUSFS_BRANCH_INPUT' not found"
              git branch -r | head -n 20
              exit 1
            fi

            SUSFS_SHA=$(git rev-parse HEAD)
            SUSFS_BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "detached")

            echo "SUSFS_COMMIT_SHA=$SUSFS_SHA" >> "$GITHUB_ENV"
            echo "SUSFS_BRANCH_NAME=$SUSFS_BRANCH_NAME" >> "$GITHUB_ENV"

            echo "âœ… SUSFS: $SUSFS_BRANCH_NAME ($SUSFS_SHA)"
          fi

          echo "::endgroup::"

      - name: ðŸ§¹ Clean ABI Exports
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Clean ABI exports"
          cd "$CONFIG/kernel_platform"
          rm -f common/android/abi_gki_protected_exports_* || true
          rm -f msm-kernel/android/abi_gki_protected_exports_* || true
          sed -i 's/protected_modules = \[.*\]/protected_modules = []/' common/modules.bzl || true
          echo "âœ… ABI exports cleaned"
          echo "::endgroup::"

      - name: Add KernelSU Next
        shell: bash
        if: ${{ inputs.ksu_type == 'KSUN' }}
        run: |
          set -euo pipefail
          echo "::group::Add KernelSU Next"
          cd "$CONFIG/kernel_platform"
          echo "Adding KernelSU Next..."
          if [ "${{ inputs.ksu_branch }}" = "" ]; then
            curl --fail --location --proto '=https' -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh" | bash -
          else
            curl --fail --location --proto '=https' -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh" | bash -s "${{ inputs.ksu_branch }}"
          fi
          git submodule update --init --recursive
          cd KernelSU-Next/kernel

          COMMITS_COUNT=$(/usr/bin/git rev-list --count HEAD)

          if [ "$COMMITS_COUNT" -lt 2684 ]; then
            BASE_VERSION=10200
          else
            BASE_VERSION=30000
          fi

          KSU_VERSION=$(expr "$COMMITS_COUNT" "+" "$BASE_VERSION")
          sed -i "s/DKSU_VERSION=11998/DKSU_VERSION=${KSU_VERSION}/" Makefile || true

          if [ "$KSU_VERSION" -lt 12884 ]; then
            echo "NEED_HOOKS=true" >> "$GITHUB_ENV"
          else
            echo "NEED_HOOKS=false" >> "$GITHUB_ENV"
          fi

          cd ..
          KSU_COMMIT_SHA=$(git rev-parse HEAD)
          echo "KSU_COMMIT_SHA=$KSU_COMMIT_SHA" >> "$GITHUB_ENV"

          echo "KSUVER=$KSU_VERSION" >> "$GITHUB_ENV"
          echo "KernelSU Next Version: $KSU_VERSION"
          echo "âœ… KernelSU Next added (commit: ${KSU_COMMIT_SHA:0:8})"
          echo "::endgroup::"

      - name: Add KernelSU
        shell: bash
        if: ${{ inputs.ksu_type == 'KSU' }}
        run: |
          set -euo pipefail
          echo "::group::Add KernelSU"
          cd "$CONFIG/kernel_platform"
          echo "Adding KernelSU..."
          if [ "${{ inputs.ksu_branch }}" = "" ]; then
            curl --fail --location --proto '=https' -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -
          else
            curl --fail --location --proto '=https' -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s "${{ inputs.ksu_branch }}"
          fi
          git submodule update --init --recursive
          cd KernelSU/kernel
          BASE_VERSION=20000
          KSU_VERSION=$(expr $(/usr/bin/git rev-list --count HEAD) "+" $BASE_VERSION)
          sed -i "s/DKSU_VERSION=16/DKSU_VERSION=${KSU_VERSION}/" Makefile || true

          echo "NEED_HOOKS=false" >> "$GITHUB_ENV"

          cd ..
          KSU_COMMIT_SHA=$(git rev-parse HEAD)
          echo "KSU_COMMIT_SHA=$KSU_COMMIT_SHA" >> "$GITHUB_ENV"

          echo "KSUVER=$KSU_VERSION" >> "$GITHUB_ENV"
          echo "KernelSU Version: $KSU_VERSION"
          echo "âœ… KernelSU added (commit: ${KSU_COMMIT_SHA:0:8})"
          echo "::endgroup::"

      - name: Add SukiSU Ultra
        shell: bash
        if: ${{ inputs.ksu_type == 'SukiSU' }}
        run: |
          set -euo pipefail
          echo "::group::Add SukiSU Ultra"
          cd "$CONFIG/kernel_platform"

          echo "Adding SukiSU Ultra..."
          KSU_META="${{ inputs.ksu_meta }}"

          # must contain at least 2 slashes => 3 fields
          if [[ "$(grep -o '/' <<< "$KSU_META" | wc -l)" -lt 2 ]]; then
            echo "::error::ksu_meta format error. Required: branch/custom_tag/commit_hash"
            echo "Example: builtin/Numbersf/ or builtin/Numbersf/abc123deadbeef"
            exit 1
          fi

          IFS='/' read -r BRANCH_NAME CUSTOM_TAG MANUAL_HASH <<< "$KSU_META"

          if [[ -z "${BRANCH_NAME:-}" ]]; then
            echo "::error::ksu_meta branch is required (first field)."
            exit 1
          fi

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“‹ SukiSU Ultra Configuration"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Branch: $BRANCH_NAME"
          [[ -n "$CUSTOM_TAG" ]] && echo "Custom Tag: $CUSTOM_TAG" || echo "Custom Tag: âŒ Not set"
          [[ -n "$MANUAL_HASH" ]] && echo "Manual Hash: $MANUAL_HASH" || echo "Manual Hash: âŒ Not set (using latest)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          curl --fail --location --proto '=https' -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s "$BRANCH_NAME"

          cd ./KernelSU

          if [[ -n "$MANUAL_HASH" ]]; then
            echo "ðŸ”„ Fetching and checking out commit: $MANUAL_HASH"
            git fetch origin "$BRANCH_NAME" --depth=50 || true
            git checkout "$MANUAL_HASH"
            echo "âœ… Checked out: ${MANUAL_HASH:0:8}"
          fi

          # Numeric KSU version (reference style)
          KSU_VERSION=$(expr $(git rev-list --count main 2>/dev/null || echo 13000) + 37185)

          KSU_COMMIT_SHA=$(git rev-parse HEAD)
          echo "KSU_COMMIT_SHA=$KSU_COMMIT_SHA" >> "$GITHUB_ENV"
          echo "KSUVER=$KSU_VERSION" >> "$GITHUB_ENV"

          # SukiSU: let hooks be driven by SUSFS logic, not by KSU itself
          echo "NEED_HOOKS=false" >> "$GITHUB_ENV"

          echo "âœ… SukiSU Ultra added (KSUVER=$KSU_VERSION, commit: ${KSU_COMMIT_SHA:0:8})"
          echo "::endgroup::"

      - name: Apply SUSFS Patches
        shell: bash
        if: ${{ env.OP_SUSFS == 'true' }}
        run: |
          set -euo pipefail
          echo "::group::Apply SUSFS patches"
          cd "$CONFIG/kernel_platform"
          echo "Applying SUSFS patches..."
          cp ../../susfs4ksu/kernel_patches/50_add_susfs_in_${{ env.SUSFS_KERNEL_BRANCH }}.patch ./common/
          cp ../../susfs4ksu/kernel_patches/fs/* ./common/fs/
          cp ../../susfs4ksu/kernel_patches/include/linux/* ./common/include/linux/

          susfs_version=$(grep '#define SUSFS_VERSION' ./common/include/linux/susfs.h | awk -F'"' '{print $2}')
          echo "SUSVER=$susfs_version" >> $GITHUB_ENV
          echo "SusFS Version: $susfs_version"

          version_lte() {
            [ "$(printf '%s\n' "$2" "$1" | sort -V | head -n1)" = "$1" ]
          }

          if version_lte "${susfs_version:1}" "1.5.12"; then
            echo "NEED_HOOKS=true" >> $GITHUB_ENV
          else
            echo "NEED_HOOKS=false" >> $GITHUB_ENV
          fi

          case "$susfs_version" in
            "v1.5.8")
              if [ "${{ inputs.ksu_type }}" = "KSUN" ]; then
                cd ./KernelSU-Next
              else
                cd ./KernelSU
              fi
              cp ../../../susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch ./
              if [ "${{ inputs.ksu_type }}" = "KSUN" ]; then
                patch -p1 --forward --fuzz=3 < 10_enable_susfs_for_ksu.patch  || true
                cp "../../../kernel_patches/next/susfs_fix_patches/$susfs_version/fix_apk_sign.c.patch" ./
                patch -p1 --forward --fuzz=3 < fix_apk_sign.c.patch
                cp "../../../kernel_patches/next/susfs_fix_patches/$susfs_version/fix_core_hook.c.patch" ./
                patch -p1 --forward --fuzz=3 < fix_core_hook.c.patch
                cp "../../../kernel_patches/next/susfs_fix_patches/$susfs_version/fix_selinux.c.patch" ./
                patch -p1 --forward --fuzz=3 < fix_selinux.c.patch
                cp "../../../kernel_patches/next/susfs_fix_patches/$susfs_version/fix_ksud.c.patch" ./
                patch -p1 --forward --fuzz=3 < fix_ksud.c.patch
              else
                patch -p1 --forward --fuzz=3 < 10_enable_susfs_for_ksu.patch
              fi
              ;;
            "v1.5.9"|"v1.5.10"|"v1.5.11"|"v1.5.12")
              if [ "${{ inputs.ksu_type }}" = "KSUN" ]; then
                cd ./KernelSU-Next
              else
                cd ./KernelSU
              fi
              cp ../../../susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch ./
              if [ "${{ inputs.ksu_type }}" = "KSUN" ]; then
                patch -p1 --forward < 10_enable_susfs_for_ksu.patch  || true
                for file in $(find ./kernel -maxdepth 2 -name "*.rej" -printf "%f\n" | cut -d'.' -f1); do
                  echo "Patching file: $file.c with fix_$file.c.patch"
                  patch -p1 --forward < "../../../kernel_patches/next/susfs_fix_patches/$susfs_version/fix_$file.c.patch"
                done
                patch -p1 --forward < "../../../kernel_patches/next/susfs_fix_patches/$susfs_version/fix_kernel_compat.c.patch"
              else
                patch -p1 --forward < 10_enable_susfs_for_ksu.patch
              fi
              ;;
            "v2.0.0")
              if [ "${{ inputs.ksu_type }}" = "KSUN" ]; then
                cd ./KernelSU-Next
              else
                cd ./KernelSU
              fi
              cp ../../../susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch ./
              if [ "${{ inputs.ksu_type }}" = "KSUN" ]; then
                patch -p1 --forward < 10_enable_susfs_for_ksu.patch  || true
                for file in $(find ./kernel -maxdepth 2 -name "*.rej" -exec basename {} .rej \;); do
                  echo "Patching file: $file with fix_$file.patch"
                  patch -p1 --forward < "../../../kernel_patches/next/susfs_fix_patches/$susfs_version/fix_$file.patch"
                done
                echo "Patching Hook Mode!"
                patch -p1 --forward < "../../../kernel_patches/next/susfs_fix_patches/$susfs_version/overwrite_hook_mode.patch"
                echo "Patching KSU_TOOLKIT Support for SusFS kernel!"
                patch -p1 --forward < "../../../kernel_patches/next/susfs_fix_patches/$susfs_version/ksu_toolkit.patch"
              else
                patch -p1 --forward < 10_enable_susfs_for_ksu.patch
              fi
              ;;
            *)
              echo "::error::Unsupported SUSFS version: $susfs_version"
              exit 1
              ;;
          esac

          cd ../common
          if [ "${{ env.ANDROID_VER }}" = "android15" ] && [ "${{ env.KERNEL_VER }}" = "6.6" ]; then
            if ! grep -qxF '#include <trace/hooks/fs.h>' ./fs/namespace.c; then
              sed -i '/#include <trace\/hooks\/blk.h>/a #include <trace\/hooks\/fs.h>' ./fs/namespace.c
            fi
          fi

          fake_patched=0
          if [ "${{ env.ANDROID_VER }}" = "android15" ] && [ "${{ env.KERNEL_VER }}" = "6.6" ]; then
            if ! grep -qxF $'\tunsigned int nr_subpages = __PAGE_SIZE / PAGE_SIZE;' ./fs/proc/task_mmu.c; then
              echo "nr_subpages Line not found. Fake Patching!"
              sed -i -e '/int ret = 0, copied = 0;/a \\tunsigned int nr_subpages \= __PAGE_SIZE \/ PAGE_SIZE;' -e '/int ret = 0, copied = 0;/a \\tpagemap_entry_t \*res = NULL;' ./fs/proc/task_mmu.c
              fake_patched=1
            fi
          fi
          if [ "${{ env.ANDROID_VER }}" = "android12" ] && [ "${{ env.KERNEL_VER }}" = "5.10" ]; then
            if ! grep -qxF $'\tif (!vma_pages(vma))' ./fs/proc/task_mmu.c; then
              echo "vma_pages Line not found. Fake Patching!"
              fake_patched=1
            fi
          fi
          if [ "${{ env.ANDROID_VER }}" = "android13" ] && [ "${{ env.KERNEL_VER }}" = "5.15" ]; then
            if ! grep -qxF $'\tif (!vma_pages(vma))' ./fs/proc/task_mmu.c; then
              echo "vma_pages Line not found. Fake Patching!"
              fake_patched=1
            fi
          fi
          if [ "${{ env.ANDROID_VER }}" = "android14" ] && [ "${{ env.KERNEL_VER }}" = "6.1" ]; then
            if ! grep -qxF $'\tif (!vma_pages(vma))' ./fs/proc/task_mmu.c; then
              echo "vma_pages Line not found. Fake Patching!"
              fake_patched=1
            fi
          fi

          patch -p1 < 50_add_susfs_in_${{ env.SUSFS_KERNEL_BRANCH }}.patch

          if [ "$fake_patched" = 1 ]; then
            if [ "${{ env.ANDROID_VER }}" = "android15" ] && [ "${{ env.KERNEL_VER }}" = "6.6" ]; then
              if grep -qxF $'\tunsigned int nr_subpages = __PAGE_SIZE / PAGE_SIZE;' ./fs/proc/task_mmu.c; then
                echo "nr_subpages Line found. Revert Fake Patching!"
                sed -i -e '/unsigned int nr_subpages \= __PAGE_SIZE \/ PAGE_SIZE;/d' -e '/pagemap_entry_t \*res = NULL;/d' ./fs/proc/task_mmu.c
              fi
            fi
            if [ "${{ env.ANDROID_VER }}" = "android12" ] && [ "${{ env.KERNEL_VER }}" = "5.10" ]; then
              if grep -qxF $'\t\tgoto show_pad;' ./fs/proc/task_mmu.c; then
                echo "vma_pages Line found. Revert Fake Patching!"
                sed -i -e 's/goto show_pad;/return 0;/' ./fs/proc/task_mmu.c
              fi
            fi
            if [ "${{ env.ANDROID_VER }}" = "android13" ] && [ "${{ env.KERNEL_VER }}" = "5.15" ]; then
              if grep -qxF $'\t\tgoto show_pad;' ./fs/proc/task_mmu.c; then
                echo "vma_pages Line found. Revert Fake Patching!"
                sed -i -e 's/goto show_pad;/return 0;/' ./fs/proc/task_mmu.c
              fi
            fi
            if [ "${{ env.ANDROID_VER }}" = "android14" ] && [ "${{ env.KERNEL_VER }}" = "6.1" ]; then
              if grep -qxF $'\t\tgoto show_pad;' ./fs/proc/task_mmu.c; then
                echo "vma_pages Line found. Revert Fake Patching!"
                sed -i -e 's/goto show_pad;/return 0;/' ./fs/proc/task_mmu.c
              fi
            fi
          fi
          echo "âœ… SUSFS patches applied"
          echo "::endgroup::"

      - name: Add BBG
        if: ${{ env.OP_BBG == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Add BBG LSM"
          cd "$CONFIG/kernel_platform"
          echo "Adding BBG..."
          if ! wget -O- https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh | bash -s fix_blkdev_rename; then
            echo "::warning::BBG setup script failed, continuing anyway"
          fi
          echo "CONFIG_BBG=y" >> common/arch/arm64/configs/gki_defconfig
          sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/selinux/selinux,baseband_guard/ } }' common/security/Kconfig
          echo "âœ… BBG LSM added"
          echo "::endgroup::"

      - name: Apply Other Patches
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Apply Other patches"
          cd "$CONFIG/kernel_platform/common"
          KERNEL_VERSION="${{ env.KERNEL_VER }}"
          MIN_VERSION="5.16"
          if [ "$(printf '%s\n' "$KERNEL_VERSION" "$MIN_VERSION" | sort -V | head -n1)" = "$KERNEL_VERSION" ]; then
            echo "Patching ptrace!"
            patch -p1 -F 3 < "../../../kernel_patches/gki_ptrace.patch"
          else
            echo "Kernel >= $MIN_VERSION, skipping ptrace patch"
          fi

          if [ "$OP_HMBIRD" = true ]; then
            echo "Patching hmbird!"
            dos2unix "../../../kernel_patches/oneplus/hmbird/fengchi_${OP_MODEL}_${OP_OS_VERSION}.patch"
            patch -p1 -F 3 < "../../../kernel_patches/oneplus/hmbird/fengchi_${OP_MODEL}_${OP_OS_VERSION}.patch"
            dos2unix "../../../kernel_patches/oneplus/hmbird/overwriter.patch"
            patch -p1 -F 3 < "../../../kernel_patches/oneplus/hmbird/overwriter.patch"
            chmod +x ./drivers/of/overwriter/overwrite_configs/convert_configs.sh
            dos2unix "../../../kernel_patches/oneplus/hmbird/hmbird_config.patch"
            patch -p1 -F 3 < "../../../kernel_patches/oneplus/hmbird/hmbird_config.patch"
          else
            echo "Hmbird not enabled, skipping fengchi patch"
          fi

          patch -p1 --forward < "../../../kernel_patches/common/optimized_mem_operations.patch"
          patch -p1 --forward < "../../../kernel_patches/common/file_struct_8bytes_align.patch"
          patch -p1 --forward < "../../../kernel_patches/common/reduce_cache_pressure.patch"

          if [ "$(printf '%s\n' "$KERNEL_VERSION" "$MIN_VERSION" | sort -V | head -n1)" = "$KERNEL_VERSION" ]; then
            patch -p1 --forward < "../../../kernel_patches/common/clear_page_16bytes_align.patch"
            echo "Patching unicode!"
            patch -p1 --forward < "../../../kernel_patches/common/unicode_bypass_fix_6.1-.patch"
          else
            cat "../../../kernel_patches/common/clear_page_16bytes_align.patch" \
              | sed -e 's/SYM_FUNC_START_PI(clear_page)/SYM_FUNC_START_PI(__pi_clear_page)/' \
              | patch -p1 -F3 --forward
            echo "Patching unicode!"
            patch -p1 --forward < "../../../kernel_patches/common/unicode_bypass_fix_6.1+.patch"
          fi

          echo "âœ… Other patches applied"
          echo "::endgroup::"

      - name: Apply KSU Hooks
        shell: bash
        if: ${{ env.NEED_HOOKS == 'true' }}
        run: |
          set -euo pipefail
          echo "::group::Apply KSU hooks"
          cd "$CONFIG/kernel_platform/common"
          patch -p1 < ../../../kernel_patches/next/scope_min_manual_hooks_v1.4.patch
          echo "âœ… KSU hooks applied"
          echo "::endgroup::"

      - name: Add KSU / KSUN and SUSFS Configuration Settings
        shell: bash
        run: |
          set -euo pipefail
          echo "Add KSU / KSUN and SUSFS Configuration Settings"
          cd "$CONFIG/kernel_platform"
          cat >> common/arch/arm64/configs/gki_defconfig <<EOF
          CONFIG_KSU=y
          CONFIG_KSU_KPROBES_HOOK=n
          CONFIG_KSU_SUSFS=y
          CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_PATH=y
          CONFIG_KSU_SUSFS_SUS_MOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_KSTAT=y
          CONFIG_KSU_SUSFS_SUS_OVERLAYFS=n
          CONFIG_KSU_SUSFS_TRY_UMOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y
          CONFIG_KSU_SUSFS_SPOOF_UNAME=y
          CONFIG_KSU_SUSFS_ENABLE_LOG=y
          CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
          CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
          CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
          CONFIG_KSU_SUSFS_SUS_MAP=y
          CONFIG_KSU_SUSFS_SUS_SU=n
          CONFIG_TMPFS_XATTR=y
          CONFIG_TMPFS_POSIX_ACL=y
          EOF

      - name: Add BBR
        if: ${{ env.OP_BBR == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          echo "Add BBR"
          cd "$CONFIG/kernel_platform"
          cat >> common/arch/arm64/configs/gki_defconfig <<EOF
          CONFIG_TCP_CONG_ADVANCED=y
          CONFIG_TCP_CONG_BBR=y
          CONFIG_NET_SCH_FQ=y
          CONFIG_NET_SCH_FQ_CODEL=y
          EOF

      - name: Add TTL Target Support
        if: ${{ env.OP_TTL == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          echo "Add TTL Target Support"
          cd "$CONFIG/kernel_platform"
          cat >> common/arch/arm64/configs/gki_defconfig <<EOF
          CONFIG_IP_NF_TARGET_TTL=y
          CONFIG_IP6_NF_TARGET_HL=y
          CONFIG_IP6_NF_MATCH_HL=y
          EOF

      - name: Add IP SET Support
        if: ${{ env.OP_IP_SET == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          echo "Add IP SET Support"
          cd "$CONFIG/kernel_platform"
          cat >> common/arch/arm64/configs/gki_defconfig <<EOF
          CONFIG_IP_SET=y
          CONFIG_IP_SET_MAX=65534
          CONFIG_IP_SET_BITMAP_IP=y
          CONFIG_IP_SET_BITMAP_IPMAC=y
          CONFIG_IP_SET_BITMAP_PORT=y
          CONFIG_IP_SET_HASH_IP=y
          CONFIG_IP_SET_HASH_IPMARK=y
          CONFIG_IP_SET_HASH_IPPORT=y
          CONFIG_IP_SET_HASH_IPPORTIP=y
          CONFIG_IP_SET_HASH_IPPORTNET=y
          CONFIG_IP_SET_HASH_IPMAC=y
          CONFIG_IP_SET_HASH_MAC=y
          CONFIG_IP_SET_HASH_NETPORTNET=y
          CONFIG_IP_SET_HASH_NET=y
          CONFIG_IP_SET_HASH_NETNET=y
          CONFIG_IP_SET_HASH_NETPORT=y
          CONFIG_IP_SET_HASH_NETIFACE=y
          CONFIG_IP_SET_LIST_SET=y
          EOF

      - name: Add Build based configs
        shell: bash
        run: |
          set -euo pipefail
          echo "Add Build based configs"
          cd "$CONFIG/kernel_platform"
          cat >> common/arch/arm64/configs/gki_defconfig <<EOF
          CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y
          CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE_O3=n
          CONFIG_OPTIMIZE_INLINING=y
          CONFIG_FRAME_WARN=0
          CONFIG_TRACEPOINTS=y
          EOF
      
      - name: Add Build based configs
        shell: bash
        run: |
         set -euo pipefail
         echo "Add Build based configs"
         cd "$CONFIG/kernel_platform"   
         CONFIG_DEBUG_KERNEL=n
         CONFIG_DEBUG_INFO=n
         CONFIG_GDB_SCRIPTS=n
         CONFIG_LOCK_DEBUGGING=n
         CONFIG_DEBUG_MUTEXES=n
         CONFIG_DEBUG_SPINLOCK=n
         CONFIG_DEBUG_ATOMIC_SLEEP=n
         CONFIG_SCHED_DEBUG=n
         CONFIG_SCHEDSTATS=n
         CONFIG_DEBUG_MISC=n
         CONFIG_DEBUG_BUGVERBOSE=n
         EOF

         echo "âœ… Kernel configured"
         echo "::endgroup::"

      - name: ðŸ”¨ Build Kernel
        env:
          PYTHONWARNINGS: "ignore:invalid escape sequence"
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Build kernel"
          cd "$GITHUB_WORKSPACE/OP15/kernel_platform/common"

          : > .scmversion

          export PYTHONWARNINGS="${PYTHONWARNINGS}"
          export LLVM=1 LLVM_IAS=1
          export ARCH=arm64 SUBARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export LD=ld.lld HOSTLD=ld.lld AR=llvm-ar NM=llvm-nm
          export OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump STRIP=llvm-strip

          KERNEL_PATH="${GITHUB_WORKSPACE}/OP15/kernel_platform"
          BASE_PATH="/usr/lib/ccache:${CLANG_BIN_PATH}:${KERNEL_PATH}/prebuilts/kernel-build-tools/linux-x86/bin/:${KERNEL_PATH}/prebuilts/kernel-build-tools/linux_musl-x86/bin/"

          if [ -n "${RUSTC_BIN_PATH:-}" ]; then
            export PATH="${BASE_PATH}:${RUSTC_BIN_PATH}:${PATH}"
            export RUSTC="${RUSTC_BIN_PATH}/rustc"
            export LIBCLANG_PATH="${CLANG_BIN_PATH}/../lib"
            export BINDGEN="bindgen"
          else
            export PATH="${BASE_PATH}:${PATH}"
          fi

          if [ "${{ inputs.clean_build }}" = "true" ]; then
            echo "ðŸ§¹ Clean build - ccache disabled"
            export CCACHE_DISABLE=1
          else
            echo "ðŸš€ ccache-accelerated build"
            export CC="ccache clang"
            export CXX="ccache clang++"
            export HOSTCC="ccache clang"
            export HOSTCXX="ccache clang++"
            export CCACHE_DIR="$HOME/.ccache"
            export CCACHE_BASEDIR="${GITHUB_WORKSPACE}"
            export CCACHE_COMPILERCHECK="content"
            export CCACHE_NOHASHDIR="true"
          fi

          WORKSPACE="${GITHUB_WORKSPACE}"
          MAP="-fdebug-prefix-map=${WORKSPACE}=."
          MPMAP="-fmacro-prefix-map=${WORKSPACE}=."
          FPMAP="-ffile-prefix-map=${WORKSPACE}=."

          if [ "${{ inputs.optimize_level }}" = "O3" ]; then OPT_FLAG="-O3"; else OPT_FLAG="-O2"; fi

          export KCFLAGS="${KCFLAGS:-} $MAP $MPMAP $FPMAP -no-canonical-prefixes -fdiagnostics-color=never -Qunused-arguments -Wno-unused-command-line-argument -D__ANDROID_COMMON_KERNEL__ -Wno-error -pipe -fno-stack-protector $OPT_FLAG"
          export KCPPFLAGS="${KCPPFLAGS:-} $MAP $MPMAP $FPMAP -DCONFIG_OPTIMIZE_INLINING"

          export SOURCE_DATE_EPOCH="$(git log -1 --format=%ct 2>/dev/null || date +%s)"
          export KBUILD_BUILD_TIMESTAMP="$(date -u)"
          export KBUILD_BUILD_USER="${BUILD_USER}"
          export KBUILD_BUILD_HOST="${BUILD_HOST}"
          export KBUILD_BUILD_VERSION=1

          echo "============================================"
          echo "ðŸ”§ Build Configuration"
          echo "============================================"
          echo "Device: ${OP_MODEL}"
          echo "Kernel: ${KERNEL_FULL_VER}"
          echo "Threads: $(nproc --all)"
          echo "Optimization: ${{ inputs.optimize_level }}"
          echo "ccache: ${{ inputs.clean_build && 'DISABLED' || 'ENABLED' }}"
          echo "============================================"

          OUT=out
          mkdir -p "$OUT"
          make O="$OUT" gki_defconfig

          LOCAL_LOCALVERSION="-${OP_ANDROID_VERSION}-${OP_UNAME}"
          scripts/config --file "$OUT/.config" --set-str LOCALVERSION "${LOCAL_LOCALVERSION}"
          scripts/config --file "$OUT/.config" -d LOCALVERSION_AUTO || true
          sed -i 's/scm_version="$(scm_version --short)"/scm_version=""/' scripts/setlocalversion

          if [ "${{ inputs.optimize_level }}" = "O3" ]; then
            scripts/config --file "$OUT/.config" -d CC_OPTIMIZE_FOR_PERFORMANCE
            scripts/config --file "$OUT/.config" -e CC_OPTIMIZE_FOR_PERFORMANCE_O3
          else
            scripts/config --file "$OUT/.config" -e CC_OPTIMIZE_FOR_PERFORMANCE
            scripts/config --file "$OUT/.config" -d CC_OPTIMIZE_FOR_PERFORMANCE_O3
          fi

          # LTO none
          scripts/config --file "$OUT/.config" -e LTO_CLANG
          scripts/config --file "$OUT/.config" -e LTO_CLANG_NONE
          scripts/config --file "$OUT/.config" -d LTO_CLANG_THIN
          scripts/config --file "$OUT/.config" -d LTO_CLANG_FULL

          make O="$OUT" olddefconfig

          echo ""
          echo "ðŸ”¨ Starting compilation..."
          BUILD_START=$(date +%s)

          set -o pipefail
          make -j"$(nproc --all)" O="$OUT" 2>&1 | tee build.log

          BUILD_END=$(date +%s)
          BUILD_TIME=$((BUILD_END - BUILD_START))

          echo "BUILD_TIME=$BUILD_TIME" >> "$GITHUB_ENV"

          IMG="$OUT/arch/arm64/boot/Image"
          if [ ! -f "$IMG" ]; then
            echo "::error::Build failed - Image not found"
            echo "::group::Last 100 lines of build log"
            tail -n 100 build.log
            echo "::endgroup::"
            exit 1
          fi

          IMG_SIZE=$(stat -c%s "$IMG")
          IMG_SHA=$(sha256sum "$IMG" | awk '{print $1}')

          echo "IMAGE_SHA256=$IMG_SHA" >> "$GITHUB_ENV"
          echo "KERNEL_UNAME=$(strings "$IMG" | grep -E 'Linux version.*#' | tail -n1)" >> "$GITHUB_ENV"
          echo "WARNINGS_COUNT=$(grep -ciE '\bwarning:' build.log || echo 0)" >> "$GITHUB_ENV"

          echo ""
          echo "============================================"
          echo "âœ… Build Complete"
          echo "============================================"
          echo "Duration: $((BUILD_TIME / 60))m $((BUILD_TIME % 60))s"
          echo "Image size: $(numfmt --to=iec-i --suffix=B "$IMG_SIZE")"
          echo "SHA256: $IMG_SHA"

          if [ "${{ inputs.clean_build }}" != "true" ]; then
            echo ""
            echo "ðŸ“Š ccache statistics:"
            ccache -s | head -n 20
          fi

          echo "============================================"
          echo "::endgroup::"

      - name: ðŸ“¦ Create Flashable ZIP
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Create flashable ZIP"

          IMAGE_PATH="$GITHUB_WORKSPACE/OP15/kernel_platform/common/out/arch/arm64/boot/Image"

          if [ ! -f "$IMAGE_PATH" ]; then
            echo "::error::Image not found at $IMAGE_PATH"
            exit 1
          fi

          cp "$IMAGE_PATH" "$GITHUB_WORKSPACE/AnyKernel3/Image"
          cd "$GITHUB_WORKSPACE/AnyKernel3"

          : "${KSUVER:=unknown}"
          : "${SUSVER:=nosusfs}"

          ZIP_NAME="AK3_${OP_MODEL}_${OP_OS_VERSION}_${KERNEL_FULL_VER}_${{ inputs.ksu_type }}_${KSUVER}_SuSFS_${SUSVER}.zip"

          echo "ðŸ“¦ Creating: $ZIP_NAME"
          zip -r9 "$ZIP_NAME" ./* -x "*.git*" -x "$ZIP_NAME" -x "README.md"

          mkdir -p "$GITHUB_WORKSPACE/artifacts"
          mv "$ZIP_NAME" "$GITHUB_WORKSPACE/artifacts/"

          ZIP_SIZE=$(stat -c%s "$GITHUB_WORKSPACE/artifacts/$ZIP_NAME")
          ZIP_SHA=$(sha256sum "$GITHUB_WORKSPACE/artifacts/$ZIP_NAME" | awk '{print $1}')

          echo "ZIP_NAME=$ZIP_NAME" >> "$GITHUB_ENV"
          echo "ZIP_SIZE=$ZIP_SIZE" >> "$GITHUB_ENV"
          echo "ZIP_SHA256=$ZIP_SHA" >> "$GITHUB_ENV"

          echo ""
          echo "âœ… ZIP created:"
          echo "   Name: $ZIP_NAME"
          echo "   Size: $(numfmt --to=iec-i --suffix=B "$ZIP_SIZE")"
          echo "   SHA256: $ZIP_SHA"

          echo "::endgroup::"

      - name: ðŸ“¤ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ inputs.ksu_type }}-OP15-${{ env.OP_OS_VERSION }}
          path: artifacts/
          retention-days: 7
          compression-level: 0

      - name: ðŸ“Š Build Summary
        shell: bash
        run: |
          set -euo pipefail

          if [ "${{ inputs.ksu_type }}" = "KSUN" ]; then
            KSU_REPO_URL="https://github.com/KernelSU-Next/KernelSU-Next"
          else
            KSU_REPO_URL="https://github.com/tiann/KernelSU"
          fi

          cat >> "$GITHUB_STEP_SUMMARY" <<EOF
          # ðŸŽ‰ OnePlus 15 Kernel Build Complete

          ## ðŸ“± Device Information
          | Property | Value |
          |----------|-------|
          | **Model** | ${OP_MODEL} (${OP_SOC}) |
          | **OS Version** | ${OP_OS_VERSION} |
          | **Kernel Version** | ${KERNEL_FULL_VER} |
          | **Kernel Uname** | \`${KERNEL_UNAME}\` |

          ## ðŸ”§ Build Configuration
          | Component | Version/Setting |
          |-----------|----------------|
          | **${{ inputs.ksu_type }}** | v${KSUVER} |
          | **SUSFS** | ${SUSVER} |
          | **SUSFS Branch** | ${SUSFS_BRANCH_NAME:-unknown} |
          | **Optimization** | ${{ inputs.optimize_level }} |
          | **LTO** | ${OP_LTO} |
          | **Clean Build** | ${{ inputs.clean_build && 'âœ… Yes' || 'âŒ No' }} |
          | **Build Time** | ${BUILD_TIME}s ($((BUILD_TIME / 60))m $((BUILD_TIME % 60))s) |
          | **Warnings** | ${WARNINGS_COUNT} |

          ## âœ¨ Enabled Features
          - âœ… **SUSFS ${SUSVER}**
          - âœ… **BBG LSM**
          - âœ… **BBR TCP**
          - âœ… **TTL Target**
          - âœ… **IP_SET**
          - âœ… **Rust Support**
          - âœ… **TMPFS_XATTR**
          - âœ… **TMPFS_POSIX_ACL**

          ## ðŸ“¦ Build Output
          | File | Details |
          |------|---------|
          | **ZIP Name** | \`${ZIP_NAME}\` |
          | **ZIP Size** | $(numfmt --to=iec-i --suffix=B "${ZIP_SIZE}") |
          | **ZIP SHA256** | \`${ZIP_SHA256}\` |
          | **Image SHA256** | \`${IMAGE_SHA256}\` |

          ## ðŸ”— Source Commits
          | Component | Commit |
          |-----------|--------|
          | **${{ inputs.ksu_type }}** | [\`${KSU_COMMIT_SHA:0:8}\`](${KSU_REPO_URL}/commit/${KSU_COMMIT_SHA}) |
          | **SUSFS** | [\`${SUSFS_COMMIT_SHA:0:8}\`](https://gitlab.com/simonpunk/susfs4ksu/-/commit/${SUSFS_COMMIT_SHA}) |

          ## ðŸ› ï¸ Toolchain
          | Tool | Version |
          |------|---------|
          | **Clang** | ${CLANG_VERSION} |
          | **Rust** | ${RUSTC_VERSION:-N/A} |
          | **Build User** | ${BUILD_USER} |
          | **Build Host** | ${BUILD_HOST} |

          ---
          EOF

      - name: ðŸ§¹ Cleanup
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Cleanup"

          sudo rm -rf "$GITHUB_WORKSPACE/OP15/kernel_platform/common/out" || true
          sudo rm -rf "$GITHUB_WORKSPACE/OP15/.repo" || true
          sudo rm -rf /tmp/* || true

          if [ "${{ inputs.clean_build }}" != "true" ] && command -v ccache >/dev/null 2>&1; then
            echo ""
            echo "ðŸ“Š Final ccache statistics:"
            ccache -s || true
            echo ""
            echo "ðŸ’¾ ccache preserved for next build"
          fi

          echo ""
          echo "ðŸ’½ Final disk usage:"
          df -h /

          echo "::endgroup::"
