name: Build 

on:
  workflow_dispatch:
    inputs:
      ksu_type:
        description: "Select KSU Type"
        required: true
        type: choice
        options: [KSUN, KSU]
        default: KSUN

      ksu_branch_or_hash:
        description: "KSU branch or commit hash (empty = default script behavior)"
        required: false
        type: string
        default: ""

      susfs_commit_hash_or_branch:
        description: "SUSFS branch or commit hash (empty = auto-detect by kernel version)"
        required: false
        type: string
        default: ""

      optimize_level:
        description: "Compiler optimization level"
        required: true
        type: choice
        options: [O2, O3]
        default: O2

      clean_build:
        description: "Clean build (no ccache)"
        required: true
        type: boolean
        default: false

permissions:
  contents: read
  actions: read

jobs:
  build-op15:
    name: Build OP15 (android16-6.12, OOS16)
    runs-on: ubuntu-latest

    env:
      # ---- Hardcoded OP15 device config ----
      OP_MODEL: "OP15"
      OP_SOC: "canoe"      
      OP_MANIFEST: "oneplus_15_w.xml"
      OP_ANDROID_VERSION: "android16"
      OP_KERNEL_VERSION: "6.12"
      OP_OS_VERSION: "OOS16"
      OP_LTO: "none"
      OP_RUST_BUILD: "true"
      OP_DISK_CLEANUP: "true"
      OP_HMBIRD: "false"
      OP_SUSFS: "true"
      OP_BBG: "true"
      OP_BBR: "true"
      OP_TTL: "true"
      OP_IP_SET: "true"
      OP_UNAME: "5-g188c695beb6d-ab14367805-4k"

    steps:
      - name: ðŸ“¥ Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ§¹ Emergency Disk Cleanup (OP15 config)
        if: ${{ env.OP_DISK_CLEANUP == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Disk Usage Before Cleanup"
          df -h
          echo "::endgroup::"

          echo "::group::Removing Unnecessary Software"
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /opt/hostedtoolcache/CodeQL || true
          sudo apt-get clean || true
          if command -v docker >/dev/null 2>&1; then
            docker rmi $(docker images -q) 2>/dev/null || true
          fi
          echo "::endgroup::"

          echo "::group::Disk Usage After Cleanup"
          df -h
          echo "::endgroup::"

      - name: Install Minimal Dependencies
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Install dependencies"
          sudo apt-get -o Acquire::Retries=3 update -qq
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            git curl ca-certificates build-essential clang lld flex bison \
            libelf-dev libssl-dev libncurses-dev zlib1g-dev liblz4-tool \
            libxml2-utils rsync unzip dwarves file python3 ccache jq bc dos2unix kmod libdw-dev elfutils
          sudo apt-get clean
          echo "âœ… Dependencies installed"
          echo "::endgroup::"

      - name: Validate Inputs (OP15)
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Validate inputs"

          optimize='${{ inputs.optimize_level }}'
          case "$optimize" in
            O2|O3) ;;
            *) echo "::error::optimize_level must be O2 or O3. Got: '$optimize'"; exit 1;;
          esac

          for b in OP_HMBIRD OP_SUSFS OP_BBG OP_BBR OP_TTL OP_IP_SET OP_RUST_BUILD; do
            v="${!b}"
            if [[ "$v" != "true" && "$v" != "false" ]]; then
              echo "::error::$b must be 'true' or 'false'. Got: '$v'"
              exit 1
            fi
          done

          if [[ ! "$OP_MODEL" =~ ^OP ]]; then
            echo "::error::OP_MODEL must start with OP. Got: '$OP_MODEL'"
            exit 1
          fi

          echo "âœ… Input validation passed"
          echo "::endgroup::"

      - name: Install bindgen only (no rustc)
        shell: bash
        if: ${{ env.OP_RUST_BUILD == 'true' }}
        run: |
          set -euo pipefail
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain none
          source "$HOME/.cargo/env"
          cargo install bindgen-cli --version 0.69.5
          bindgen --version
          which bindgen

      - name: Setup Base Environment
        shell: bash
        run: |
          set -euo pipefail
          echo "CONFIG=$OP_MODEL" >> "$GITHUB_ENV"

          REPO="/usr/local/bin/repo"
          if [ ! -x "$REPO" ]; then
            curl -s https://storage.googleapis.com/git-repo-downloads/repo -o "$REPO"
            chmod +x "$REPO"
          fi
          echo "REPO=$REPO" >> "$GITHUB_ENV"

      - name: Init flags
        shell: bash
        run: |
          set -euo pipefail
          echo "NEED_HOOKS=false" >> "$GITHUB_ENV"

      - name: Optimize Global Git for Repo Tool
        shell: bash
        run: |
          set -euo pipefail
          git config --global feature.manyFiles true
          git config --global core.fsmonitor true
          git config --global pack.sparse true

      - name: Extract Manifest Info (fixed manifest via GitHub API)
        id: extract_info
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          cd "$GITHUB_WORKSPACE"
          mkdir -p ".repo/manifests_fallback"
          XML_PATH=".repo/manifests_fallback/oneplus_15_w.xml"

          OWNER="Bouteillepleine"
          REPO="OnePlus_KernelSU_SUSFS"
          BRANCH="main"
          XML_FILE="manifests/oos16/oneplus_15_w.xml"

          echo "::group::Fetch manifest via GitHub API"
          api_xml="https://api.github.com/repos/${OWNER}/${REPO}/contents/${XML_FILE}?ref=${BRANCH}"
          echo "$api_xml"
          echo "::endgroup::"

          curl -fsSL "$api_xml" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            | jq -r '.content' | tr -d '\n' | base64 -d > "$XML_PATH"

          test -s "$XML_PATH" || { echo "::error::Downloaded manifest is empty: $XML_PATH"; exit 1; }

          REVISION="$(grep -oP '<project[^>]+revision="\K[^"]+' "$XML_PATH" | head -n1 || true)"
          CPU="$(echo "$REVISION" | sed -E 's#^(oneplus|realme|oppo)/([^_]+).*#\2#')"
          ANDROID_VERSION="$(echo "$REVISION" | grep -oP '\d{1,2}\.\d{1,2}(\.\d{1,2})?' || true)"

          [[ -n "$CPU" ]] && echo "CPU=$CPU" >> "$GITHUB_ENV"
          [[ -n "$ANDROID_VERSION" ]] && echo "ANDROID_VERSION=$ANDROID_VERSION" >> "$GITHUB_ENV"

          echo "value=oneplus_15_w_Android${ANDROID_VERSION:-Unknown}" >> "$GITHUB_OUTPUT"

      - name: Initialize Repo and Sync (Bouteillepleine manifest repo)
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Initialize kernel source "

          mkdir -p "$OP_MODEL"
          cd "$OP_MODEL"

          MANIFEST_GIT="https://github.com/Bouteillepleine/OnePlus_KernelSU_SUSFS.git"
          MANIFEST_BRANCH="main"
          MANIFEST_FILE="manifests/oos16/oneplus_15_w.xml"

          echo "repo init: $MANIFEST_GIT branch=$MANIFEST_BRANCH manifest=$MANIFEST_FILE"
          "$REPO" init -u "$MANIFEST_GIT" -b "$MANIFEST_BRANCH" -m "$MANIFEST_FILE" \
            --repo-rev=stable --depth=1 --no-clone-bundle --no-tags

          success=false
          for i in 1 2 3; do
            if "$REPO" sync -c -j"$(nproc --all)" --no-clone-bundle --no-tags --optimized-fetch --fail-fast; then
              success=true
              break
            fi
            echo "âš ï¸ repo sync attempt $i failed; retrying..."
            sleep 30
          done
          $success || { echo "::error::repo sync failed after 3 attempts"; exit 1; }

          echo "::endgroup::"

      - name: Get Kernel Version Info
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Get kernel version"

          CONFIG_DIR="$GITHUB_WORKSPACE/$OP_MODEL"
          ARTIFACTS_DIR="$CONFIG_DIR/artifacts"
          mkdir -p "$ARTIFACTS_DIR"
          cd "$CONFIG_DIR/kernel_platform/common"

          CONFIG_FILES=("build.config.common" "build.config.constants")
          BRANCH_LINE=""
          for f in "${CONFIG_FILES[@]}"; do
            if [ -f "$f" ]; then
              l=$(grep '^[[:space:]]*BRANCH=' "$f" || true)
              if [ -n "$l" ]; then BRANCH_LINE="$l"; break; fi
            fi
          done
          [ -n "$BRANCH_LINE" ] || { echo "::error::No BRANCH= found in config files"; exit 1; }

          BRANCH_VALUE="${BRANCH_LINE#*=}"
          ANDROID_VERSION="${BRANCH_VALUE%-*}"
          [ -n "$ANDROID_VERSION" ] || { echo "::error::Could not parse android version from BRANCH=$BRANCH_VALUE"; exit 1; }

          VERSION=$(grep '^VERSION *=' Makefile | awk '{print $3}')
          PATCHLEVEL=$(grep '^PATCHLEVEL *=' Makefile | awk '{print $3}')
          SUBLEVEL=$(grep '^SUBLEVEL *=' Makefile | awk '{print $3}')
          FULL_VERSION="$VERSION.$PATCHLEVEL.$SUBLEVEL"

          cd "$ARTIFACTS_DIR"
          echo "$ANDROID_VERSION-$FULL_VERSION" > "${OP_MODEL}_${OP_OS_VERSION}.txt"
          echo "$OP_OS_VERSION" >> "${OP_MODEL}_${OP_OS_VERSION}.txt"

          {
            echo "ANDROID_VER=$ANDROID_VERSION"
            echo "KERNEL_VER=$VERSION.$PATCHLEVEL"
            echo "TKERNEL_VER=$FULL_VERSION"
            echo "KERNEL_FULL_VER=$ANDROID_VERSION-$FULL_VERSION"
            if [ "$OP_SUSFS" = "true" ]; then
              echo "SUSFS_KERNEL_BRANCH=gki-$ANDROID_VERSION-$VERSION.$PATCHLEVEL"
            fi
          } >> "$GITHUB_ENV"

          echo "âœ… Detected: $ANDROID_VERSION-$FULL_VERSION"
          if [ "$OP_SUSFS" = "true" ]; then
            echo "   SUSFS Branch: gki-$ANDROID_VERSION-$VERSION.$PATCHLEVEL"
          fi

          echo "::endgroup::"

      - name: ðŸ·ï¸ Set Build Identity (Hardcoded)
        shell: bash
        run: |
          set -euo pipefail
          echo "BUILD_USER=OnePlus" >> "$GITHUB_ENV"
          echo "BUILD_HOST=ubuntu-build" >> "$GITHUB_ENV"

      - name: Detect Clang and Rust
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Detect toolchains"

          KP="$GITHUB_WORKSPACE/$OP_MODEL/kernel_platform"
          CLANG_FOUND=false
          RUSTC_FOUND=false

          for base in "$KP/prebuilts" "$KP/prebuilts-master"; do
            [ -d "$base/clang/host/linux-x86" ] || continue
            latest=$(ls -d "$base"/clang/host/linux-x86/clang-r*/ 2>/dev/null | sort -V | tail -n1 || true)
            if [ -n "$latest" ] && [ -x "$latest/bin/clang" ]; then
              CLANG_BIN="$latest/bin"
              CLANG_FOUND=true
              break
            fi
          done

          for base in "$KP/prebuilts" "$KP/prebuilts-master"; do
            [ -d "$base/rust/linux-x86/" ] || continue
            latest=$(ls -d "$base/rust/linux-x86/1."* 2>/dev/null | sort -V | head -n1 || true)
            if [ -n "$latest" ] && [ -x "$latest/bin/rustc" ]; then
              RUSTC_BIN="$latest/bin"
              RUSTC_FOUND=true
              break
            fi
          done

          if ! $CLANG_FOUND && command -v clang >/dev/null 2>&1; then
            CLANG_BIN="$(dirname "$(command -v clang)")"
            CLANG_FOUND=true
            echo "Using system clang."
          fi

          $CLANG_FOUND || { echo "::error::No clang toolchain found"; exit 1; }

          echo "CLANG_BIN_PATH=$CLANG_BIN" >> "$GITHUB_ENV"
          CLANG_VERSION="$("$CLANG_BIN/clang" --version | head -n1)"
          echo "CLANG_VERSION=$CLANG_VERSION" >> "$GITHUB_ENV"

          if [ "$RUSTC_FOUND" = true ]; then
            echo "RUSTC_BIN_PATH=$RUSTC_BIN" >> "$GITHUB_ENV"
            echo "RUSTC_VERSION=$("$RUSTC_BIN/rustc" --version | head -n1)" >> "$GITHUB_ENV"
          else
            echo "::warning::No RUST toolchain found in prebuilts (bindgen-only mode will still work)"
          fi

          echo "âœ… Clang: $CLANG_VERSION"
          echo "::endgroup::"

      - name: Derive Clang Short Version
        shell: bash
        run: |
          set -euo pipefail
          short="$("${CLANG_BIN_PATH}/clang" --version | sed -n '1s/.*clang-r\([0-9.]\+\).*/\1/p')"
          if [ -z "$short" ]; then
            short="$("${CLANG_BIN_PATH}/clang" --version | sha256sum | cut -c1-8)"
          fi
          echo "CLANG_VERSION_SHORT=$short" >> "$GITHUB_ENV"

      - name: Configure ccache env
        shell: bash
        run: |
          set -euo pipefail
          echo "CCACHE_DIR=$HOME/.ccache" >> "$GITHUB_ENV"
          echo "CCACHE_MAXSIZE=1G" >> "$GITHUB_ENV"
          mkdir -p "$HOME/.ccache"
          ccache -M 1G || true

      - name: Cache ccache
        if: ${{ inputs.clean_build != true }}
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-op15-${{ env.OP_OS_VERSION }}-${{ env.KERNEL_FULL_VER }}-${{ env.CLANG_VERSION_SHORT }}
          restore-keys: |
            ccache-op15-${{ env.OP_OS_VERSION }}-${{ env.KERNEL_FULL_VER }}-
            ccache-op15-${{ env.OP_OS_VERSION }}-

      - name: Handle Clean Build Option
        if: ${{ inputs.clean_build == true }}
        shell: bash
        run: |
          set -euo pipefail
          echo "CCACHE_DISABLE=1" >> "$GITHUB_ENV"
          echo "âš ï¸ Clean build enabled: ccache bypassed"

      - name: Clone AnyKernel3 + patch repos + SUSFS
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Clone dependencies"

          cd "$GITHUB_WORKSPACE"

          rm -rf AnyKernel3 kernel_patches susfs4ksu || true

          git clone --depth=1 https://github.com/Bouteillepleine/AnyKernel3.git -b gki-2.0
          git clone --depth=1 https://github.com/Bouteillepleine/kernel_patches.git

          if [ "$OP_SUSFS" = "true" ]; then
            git clone https://gitlab.com/simonpunk/susfs4ksu.git
            cd susfs4ksu

            # Ensure remote refs exist locally (branch detection relies on this)
            git fetch --all --tags -q

            key="${ANDROID_VER}-${KERNEL_VER}"

            input_ref="${{ inputs.susfs_commit_hash_or_branch }}"
            if [ -z "$input_ref" ] || [ "$input_ref" = "next" ]; then
              SUSFS_REF="gki-${key}"
            else
              SUSFS_REF="$input_ref"
            fi

            echo "SUSFS_REF=$SUSFS_REF"

            # Supports: branch name, tag, or commit hash
            git checkout -q "$SUSFS_REF" || {
              echo "::error::Cannot checkout SUSFS ref: $SUSFS_REF"
              echo "::group::Available remote branches (sample)"
              git branch -r | sed -n '1,120p'
              echo "::endgroup::"
              exit 1
            }

            echo "SUSFS_COMMIT_SHA=$(git rev-parse HEAD)" >> "$GITHUB_ENV"
            echo "SUSFS_BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo detached)" >> "$GITHUB_ENV"
            cd ..
          fi

          echo "::endgroup::"

      - name: Clean Up ABI Protected Exports
        shell: bash
        run: |
          set -euo pipefail
          cd "$OP_MODEL/kernel_platform"
          rm -f common/android/abi_gki_protected_exports_* || true
          rm -f msm-kernel/android/abi_gki_protected_exports_* || true
          sed -i 's/protected_modules = \[.*\]/protected_modules = []/' common/modules.bzl || true

      - name: Add KernelSU Next
        if: ${{ inputs.ksu_type == 'KSUN' }}
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Add KernelSU Next"
          cd "$OP_MODEL/kernel_platform"

          if [ "${{ inputs.ksu_branch_or_hash }}" = "" ]; then
            curl --fail --location --proto '=https' -LSs \
              "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh" | bash -
          else
            curl --fail --location --proto '=https' -LSs \
              "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh" | bash -s "${{ inputs.ksu_branch_or_hash }}"
          fi

          git submodule update --init --recursive

          cd KernelSU-Next/kernel
          COMMITS_COUNT=$(/usr/bin/git rev-list --count HEAD)

          if [ $COMMITS_COUNT -lt 2684 ]; then BASE_VERSION=10200; else BASE_VERSION=30000; fi
          KSU_VERSION=$(expr $COMMITS_COUNT "+" $BASE_VERSION)

          sed -i "s/DKSU_VERSION=11998/DKSU_VERSION=${KSU_VERSION}/" Makefile

          if [ "$KSU_VERSION" -lt 12884 ]; then
            echo "NEED_HOOKS=true" >> $GITHUB_ENV
          else
            echo "NEED_HOOKS=false" >> $GITHUB_ENV
          fi

          cd ..
          echo "KSU_COMMIT_SHA=$(git rev-parse HEAD)" >> $GITHUB_ENV
          echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
          echo "::endgroup::"

      - name: Add KernelSU
        if: ${{ inputs.ksu_type == 'KSU' }}
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Add KernelSU"
          cd "$OP_MODEL/kernel_platform"

          if [ "${{ inputs.ksu_branch_or_hash }}" = "" ]; then
            curl --fail --location --proto '=https' -LSs \
              "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -
          else
            curl --fail --location --proto '=https' -LSs \
              "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s "${{ inputs.ksu_branch_or_hash }}"
          fi

          git submodule update --init --recursive

          cd KernelSU/kernel
          BASE_VERSION=20000
          KSU_VERSION=$(expr $(/usr/bin/git rev-list --count HEAD) "+" $BASE_VERSION)
          sed -i "s/DKSU_VERSION=16/DKSU_VERSION=${KSU_VERSION}/" Makefile

          echo "NEED_HOOKS=false" >> $GITHUB_ENV

          cd ..
          echo "KSU_COMMIT_SHA=$(git rev-parse HEAD)" >> $GITHUB_ENV
          echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
          echo "::endgroup::"

      - name: Apply SUSFS Patches
        if: ${{ env.OP_SUSFS == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Apply SUSFS patches"

          cd "$OP_MODEL/kernel_platform"

          PATCH_FILE="../../susfs4ksu/kernel_patches/50_add_susfs_in_${SUSFS_KERNEL_BRANCH}.patch"
          if [ ! -f "$PATCH_FILE" ]; then
            echo "::error::Missing SUSFS patch file: $PATCH_FILE"
            echo "SUSFS_KERNEL_BRANCH=$SUSFS_KERNEL_BRANCH"
            echo "::group::Available patches (sample)"
            ls -1 ../../susfs4ksu/kernel_patches | sed -n '1,120p' || true
            echo "::endgroup::"
            exit 1
          fi

          cp "$PATCH_FILE" ./common/
          cp ../../susfs4ksu/kernel_patches/fs/* ./common/fs/
          cp ../../susfs4ksu/kernel_patches/include/linux/* ./common/include/linux/

          susfs_version="$(grep '#define SUSFS_VERSION' ./common/include/linux/susfs.h | awk -F'"' '{print $2}')"
          echo "SUSVER=$susfs_version" >> "$GITHUB_ENV"

          version_lte() { [ "$(printf '%s\n' "$2" "$1" | sort -V | head -n1)" = "$1" ]; }
          if version_lte "${susfs_version:1}" "1.5.12"; then
            echo "NEED_HOOKS=true" >> "$GITHUB_ENV"
          fi

          if [ "${{ inputs.ksu_type }}" = "KSUN" ]; then
            cd ./KernelSU-Next
          else
            cd ./KernelSU
          fi

          cp ../../../susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch ./
          patch -p1 --forward --fuzz=3 < 10_enable_susfs_for_ksu.patch || true

          cd ../common
          patch -p1 --forward < "$(basename "$PATCH_FILE")"

          echo "âœ… SUSFS patches applied ($susfs_version)"
          echo "::endgroup::"

      - name: Add BBG
        if: ${{ env.OP_BBG == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Add BBG LSM"
          cd "$OP_MODEL/kernel_platform"

          if ! wget -O- https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh | bash -s fix_blkdev_rename; then
            echo "::warning::BBG setup script failed, continuing anyway"
          fi

          echo "CONFIG_BBG=y" >> common/arch/arm64/configs/gki_defconfig
          sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/selinux/selinux,baseband_guard/ } }' common/security/Kconfig
          echo "::endgroup::"

      - name: Apply Other Patches
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Apply other patches"

          cd "$OP_MODEL/kernel_platform/common"

          KERNEL_VERSION="${KERNEL_VER}"
          MIN_PTRACE="5.16"

          version_ge() {
            # returns 0 if $1 >= $2
            [ "$(printf '%s\n' "$2" "$1" | sort -V | head -n1)" = "$2" ]
          }

          # ptrace patch: apply for kernels >= 5.16 (your intent, fixed)
          if version_ge "$KERNEL_VERSION" "$MIN_PTRACE"; then
            patch -p1 -F 3 --forward < "../../../kernel_patches/gki_ptrace.patch" || true
          fi

          patch -p1 --forward < "../../../kernel_patches/common/optimized_mem_operations.patch" || true
          patch -p1 --forward < "../../../kernel_patches/common/file_struct_8bytes_align.patch" || true
          patch -p1 --forward < "../../../kernel_patches/common/reduce_cache_pressure.patch" || true

          # 6.1 split patches: use "6.1+" when kernel >= 6.1 else "6.1-"
          if version_ge "$KERNEL_VERSION" "6.1"; then
            patch -p1 --forward < "../../../kernel_patches/common/clear_page_16bytes_align.patch" || true
            patch -p1 --forward < "../../../kernel_patches/common/unicode_bypass_fix_6.1+.patch" || true
          else
            cat "../../../kernel_patches/common/clear_page_16bytes_align.patch" | \
              sed -e 's/SYM_FUNC_START_PI(clear_page)/SYM_FUNC_START_PI(__pi_clear_page)/' | \
              patch -p1 -F3 --forward || true
            patch -p1 --forward < "../../../kernel_patches/common/unicode_bypass_fix_6.1-.patch" || true
          fi

          echo "::endgroup::"

      - name: Apply KSU Hooks (if needed)
        if: ${{ env.NEED_HOOKS == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          cd "$OP_MODEL/kernel_platform/common"
          patch -p1 < ../../../kernel_patches/next/scope_min_manual_hooks_v1.4.patch

      - name: Add KSU/SUSFS + features to gki_defconfig
        shell: bash
        run: |
          set -euo pipefail
          cd "$OP_MODEL/kernel_platform"

          cat >> common/arch/arm64/configs/gki_defconfig <<'EOF'
          CONFIG_KSU=y
          CONFIG_KSU_KPROBES_HOOK=n
          CONFIG_KSU_SUSFS=y
          CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_PATH=y
          CONFIG_KSU_SUSFS_SUS_MOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_KSTAT=y
          CONFIG_KSU_SUSFS_SUS_OVERLAYFS=n
          CONFIG_KSU_SUSFS_TRY_UMOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y
          CONFIG_KSU_SUSFS_SPOOF_UNAME=y
          CONFIG_KSU_SUSFS_ENABLE_LOG=y
          CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
          CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
          CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
          CONFIG_KSU_SUSFS_SUS_MAP=y
          CONFIG_KSU_SUSFS_SUS_SU=n
          CONFIG_TMPFS_XATTR=y
          CONFIG_TMPFS_POSIX_ACL=y
          EOF

          if [ "$OP_BBR" = "true" ]; then
            cat >> common/arch/arm64/configs/gki_defconfig <<'EOF'
          CONFIG_TCP_CONG_ADVANCED=y
          CONFIG_TCP_CONG_BBR=y
          CONFIG_NET_SCH_FQ=y
          CONFIG_NET_SCH_FQ_CODEL=y
          EOF
          fi

          if [ "$OP_TTL" = "true" ]; then
            cat >> common/arch/arm64/configs/gki_defconfig <<'EOF'
          CONFIG_IP_NF_TARGET_TTL=y
          CONFIG_IP6_NF_TARGET_HL=y
          CONFIG_IP6_NF_MATCH_HL=y
          EOF
          fi

          if [ "$OP_IP_SET" = "true" ]; then
            cat >> common/arch/arm64/configs/gki_defconfig <<'EOF'
          CONFIG_IP_SET=y
          CONFIG_IP_SET_MAX=65534
          CONFIG_IP_SET_BITMAP_IP=y
          CONFIG_IP_SET_BITMAP_IPMAC=y
          CONFIG_IP_SET_BITMAP_PORT=y
          CONFIG_IP_SET_HASH_IP=y
          CONFIG_IP_SET_HASH_IPMARK=y
          CONFIG_IP_SET_HASH_IPPORT=y
          CONFIG_IP_SET_HASH_IPPORTIP=y
          CONFIG_IP_SET_HASH_IPPORTNET=y
          CONFIG_IP_SET_HASH_IPMAC=y
          CONFIG_IP_SET_HASH_MAC=y
          CONFIG_IP_SET_HASH_NETPORTNET=y
          CONFIG_IP_SET_HASH_NET=y
          CONFIG_IP_SET_HASH_NETNET=y
          CONFIG_IP_SET_HASH_NETPORT=y
          CONFIG_IP_SET_HASH_NETIFACE=y
          CONFIG_IP_SET_LIST_SET=y
          EOF
          fi

          cat >> common/arch/arm64/configs/gki_defconfig <<'EOF'
          CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y
          CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE_O3=n
          CONFIG_OPTIMIZE_INLINING=y
          CONFIG_FRAME_WARN=0
          CONFIG_TRACEPOINTS=y

          CONFIG_DEBUG_KERNEL=n
          CONFIG_DEBUG_INFO=n
          CONFIG_GDB_SCRIPTS=n
          CONFIG_LOCK_DEBUGGING=n
          CONFIG_DEBUG_MUTEXES=n
          CONFIG_DEBUG_SPINLOCK=n
          CONFIG_DEBUG_ATOMIC_SLEEP=n
          CONFIG_SCHED_DEBUG=n
          CONFIG_SCHEDSTATS=n
          CONFIG_DEBUG_MISC=n
          CONFIG_DEBUG_BUGVERBOSE=n
          EOF

          if [ "$OP_RUST_BUILD" = "true" ]; then
            cat >> common/arch/arm64/configs/gki_defconfig <<'EOF'
          CONFIG_ANDROID_BINDER_IPC_RUST=m
          CONFIG_RUST=y
          EOF
          fi

      - name: Customize Kernel Branding
        shell: bash
        run: |
          set -euo pipefail
          CUSTOM_LOCALVERSION="-${ANDROID_VER}-${OP_UNAME}"
          echo "CUSTOM_LOCALVERSION=$CUSTOM_LOCALVERSION" >> "$GITHUB_ENV"

      - name: Build Kernel
        shell: bash
        env:
          PYTHONWARNINGS: "ignore:invalid escape sequence"
        run: |
          set -euo pipefail
          echo "::group::Build kernel"

          KERNEL_PATH="$GITHUB_WORKSPACE/$OP_MODEL/kernel_platform"
          COMMON="$KERNEL_PATH/common"
          cd "$COMMON"
          : > "$COMMON/.scmversion"

          COMMIT_TIMESTAMP=$(git log -1 --format=%ct 2>/dev/null || echo "$(date +%s)")
          COMMIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")

          WORKSPACE="${GITHUB_WORKSPACE}"
          MAP="-fdebug-prefix-map=${WORKSPACE}=."
          MPMAP="-fmacro-prefix-map=${WORKSPACE}=."
          FPMAP="-ffile-prefix-map=${WORKSPACE}=."

          export KCFLAGS="${KCFLAGS:-} $MAP $MPMAP $FPMAP -no-canonical-prefixes -fdiagnostics-color=never -Qunused-arguments -Wno-unused-command-line-argument -D__ANDROID_COMMON_KERNEL__"
          export KCPPFLAGS="${KCPPFLAGS:-} $MAP $MPMAP $FPMAP"

          export LLVM=1 LLVM_IAS=1
          export ARCH=arm64 SUBARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export PAHOLE="$KERNEL_PATH/prebuilts/kernel-build-tools/linux-x86/bin/pahole"
          export LD=ld.lld HOSTLD=ld.lld AR=llvm-ar NM=llvm-nm
          export OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump STRIP=llvm-strip

          set +u
          source "$KERNEL_PATH/build/kernel/_setup_env.sh" 2>/dev/null || true
          set -u

          export SOURCE_DATE_EPOCH=$COMMIT_TIMESTAMP
          export KBUILD_BUILD_TIMESTAMP="$(date -u)"
          export KBUILD_BUILD_USER="${BUILD_USER:-kernel}"
          export KBUILD_BUILD_HOST="${BUILD_HOST:-kleaf}"
          export KBUILD_BUILD_VERSION=1

          export CC="ccache clang"
          export CXX="ccache clang++"
          export HOSTCC="ccache clang"
          export HOSTCXX="ccache clang++"

          BASE_PATH="/usr/lib/ccache:${CLANG_BIN_PATH}:${KERNEL_PATH}/prebuilts/kernel-build-tools/linux-x86/bin/:${KERNEL_PATH}/prebuilts/kernel-build-tools/linux_musl-x86/bin/"
          if [ -n "${RUSTC_BIN_PATH:-}" ]; then
            export PATH="${BASE_PATH}:${RUSTC_BIN_PATH}:${PATH}"
            export RUSTC="$RUSTC_BIN_PATH/rustc"
            if [ "$OP_RUST_BUILD" = "true" ]; then
              export LIBCLANG_PATH="$CLANG_BIN_PATH/../lib"
              export BINDGEN="bindgen"
            fi
          else
            export PATH="${BASE_PATH}:${PATH}"
          fi

          if [ "${{ inputs.clean_build }}" = "true" ]; then
            export CCACHE_DISABLE=1
          fi

          OUT=out
          mkdir -p "$OUT"

          make O="$OUT" gki_defconfig

          LOCAL_LOCALVERSION="${CUSTOM_LOCALVERSION:--OP15}"
          scripts/config --file "$OUT/.config" --set-str LOCALVERSION "${LOCAL_LOCALVERSION}" || true
          scripts/config --file "$OUT/.config" -d LOCALVERSION_AUTO || true
          sed -i 's/scm_version="$(scm_version --short)"/scm_version=""/' scripts/setlocalversion || true

          if [ "${{ inputs.optimize_level }}" = "O3" ]; then
            scripts/config --file "$OUT/.config" -d CC_OPTIMIZE_FOR_PERFORMANCE
            scripts/config --file "$OUT/.config" -e CC_OPTIMIZE_FOR_PERFORMANCE_O3
            KCFLAGS_EXTRA="-O3"
          else
            scripts/config --file "$OUT/.config" -e CC_OPTIMIZE_FOR_PERFORMANCE
            scripts/config --file "$OUT/.config" -d CC_OPTIMIZE_FOR_PERFORMANCE_O3
            KCFLAGS_EXTRA="-O2"
          fi

          case "$OP_LTO" in
            "none")
              scripts/config --file "$OUT/.config" -e LTO_CLANG
              scripts/config --file "$OUT/.config" -e LTO_CLANG_NONE
              scripts/config --file "$OUT/.config" -d LTO_CLANG_THIN
              scripts/config --file "$OUT/.config" -d LTO_CLANG_FULL
              ;;
            "thin")
              scripts/config --file "$OUT/.config" -e LTO_CLANG
              scripts/config --file "$OUT/.config" -e LTO_CLANG_THIN
              scripts/config --file "$OUT/.config" -d LTO_CLANG_NONE
              scripts/config --file "$OUT/.config" -d LTO_CLANG_FULL
              ;;
            "full")
              scripts/config --file "$OUT/.config" -e LTO_CLANG
              scripts/config --file "$OUT/.config" -e LTO_CLANG_FULL
              scripts/config --file "$OUT/.config" -d LTO_CLANG_NONE
              scripts/config --file "$OUT/.config" -d LTO_CLANG_THIN
              ;;
            *)
              echo "::error::Unsupported LTO option: $OP_LTO"
              exit 1
              ;;
          esac

          make O="$OUT" olddefconfig

          export KCFLAGS="$KCFLAGS -Wno-error -pipe -fno-stack-protector ${KCFLAGS_EXTRA}"
          export KCPPFLAGS="$KCPPFLAGS -DCONFIG_OPTIMIZE_INLINING"

          BUILD_START=$(date +%s)
          set -o pipefail
          make -j"$(nproc --all)" O="$OUT" KCFLAGS="$KCFLAGS" KCPPFLAGS="$KCPPFLAGS" 2>&1 | tee build.log
          BUILD_END=$(date +%s)
          echo "BUILD_TIME=$((BUILD_END - BUILD_START))" >> "$GITHUB_ENV"

          IMG="$OUT/arch/arm64/boot/Image"
          [ -f "$IMG" ] || { echo "::error::Kernel Image missing"; tail -n 100 build.log || true; exit 1; }

          echo "âœ… Build OK (commit $COMMIT_HASH)"
          echo "::endgroup::"

      - name: Collect Build Stats / Validate Image
        id: stats
        shell: bash
        run: |
          set -euo pipefail
          CONFIG_DIR="$GITHUB_WORKSPACE/$OP_MODEL"
          IMG="$CONFIG_DIR/kernel_platform/common/out/arch/arm64/boot/Image"

          WARNINGS_COUNT="$(grep -ciE '\bwarning:' "$CONFIG_DIR/kernel_platform/common/build.log" || true)"
          [ -n "$WARNINGS_COUNT" ] || WARNINGS_COUNT="0"

          [ -f "$IMG" ] || { echo "::error::Kernel Image not found at $IMG"; exit 1; }
          file "$IMG" | grep -qi 'ARM64' || { echo "::error::Image is not ARM64"; file "$IMG"; exit 1; }

          IMG_SHA256=$(sha256sum "$IMG" | awk '{print $1}')
          echo "warnings=$WARNINGS_COUNT" >> "$GITHUB_OUTPUT"
          echo "image_sha256=$IMG_SHA256" >> "$GITHUB_OUTPUT"
          echo "build_time=${BUILD_TIME:-0}" >> "$GITHUB_OUTPUT"

      - name: Create Kernel ZIP (AnyKernel3)
        id: zip
        shell: bash
        run: |
          set -euo pipefail
          CONFIG_DIR="$GITHUB_WORKSPACE/$OP_MODEL"
          ARTIFACTS_DIR="$CONFIG_DIR/artifacts"
          mkdir -p "$ARTIFACTS_DIR"

          IMAGE_PATH="$CONFIG_DIR/kernel_platform/common/out/arch/arm64/boot/Image"
          cp "$IMAGE_PATH" "$GITHUB_WORKSPACE/AnyKernel3/Image"

          cd "$GITHUB_WORKSPACE/AnyKernel3"

          if [ "$OP_SUSFS" = "true" ]; then
            ZIP_NAME="AK3_${OP_MODEL}_${OP_OS_VERSION}_${KERNEL_FULL_VER}_${{ inputs.ksu_type }}_${KSUVER:-unknown}_SuSFS_${SUSVER:-unknown}.zip"
          else
            ZIP_NAME="AK3_${OP_MODEL}_${OP_OS_VERSION}_${KERNEL_FULL_VER}_${{ inputs.ksu_type }}_${KSUVER:-unknown}.zip"
          fi

          zip -r9 "$ZIP_NAME" ./* \
            -x "*.git*" \
            -x "$ZIP_NAME" \
            -x "README.md"

          mv "$ZIP_NAME" "$ARTIFACTS_DIR/"
          echo "zip_name=$ZIP_NAME" >> "$GITHUB_OUTPUT"

      - name: Upload Artifacts (ZIP + metadata txt)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ inputs.ksu_type }}-OP15-${{ env.OP_OS_VERSION }}
          path: |
            OP15/artifacts/
          compression-level: 0
          retention-days: 20
