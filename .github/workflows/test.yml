name: Build

permissions:
  contents: write
  actions: read

on:
  workflow_dispatch:
    inputs:
      ksu_meta:
        description: 'SukiSU: branch(required)/custom_tag(optional)/commit_hash(optional)'
        required: true
        type: string
        default: "builtin/âš¡Ultraâš¡/"

      susfs_branch:
        description: 'SUSFS branch/commit (empty = auto: gki-android16-6.12)'
        type: string
        default: ""

      optimize_level:
        description: 'Optimization level'
        type: choice
        options: [O2, O3]
        default: O2

      clean_build:
        description: 'Clean build (no ccache)'
        type: boolean
        default: false

jobs:
  build-op15:
    runs-on: ubuntu-latest
    env:
      # Device Configuration
      OP_MODEL: "OP15"
      OP_SOC: "canoe"
      OP_BRANCH: "wild/sm8850"
      OP_MANIFEST: "oneplus_15_w.xml"
      OP_ANDROID_VERSION: "android16"
      OP_KERNEL_VERSION: "6.12"
      OP_OS_VERSION: "OOS16"
      OP_LTO: "none"      
      OP_HMBIRD: "false"
      OP_SUSFS: "true"
      OP_BBG: "false"
      OP_BBR: "true"
      OP_TTL: "true"
      OP_IP_SET: "true"
      OP_UNAME: "5-g188c695beb6d-ab14367805-4k"

      # Aliases used by your SUSFS logic
      ANDROID_VER: "android16"
      KERNEL_VER: "6.12"

    steps:
      - name: ðŸ§¹ Free Disk Space
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Disk cleanup"
          df -h
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL || true
          sudo apt-get clean || true
          if command -v docker >/dev/null 2>&1; then
            docker rmi $(docker images -q) 2>/dev/null || true
          fi
          df -h
          echo "::endgroup::"

      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ“¦ Install Dependencies
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Install dependencies"
          sudo apt-get update -qq
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            git curl ca-certificates build-essential clang lld flex bison \
            libelf-dev libssl-dev libncurses-dev zlib1g-dev liblz4-tool \
            libxml2-utils rsync unzip dwarves file python3 ccache jq bc dos2unix kmod libdw-dev elfutils
          sudo apt-get clean
          echo "âœ… Dependencies installed"
          echo "::endgroup::"      

      - name: ðŸ”§ Setup Environment
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Setup environment"

          REPO="/usr/local/bin/repo"
          if [ ! -x "$REPO" ]; then
            sudo curl -s https://storage.googleapis.com/git-repo-downloads/repo -o "$REPO"
            sudo chmod +x "$REPO"
          fi
          echo "REPO=$REPO" >> "$GITHUB_ENV"

          echo "CONFIG=$GITHUB_WORKSPACE/OP15" >> "$GITHUB_ENV"

          git config --global feature.manyFiles true
          git config --global core.fsmonitor true
          git config --global pack.sparse true

          echo "BUILD_USER=OnePlus" >> "$GITHUB_ENV"
          echo "BUILD_HOST=ubuntu-build" >> "$GITHUB_ENV"

          echo "âœ… Environment configured"
          echo "::endgroup::"

      - name: ðŸ“¥ Sync Kernel Source
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Sync kernel source"
          mkdir -p OP15
          cd OP15

          "$REPO" init \
            -u https://github.com/Bouteillepleine/OnePlus_KernelSU_SUSFS.git \
            -b main \
            -m "manifests/oos16/${OP_MANIFEST}" \
            --repo-rev=v2.16 \
            --depth=1 \
            --no-clone-bundle \
            --no-tags

          if [ ! -f .repo/manifest.xml ]; then
            echo "::error::Manifest file not found after repo init"
            ls -la .repo/ || true
            exit 1
          fi

          success=false
          for i in 1 2 3; do
            if "$REPO" sync -c --no-clone-bundle --no-tags --optimized-fetch \
              -j"$(nproc --all)" --fail-fast; then
              success=true
              break
            fi
            echo "âš ï¸ Sync attempt $i failed, retrying in 30 seconds..."
            sleep 30
          done

          if [ "$success" = false ]; then
            echo "::error::Failed to sync kernel source after 3 attempts"
            exit 1
          fi

          if [ ! -d kernel_platform ]; then
            echo "::error::kernel_platform directory not found after sync"
            ls -la .
            exit 1
          fi

          echo "âœ… Kernel source synced successfully"
          echo "::endgroup::"

      - name: ðŸ” Detect Kernel Version
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Detect kernel version"
          cd OP15/kernel_platform/common

          VERSION=$(awk '/^VERSION *=/ {print $3}' Makefile)
          PATCHLEVEL=$(awk '/^PATCHLEVEL *=/ {print $3}' Makefile)
          SUBLEVEL=$(awk '/^SUBLEVEL *=/ {print $3}' Makefile)
          FULL_VERSION="$VERSION.$PATCHLEVEL.$SUBLEVEL"

          echo "KERNEL_FULL_VER=$OP_ANDROID_VERSION-$FULL_VERSION" >> "$GITHUB_ENV"
          echo "TKERNEL_VER=$FULL_VERSION" >> "$GITHUB_ENV"
          echo "SUSFS_KERNEL_BRANCH=gki-$OP_ANDROID_VERSION-$VERSION.$PATCHLEVEL" >> "$GITHUB_ENV"

          echo "âœ… Detected: $OP_ANDROID_VERSION-$FULL_VERSION"
          echo "::endgroup::"

      - name: ðŸ” Detect Toolchain
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Detect toolchain"

          KP="$GITHUB_WORKSPACE/OP15/kernel_platform"

          CLANG_FOUND=false
          for base in "$KP/prebuilts" "$KP/prebuilts-master"; do
            [ -d "$base/clang/host/linux-x86" ] || continue
            latest=$(ls -d "$base"/clang/host/linux-x86/clang-r*/ 2>/dev/null | sort -V | tail -n1 || true)
            if [ -n "$latest" ] && [ -x "$latest/bin/clang" ]; then
              echo "CLANG_BIN_PATH=$latest/bin" >> "$GITHUB_ENV"
              CLANG_VER="$("$latest/bin/clang" --version | head -n1)"
              echo "CLANG_VERSION=$CLANG_VER" >> "$GITHUB_ENV"
              echo "âœ… Clang: $CLANG_VER"
              CLANG_FOUND=true
              break
            fi
          done
          if [ "$CLANG_FOUND" = false ]; then
            echo "::error::Clang toolchain not found"
            exit 1
          fi

          RUSTC_FOUND=false
          for base in "$KP/prebuilts" "$KP/prebuilts-master"; do
            [ -d "$base/rust/linux-x86/" ] || continue
            latest=$(ls -d "$base/rust/linux-x86/1."* 2>/dev/null | sort -V | tail -n1 || true)
            if [ -n "$latest" ] && [ -x "$latest/bin/rustc" ]; then
              echo "RUSTC_BIN_PATH=$latest/bin" >> "$GITHUB_ENV"
              RUSTC_VER="$("$latest/bin/rustc" --version)"
              echo "RUSTC_VERSION=$RUSTC_VER" >> "$GITHUB_ENV"
              echo "âœ… Rust: $RUSTC_VER"
              RUSTC_FOUND=true
              break
            fi
          done
          if [ "$RUSTC_FOUND" = false ]; then
            echo "âš ï¸ Rust toolchain not found"
          fi

          echo "::endgroup::"

      - name: â™»ï¸ Setup ccache
        if: ${{ inputs.clean_build != true }}
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-op15-v2-${{ env.KERNEL_FULL_VER }}-${{ hashFiles('OP15/kernel_platform/common/Makefile') }}
          restore-keys: |
            ccache-op15-v2-${{ env.KERNEL_FULL_VER }}-
            ccache-op15-v2-

      - name: ðŸ”§ Configure ccache
        if: ${{ inputs.clean_build != true }}
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Configure ccache"
          export CCACHE_DIR="$HOME/.ccache"
          mkdir -p "$CCACHE_DIR"
          ccache -M 1G
          ccache -o compression=true
          ccache -o compression_level=3
          ccache -o direct_mode=true
          ccache -o file_clone=true
          ccache -o inode_cache=true
          ccache -s
          echo "::endgroup::"

      - name: ðŸ“¦ Clone Dependencies
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Clone dependencies"
          cd "$GITHUB_WORKSPACE"

          git clone --depth=1 https://github.com/Bouteillepleine/AnyKernel3.git -b gki-2.0
          git clone --depth=1 https://github.com/ShirkNeko/SukiSU_patch.git
          git clone --depth=1 https://github.com/Numbersf/Action-Build.git

          if [ "${OP_SUSFS}" = "true" ]; then
            git clone https://gitlab.com/simonpunk/susfs4ksu.git
            cd susfs4ksu

            SUSFS_BRANCH_INPUT="${{ inputs.susfs_branch }}"
            if [ -z "$SUSFS_BRANCH_INPUT" ]; then
              SUSFS_BRANCH_INPUT="${SUSFS_KERNEL_BRANCH}"
            fi

            if git rev-parse --verify "origin/$SUSFS_BRANCH_INPUT" >/dev/null 2>&1; then
              git checkout "$SUSFS_BRANCH_INPUT"
            elif git rev-parse --verify "$SUSFS_BRANCH_INPUT" >/dev/null 2>&1; then
              git checkout "$SUSFS_BRANCH_INPUT"
            else
              echo "::error::SUSFS branch '$SUSFS_BRANCH_INPUT' not found"
              exit 1
            fi

            echo "SUSFS_COMMIT_SHA=$(git rev-parse HEAD)" >> "$GITHUB_ENV"
            echo "SUSFS_BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo detached)" >> "$GITHUB_ENV"
          fi

          echo "::endgroup::"

      - name: ðŸ§¹ Clean ABI Exports
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Clean ABI exports"
          cd "$CONFIG/kernel_platform"
          rm -f common/android/abi_gki_protected_exports_* || true
          rm -f msm-kernel/android/abi_gki_protected_exports_* || true
          sed -i 's/protected_modules = \[.*\]/protected_modules = []/' common/modules.bzl || true
          echo "::endgroup::"

      - name: Add SukiSU Ultra
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Add SukiSU Ultra"
          cd "$CONFIG/kernel_platform"

          META="${{ inputs.ksu_meta }}"
          if [[ "$(grep -o '/' <<< "$META" | wc -l)" -lt 2 ]]; then
            echo "::error::Invalid 'ksu_meta' format. Expected: branch/custom_tag/commit_hash"
            echo "Example: susfs-main/Ultra/abc12345"
            exit 1
          fi

          IFS='/' read -r BRANCH_NAME CUSTOM_TAG MANUAL_HASH <<< "$META"

          echo "Branch: $BRANCH_NAME"
          echo "Custom Tag: ${CUSTOM_TAG:-Not set}"
          echo "Manual Commit: ${MANUAL_HASH:-Not set}"

          echo "Downloading KernelSU setup script..."
          if ! curl -LSs --retry 3 --retry-delay 2 --connect-timeout 30 \
               "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s "$BRANCH_NAME"; then
            echo "::error::KernelSU setup script failed"
            exit 1
          fi

          if [ ! -d "./KernelSU" ]; then
            echo "::error::KernelSU directory was not created after setup"
            ls -la
            exit 1
          fi

          cd ./KernelSU

          echo "KSU_COMMIT_SHA=$(git rev-parse HEAD)" >> "$GITHUB_ENV"

          if [[ -n "$MANUAL_HASH" ]]; then
            echo "Checking out specified commit: $MANUAL_HASH"
            if ! git fetch origin "$BRANCH_NAME" --depth=50; then
              echo "::error::Failed to fetch branch '$BRANCH_NAME'"
              exit 1
            fi
            if ! git checkout "$MANUAL_HASH"; then
              echo "::error::Failed to checkout commit '$MANUAL_HASH'"
              exit 1
            fi
            SHORT_HASH="${MANUAL_HASH:0:8}"
            echo "KSU_COMMIT_SHA=$(git rev-parse HEAD)" >> "$GITHUB_ENV"
          fi

          echo "::group::Fix sulog.c missing linux/version.h"
          SULOG_PATH="./kernel/sulog.c"

          if [ -f "$SULOG_PATH" ]; then
            if ! grep -q '#include <linux/version.h>' "$SULOG_PATH"; then
              echo "Patching sulog.c to include linux/version.h..."
              sed -i '0,/^#include/s|^\(#include.*\)$|\1\n#include <linux/version.h>|' "$SULOG_PATH"

              if grep -q '#include <linux/version.h>' "$SULOG_PATH"; then
                echo "âœ… Successfully added linux/version.h to sulog.c"
              else
                echo "::error::Failed to add linux/version.h to sulog.c"
                exit 1
              fi
            else
              echo "âœ… linux/version.h already included in sulog.c"
            fi
          else
            echo "âš ï¸ Warning: sulog.c not found at $SULOG_PATH"
          fi
          echo "::endgroup::"

          echo "Determining KSU API version..."
          KSU_API_VERSION=$(curl -fsSL --retry 3 --connect-timeout 30 \
            "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/$BRANCH_NAME/kernel/Makefile" 2>/dev/null | \
            grep -m1 "KSU_VERSION_API :=" | awk -F'= ' '{print $2}' | tr -d '[:space:]' || true)

          if [[ -z "$KSU_API_VERSION" ]] && [ -f "kernel/Makefile" ]; then
            KSU_API_VERSION=$(grep -m1 "KSU_VERSION_API :=" kernel/Makefile | awk -F'= ' '{print $2}' | tr -d '[:space:]' || true)
          fi

          if [[ -z "$KSU_API_VERSION" || "$(printf '%s\n' "$KSU_API_VERSION" "4.1.0" | sort -V | head -n1)" != "4.1.0" ]]; then
            echo "Warning: Invalid or missing API version. Using default: 4.1.0"
            KSU_API_VERSION="4.1.0"
          fi

          echo "KSU API Version: $KSU_API_VERSION"
          echo "KSU_API_VERSION=$KSU_API_VERSION" >> "$GITHUB_ENV"

          GIT_HASH=$(git rev-parse --short HEAD)
          echo "GIT_HASH=$GIT_HASH"

          if [[ -n "$MANUAL_HASH" ]]; then
            USE_HASH="$SHORT_HASH"
          else
            USE_HASH="$GIT_HASH"
          fi

          if [[ -z "$CUSTOM_TAG" ]]; then
            VERSION_FULL="v$KSU_API_VERSION-$USE_HASH@$BRANCH_NAME"
          else
            VERSION_FULL="v$KSU_API_VERSION-$CUSTOM_TAG@$BRANCH_NAME[$USE_HASH]"
          fi

          echo "Injecting version info into kernel/Makefile..."
          sed -i '/define get_ksu_version_full/,/endef/d' kernel/Makefile
          sed -i '/KSU_VERSION_API :=/d' kernel/Makefile
          sed -i '/KSU_VERSION_FULL :=/d' kernel/Makefile

          VERSION_DEFINITIONS=$(cat <<EOF
            define get_ksu_version_full
            $VERSION_FULL
            endef

            KSU_VERSION_API := $KSU_API_VERSION
            KSU_VERSION_FULL := $VERSION_FULL
          EOF
          )

          awk -v def="$VERSION_DEFINITIONS" '
            /REPO_OWNER :=/ {print; print def; inserted=1; next}
            1
            END {if (!inserted) print def}
          ' kernel/Makefile > kernel/Makefile.tmp && mv kernel/Makefile.tmp kernel/Makefile

          KSU_VERSION=$(expr $(git rev-list --count main 2>/dev/null || echo 13000) + 37185)
          echo "KSUVER=$KSU_VERSION" >> "$GITHUB_ENV"

          echo "::group::Makefile Version Preview"
          echo "Full Version: $VERSION_FULL"
          echo "Manager Version: $KSU_VERSION"
          grep -A10 "REPO_OWNER" kernel/Makefile || true
          grep "KSU_VERSION_FULL" kernel/Makefile || true
          echo "::endgroup::"

          echo "âœ… SukiSU Ultra successfully added"
          echo "   Version: $VERSION_FULL"
          echo "   Manager: v$KSU_VERSION"
          echo "::endgroup::"

      - name: Apply SUSFS Patches
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Apply SUSFS patches"
      
          if [ "${OP_SUSFS}" != "true" ]; then
            echo "OP_SUSFS is not enabled; skipping SUSFS."
            echo "::endgroup::"
            exit 0
          fi
      
          if [ ! -d "$GITHUB_WORKSPACE/susfs4ksu" ]; then
            echo "::error::susfs4ksu directory not found (expected from Clone Dependencies step)"
            exit 1
          fi
      
          cd "$CONFIG/kernel_platform"
      
          SUSFS_PATCH="50_add_susfs_in_gki-${ANDROID_VER}-${KERNEL_VER}.patch"
          SRC_PATCH="$GITHUB_WORKSPACE/susfs4ksu/kernel_patches/$SUSFS_PATCH"
      
          if [ ! -f "$SRC_PATCH" ]; then
            echo "::error::SUSFS patch not found: $SUSFS_PATCH"
            echo "Available:"
            ls -la "$GITHUB_WORKSPACE/susfs4ksu/kernel_patches/" || true
            exit 1
          fi
      
          echo "Copying SUSFS patch + files into common/"
          cp "$SRC_PATCH" ./common/
          cp -r "$GITHUB_WORKSPACE/susfs4ksu/kernel_patches/fs/"* ./common/fs/ || true
          cp -r "$GITHUB_WORKSPACE/susfs4ksu/kernel_patches/include/linux/"* ./common/include/linux/ || true
      
          cd ./common
      
          # Record SUSFS version if available
          if [ -f "./include/linux/susfs.h" ]; then
            SUSFS_VERSION="$(grep '#define SUSFS_VERSION' ./include/linux/susfs.h | awk -F'"' '{print $2}' || true)"
            echo "SUSVER=${SUSFS_VERSION:-unknown}" >> "$GITHUB_ENV"
            echo "SUSFS_VERSION=${SUSFS_VERSION:-unknown}" >> "$GITHUB_ENV"
            echo "Detected SUSFS version: ${SUSFS_VERSION:-unknown}"
          fi
      
          GKI_V="${ANDROID_VER}-${KERNEL_VER}"
          SUBLEVEL="$(grep '^SUBLEVEL *=' Makefile | head -n1 | cut -d= -f2 | tr -d ' ')"
          echo "GKI_V=$GKI_V SUBLEVEL=$SUBLEVEL"               
      
          # Fake guard for task_mmu.c (android16-6.12)
          fake_patched=0
          if [ "$GKI_V" = "android16-6.12" ]; then
            if ! grep -qxF $'\tunsigned int nr_subpages = __PAGE_SIZE / PAGE_SIZE;' ./fs/proc/task_mmu.c; then
              echo "Applying temporary task_mmu.c guard (android16-6.12)"
              sed -i \
                -e '/int ret = 0, copied = 0;/a \\tunsigned int nr_subpages \= __PAGE_SIZE \/ PAGE_SIZE;' \
                -e '/int ret = 0, copied = 0;/a \\tpagemap_entry_t \*res = NULL;' \
                ./fs/proc/task_mmu.c
              fake_patched=1
            fi
          fi
      
          echo "Applying SUSFS patch (tolerant): $SUSFS_PATCH"
          patch -p1 -F 3 < "$SUSFS_PATCH" || true
      
          # Revert the temporary guard
          if [ "$fake_patched" = 1 ]; then
            echo "Reverting temporary task_mmu.c guard..."
            sed -i \
              -e '/unsigned int nr_subpages \= __PAGE_SIZE \/ PAGE_SIZE;/d' \
              -e '/pagemap_entry_t \*res = NULL;/d' \
              ./fs/proc/task_mmu.c || true
          fi
      
          echo "âœ… SUSFS step complete (tolerant). SUSFS version: ${SUSFS_VERSION:-unknown}"
          echo "::endgroup::"

      - name: Add BBG
        if: ${{ env.OP_BBG == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Add BBG LSM"
          cd "$CONFIG/kernel_platform"
          if ! wget -O- https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh | bash -s fix_blkdev_rename; then
            echo "::warning::BBG setup script failed, continuing anyway"
          fi
          grep -qxF "CONFIG_BBG=y" common/arch/arm64/configs/gki_defconfig || echo "CONFIG_BBG=y" >> common/arch/arm64/configs/gki_defconfig
          sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/selinux/selinux,baseband_guard/ } }' common/security/Kconfig
          echo "::endgroup::"

      - name: Add SukiSU + SUSFS config (gki_defconfig)
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Kernel config"
          cd "$CONFIG/kernel_platform"
          DEFCONFIG="common/arch/arm64/configs/gki_defconfig"

          add_cfg() { grep -qxF "$1" "$DEFCONFIG" || echo "$1" >> "$DEFCONFIG"; }

          add_cfg "CONFIG_KSU=y"
          add_cfg "CONFIG_KSU_KPROBES_HOOK=n"
          add_cfg "CONFIG_KSU_SUSFS=y"
          add_cfg "CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y"
          add_cfg "CONFIG_KSU_SUSFS_SUS_PATH=y"
          add_cfg "CONFIG_KSU_SUSFS_SUS_MOUNT=y"
          add_cfg "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y"
          add_cfg "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y"
          add_cfg "CONFIG_KSU_SUSFS_SUS_KSTAT=y"
          add_cfg "CONFIG_KSU_SUSFS_SUS_OVERLAYFS=n"
          add_cfg "CONFIG_KSU_SUSFS_TRY_UMOUNT=y"
          add_cfg "CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y"
          add_cfg "CONFIG_KSU_SUSFS_SPOOF_UNAME=y"
          add_cfg "CONFIG_KSU_SUSFS_ENABLE_LOG=y"
          add_cfg "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y"
          add_cfg "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y"
          add_cfg "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y"
          add_cfg "CONFIG_KSU_SUSFS_SUS_MAP=y"
          add_cfg "CONFIG_KSU_SUSFS_SUS_SU=n"
          add_cfg "CONFIG_TMPFS_XATTR=y"
          add_cfg "CONFIG_TMPFS_POSIX_ACL=y"

          if [ "${OP_BBR}" = "true" ]; then
            add_cfg "CONFIG_TCP_CONG_ADVANCED=y"
            add_cfg "CONFIG_TCP_CONG_BBR=y"
            add_cfg "CONFIG_NET_SCH_FQ=y"
            add_cfg "CONFIG_NET_SCH_FQ_CODEL=y"
          fi

          if [ "${OP_TTL}" = "true" ]; then
            add_cfg "CONFIG_IP_NF_TARGET_TTL=y"
            add_cfg "CONFIG_IP6_NF_TARGET_HL=y"
            add_cfg "CONFIG_IP6_NF_MATCH_HL=y"
          fi

          if [ "${OP_IP_SET}" = "true" ]; then
            add_cfg "CONFIG_IP_SET=y"
            add_cfg "CONFIG_IP_SET_MAX=65534"
            add_cfg "CONFIG_IP_SET_BITMAP_IP=y"
            add_cfg "CONFIG_IP_SET_BITMAP_IPMAC=y"
            add_cfg "CONFIG_IP_SET_BITMAP_PORT=y"
            add_cfg "CONFIG_IP_SET_HASH_IP=y"
            add_cfg "CONFIG_IP_SET_HASH_IPMARK=y"
            add_cfg "CONFIG_IP_SET_HASH_IPPORT=y"
            add_cfg "CONFIG_IP_SET_HASH_IPPORTIP=y"
            add_cfg "CONFIG_IP_SET_HASH_IPPORTNET=y"
            add_cfg "CONFIG_IP_SET_HASH_IPMAC=y"
            add_cfg "CONFIG_IP_SET_HASH_MAC=y"
            add_cfg "CONFIG_IP_SET_HASH_NETPORTNET=y"
            add_cfg "CONFIG_IP_SET_HASH_NET=y"
            add_cfg "CONFIG_IP_SET_HASH_NETNET=y"
            add_cfg "CONFIG_IP_SET_HASH_NETPORT=y"
            add_cfg "CONFIG_IP_SET_HASH_NETIFACE=y"
            add_cfg "CONFIG_IP_SET_LIST_SET=y"
          fi

          add_cfg "CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y"
          add_cfg "CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE_O3=n"
          add_cfg "CONFIG_OPTIMIZE_INLINING=y"
          add_cfg "CONFIG_FRAME_WARN=0"
          add_cfg "CONFIG_TRACEPOINTS=y"         

          add_cfg "CONFIG_DEBUG_KERNEL=n"
          add_cfg "CONFIG_DEBUG_INFO=n"
          add_cfg "CONFIG_GDB_SCRIPTS=n"
          add_cfg "CONFIG_LOCK_DEBUGGING=n"
          add_cfg "CONFIG_DEBUG_MUTEXES=n"
          add_cfg "CONFIG_DEBUG_SPINLOCK=n"
          add_cfg "CONFIG_DEBUG_ATOMIC_SLEEP=n"
          add_cfg "CONFIG_SCHED_DEBUG=n"
          add_cfg "CONFIG_SCHEDSTATS=n"
          add_cfg "CONFIG_DEBUG_MISC=n"
          add_cfg "CONFIG_DEBUG_BUGVERBOSE=n"

          echo "âœ… Kernel configured"
          echo "::endgroup::"

      - name: Fix 6.12
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Fix 6.12 bazel defconfig check"
          sed -i '0,/protected_module_names_list *= *":gki_aarch64_protected_module_names"/s//check_defconfig = "disabled"/' \
            "$GITHUB_WORKSPACE/OP15/kernel_platform/common/BUILD.bazel"
          echo "::endgroup::"

      - name: Build the Kernel
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Build kernel"
      
          cd "$CONFIG/kernel_platform"
          if [ "${{ inputs.clean_build }}" = "true" ]; then
            echo "Clean build: removing output directories..."
            rm -rf common/out out bazel-out bazel-bin bazel-testlogs 2>/dev/null || true
          fi
      
          # Optional: disable ccache in "clean_build" mode
          if [ "${{ inputs.clean_build }}" = "true" ]; then
            export CCACHE_DISABLE=1
            echo "Clean build requested: CCACHE_DISABLE=1"
          else
            export PATH="/usr/lib/ccache:${PATH}"
            export CC="ccache clang"
            export CXX="ccache clang++"
          fi
      
          # Resource monitor
          (stdbuf -oL bash -c '
            while true; do
              echo "=== $(date) ==="
              free -h
              echo "------"
              df -h
              echo "------"
              top -b -n 1 | head -n 15
              echo ""
              sleep 60
            done
          ') &
          MONITOR_PID=$!
          trap "kill $MONITOR_PID" EXIT
      
          BUILD_START=$(date +%s)
      
          ./tools/bazel build \
            --config=fast \
            --config=stamp \
            --lto=none \
            //common:kernel_aarch64_dist \
            --verbose_failures
      
          BUILD_END=$(date +%s)
          BUILD_TIME=$((BUILD_END - BUILD_START))
      
          echo "BUILD_START=$BUILD_START" >> "$GITHUB_ENV"
          echo "BUILD_END=$BUILD_END" >> "$GITHUB_ENV"
          echo "BUILD_TIME=$BUILD_TIME" >> "$GITHUB_ENV"
      
          echo "âœ… Build finished in ${BUILD_TIME}s"
          echo "::endgroup::"

      - name: Collect Build Stats
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Collect build stats"
      
          # Try a few common locations (bazel vs make layouts differ)
          CANDIDATES=(
            "$GITHUB_WORKSPACE/OP15/kernel_platform/common/out/arch/arm64/boot/Image"
            "$GITHUB_WORKSPACE/OP15/kernel_platform/out/android16-6.12/dist/Image"
            "$GITHUB_WORKSPACE/OP15/kernel_platform/bazel-bin/common/kernel_aarch64/Image"
            "$(find "$GITHUB_WORKSPACE/OP15/kernel_platform" -path '*/dist/Image' -type f 2>/dev/null | head -n1)"
            "$(find "$GITHUB_WORKSPACE/OP15/kernel_platform" -path '*/arch/arm64/boot/Image' -type f 2>/dev/null | head -n1)"
          )
      
          IMAGE_PATH=""
          for p in "${CANDIDATES[@]}"; do
            if [ -n "${p:-}" ] && [ -f "$p" ]; then
              IMAGE_PATH="$p"
              break
            fi
          done
      
          if [ -z "$IMAGE_PATH" ]; then
            echo "::error::Could not locate built Image"
            exit 1
          fi
      
          echo "IMAGE_PATH=$IMAGE_PATH" >> "$GITHUB_ENV"
          echo "Image located at: $IMAGE_PATH"
      
          IMAGE_SHA256="$(sha256sum "$IMAGE_PATH" | awk '{print $1}')"
          echo "IMAGE_SHA256=$IMAGE_SHA256" >> "$GITHUB_ENV"
      
          KERNEL_UNAME="$(strings "$IMAGE_PATH" | grep -E 'Linux version.*#' | tail -n1 || true)"
          echo "KERNEL_UNAME=$KERNEL_UNAME" >> "$GITHUB_ENV"
      
          # Warnings count (best-effort)
          WARNINGS_COUNT="0"
          LOG_CANDIDATES=(
            "$GITHUB_WORKSPACE/OP15/kernel_platform/common/build.log"
            "$GITHUB_WORKSPACE/OP15/kernel_platform/build.log"
          )
          for l in "${LOG_CANDIDATES[@]}"; do
            if [ -f "$l" ]; then
              WARNINGS_COUNT="$(grep -ciE '\bwarning:' "$l" || true)"
              break
            fi
          done
          echo "WARNINGS_COUNT=$WARNINGS_COUNT" >> "$GITHUB_ENV"
      
          echo "âœ… Image SHA256: $IMAGE_SHA256"
          echo "âœ… Warnings: $WARNINGS_COUNT"
          echo "::endgroup::"

      - name: ðŸ“¦ Create Flashable ZIP
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Create flashable ZIP"
      
          : "${IMAGE_PATH:?IMAGE_PATH not set (Collect Build Stats step missing)}"
      
          cp "$IMAGE_PATH" "$GITHUB_WORKSPACE/AnyKernel3/Image"
          cd "$GITHUB_WORKSPACE/AnyKernel3"
      
          : "${KSUVER:=unknown}"
          : "${SUSVER:=nosusfs}"
      
          ZIP_NAME="AK3_${OP_MODEL}_${OP_OS_VERSION}_${KERNEL_FULL_VER}_SukiSU_${KSUVER}_SuSFS_${SUSVER}.zip"
      
          zip -r9 "$ZIP_NAME" ./* -x "*.git*" -x "$ZIP_NAME" -x "README.md"
      
          mkdir -p "$GITHUB_WORKSPACE/artifacts"
          mv "$ZIP_NAME" "$GITHUB_WORKSPACE/artifacts/"
      
          echo "ZIP_NAME=$ZIP_NAME" >> "$GITHUB_ENV"
          echo "ZIP_SIZE=$(stat -c%s "$GITHUB_WORKSPACE/artifacts/$ZIP_NAME")" >> "$GITHUB_ENV"
          echo "ZIP_SHA256=$(sha256sum "$GITHUB_WORKSPACE/artifacts/$ZIP_NAME" | awk '{print $1}')" >> "$GITHUB_ENV"
      
          echo "::endgroup::"

      - name: ðŸ“¤ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: kernel-SukiSU-OP15-${{ env.OP_OS_VERSION }}
          path: artifacts/
          retention-days: 7
          compression-level: 0

      - name: ðŸ“Š Build Summary
        shell: bash
        run: |
          set -euo pipefail

          KSU_REPO_URL="https://github.com/SukiSU-Ultra/SukiSU-Ultra"

          cat >> "$GITHUB_STEP_SUMMARY" <<EOF
          # ðŸŽ‰ OnePlus 15 Kernel Build Complete (SukiSU)

          ## ðŸ“± Device Information
          | Property | Value |
          |----------|-------|
          | **Model** | ${OP_MODEL} (${OP_SOC}) |
          | **OS Version** | ${OP_OS_VERSION} |
          | **Kernel Version** | ${KERNEL_FULL_VER} |
          | **Kernel Uname** | \`${KERNEL_UNAME}\` |

          ## ðŸ”§ Build Configuration
          | Component | Version/Setting |
          |-----------|----------------|
          | **SukiSU** | v${KSUVER} |
          | **SUSFS** | ${SUSVER} |
          | **SUSFS Branch** | ${SUSFS_BRANCH_NAME:-unknown} |
          | **Optimization** | ${{ inputs.optimize_level }} |
          | **LTO** | ${OP_LTO} |
          | **Clean Build** | ${{ inputs.clean_build && 'âœ… Yes' || 'âŒ No' }} |
          | **Build Time** | ${BUILD_TIME}s |
          | **Warnings** | ${WARNINGS_COUNT} |

          ## ðŸ“¦ Build Output
          | File | Details |
          |------|---------|
          | **ZIP Name** | \`${ZIP_NAME}\` |
          | **ZIP SHA256** | \`${ZIP_SHA256}\` |
          | **Image SHA256** | \`${IMAGE_SHA256}\` |

          ## ðŸ”— Source Commits
          | Component | Commit |
          |-----------|--------|
          | **SukiSU** | [\`${KSU_COMMIT_SHA:0:8}\`](${KSU_REPO_URL}/commit/${KSU_COMMIT_SHA}) |
          | **SUSFS** | [\`${SUSFS_COMMIT_SHA:0:8}\`](https://gitlab.com/simonpunk/susfs4ksu/-/commit/${SUSFS_COMMIT_SHA}) |
          EOF

      - name: ðŸ§¹ Cleanup
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Cleanup"
          sudo rm -rf "$GITHUB_WORKSPACE/OP15/kernel_platform/common/out" || true
          sudo rm -rf "$GITHUB_WORKSPACE/OP15/.repo" || true
          sudo rm -rf /tmp/* || true
          df -h /
          echo "::endgroup::"
